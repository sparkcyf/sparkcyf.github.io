<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using EC20 Module, Asterisk, and FreePBX for SMS Forwarding and VoIP | Sparktour’s Blog</title><meta name=keywords content="tech,ec20,asterisk,freepbx,sip,volte"><meta name=description content="In many parts of the world, mobile phone numbers are increasingly intertwined with online services and personal identity. This is particularly true in mainland China, where a single user may find themselves managing multiple phone numbers for various applications and platforms. While solutions like telegram-sms and SMS-forwarder have emerged to address the inconvenience of managing multiple physical SIM cards, they come with limitations. These apps, typically installed on smartphones, are often hampered by aggressive background process management common on Android devices, leading to unreliable SMS forwarding. Furthermore, the practice of keeping older devices powered on long-term for this purpose introduces safety concerns, such as battery swelling. Perhaps the most significant limitation is the inability to handle phone calls; these apps only address SMS. This article details a project where the author, leveraging an EC20 cellular module and a blend of software tools, overcame these limitations. The setup allows for SMS messaging through instant messaging applications like Telegram, and makes and receives phone calls over the internet using SIP clients, providing a more robust and flexible solution."><meta name=author content="sparktour"><link rel=canonical href=https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.sparktour.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.sparktour.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.sparktour.me/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.sparktour.me/apple-touch-icon.png><link rel=mask-icon href=https://blog.sparktour.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/><link rel=alternate hreflang=en href=https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://blog.sparktour.me/scss/callout.css><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-6EJ4YX1XZ8"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6EJ4YX1XZ8")}</script><meta property="og:url" content="https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/"><meta property="og:site_name" content="Sparktour’s Blog"><meta property="og:title" content="Using EC20 Module, Asterisk, and FreePBX for SMS Forwarding and VoIP"><meta property="og:description" content="In many parts of the world, mobile phone numbers are increasingly intertwined with online services and personal identity. This is particularly true in mainland China, where a single user may find themselves managing multiple phone numbers for various applications and platforms. While solutions like telegram-sms and SMS-forwarder have emerged to address the inconvenience of managing multiple physical SIM cards, they come with limitations. These apps, typically installed on smartphones, are often hampered by aggressive background process management common on Android devices, leading to unreliable SMS forwarding. Furthermore, the practice of keeping older devices powered on long-term for this purpose introduces safety concerns, such as battery swelling. Perhaps the most significant limitation is the inability to handle phone calls; these apps only address SMS. This article details a project where the author, leveraging an EC20 cellular module and a blend of software tools, overcame these limitations. The setup allows for SMS messaging through instant messaging applications like Telegram, and makes and receives phone calls over the internet using SIP clients, providing a more robust and flexible solution."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-08T12:00:00+00:00"><meta property="article:modified_time" content="2025-01-29T22:58:05+08:00"><meta property="article:tag" content="Tech"><meta property="article:tag" content="Ec20"><meta property="article:tag" content="Asterisk"><meta property="article:tag" content="Freepbx"><meta property="article:tag" content="Sip"><meta property="article:tag" content="Volte"><meta property="og:image" content="https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/ec20-taobao.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/ec20-taobao.jpg"><meta name=twitter:title content="Using EC20 Module, Asterisk, and FreePBX for SMS Forwarding and VoIP"><meta name=twitter:description content="In many parts of the world, mobile phone numbers are increasingly intertwined with online services and personal identity. This is particularly true in mainland China, where a single user may find themselves managing multiple phone numbers for various applications and platforms. While solutions like telegram-sms and SMS-forwarder have emerged to address the inconvenience of managing multiple physical SIM cards, they come with limitations. These apps, typically installed on smartphones, are often hampered by aggressive background process management common on Android devices, leading to unreliable SMS forwarding. Furthermore, the practice of keeping older devices powered on long-term for this purpose introduces safety concerns, such as battery swelling. Perhaps the most significant limitation is the inability to handle phone calls; these apps only address SMS. This article details a project where the author, leveraging an EC20 cellular module and a blend of software tools, overcame these limitations. The setup allows for SMS messaging through instant messaging applications like Telegram, and makes and receives phone calls over the internet using SIP clients, providing a more robust and flexible solution."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Using EC20 Module, Asterisk, and FreePBX for SMS Forwarding and VoIP","item":"https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using EC20 Module, Asterisk, and FreePBX for SMS Forwarding and VoIP","name":"Using EC20 Module, Asterisk, and FreePBX for SMS Forwarding and VoIP","description":"In many parts of the world, mobile phone numbers are increasingly intertwined with online services and personal identity. This is particularly true in mainland China, where a single user may find themselves managing multiple phone numbers for various applications and platforms. While solutions like telegram-sms and SMS-forwarder have emerged to address the inconvenience of managing multiple physical SIM cards, they come with limitations. These apps, typically installed on smartphones, are often hampered by aggressive background process management common on Android devices, leading to unreliable SMS forwarding. Furthermore, the practice of keeping older devices powered on long-term for this purpose introduces safety concerns, such as battery swelling. Perhaps the most significant limitation is the inability to handle phone calls; these apps only address SMS. This article details a project where the author, leveraging an EC20 cellular module and a blend of software tools, overcame these limitations. The setup allows for SMS messaging through instant messaging applications like Telegram, and makes and receives phone calls over the internet using SIP clients, providing a more robust and flexible solution.","keywords":["tech","ec20","asterisk","freepbx","sip","volte"],"articleBody":"In many parts of the world, mobile phone numbers are increasingly intertwined with online services and personal identity. This is particularly true in mainland China, where a single user may find themselves managing multiple phone numbers for various applications and platforms. While solutions like telegram-sms and SMS-forwarder have emerged to address the inconvenience of managing multiple physical SIM cards, they come with limitations. These apps, typically installed on smartphones, are often hampered by aggressive background process management common on Android devices, leading to unreliable SMS forwarding. Furthermore, the practice of keeping older devices powered on long-term for this purpose introduces safety concerns, such as battery swelling. Perhaps the most significant limitation is the inability to handle phone calls; these apps only address SMS. This article details a project where the author, using an EC20 cellular module and a blend of software tools like asterisk, to overcame these limitations. The setup allows for SMS messaging through instant messaging applications like Telegram, and makes and receives phone calls over the internet using SIP clients, providing a more robust and flexible solution.\nOther Solutions the Author Investigated Multi-SIM Box (多卡宝) A popular SIM card hosting solution one or two years ago, it could hold four cards and have two cards on standby simultaneously, forwarding SMS and calls using its own app. According to FCCID’s PDF, it uses a Qualcomm Snapdragon 210 processor, commonly found in some 4G feature phones. Therefore, the author suspects the multi-SIM box used a modified Android system. However, in the second half of 2021, multi-SIM boxes were removed from domestic e-commerce platforms, likely due to regulatory reasons (possibly being used for telecom fraud?). Also, because SMS and voice data must go through a third-party server, there are some security concerns.\nGOIP Devices Commonly known as “cat pools,” these devices are too expensive for the author to afford.\nMaterials and Costs EC20 and Peripherals ec20-taobao A 4G card from Quectel that supports LTE Cat4 and uses the Snapdragon X5 LTE Modem. This card has several versions, some of which only support internet access and not calls or SMS. If you need to send/receive SMS and make calls, try to purchase the top-tier EC20CEFAG-512-SGNS, with a mini-pcie interface. It costs about 200 RMB from Quectel’s Taobao store, or about 50-60 RMB on Xianyu (a second-hand market).\nEach card also requires a mini PCIE to USB adapter card with a SIM slot, which costs about 25 RMB. Search for “4G module adapter board Mini PCIE to USB” on Taobao. The card slot usually takes a Mini SIM, if you only have a nano SIM, you may need to buy a SIM adapter.\nAdditionally, you’ll need to buy some IPEX to SMA adapter cables and SMA interface 4G antennas, which can be found by searching those keywords on Taobao.\nVM Host The requirements are not high; generally, you just need a USB port and a wired network port. It’s recommended to install a virtualization system like PVE or ESXi. (Raspberry Pi may not work due to insufficient power). The author bought a second-hand Optiplex 3050mff with an i3-6100T, 8GB of RAM, and a 256GB SSD for about 600 RMB.\nConfiguring the EC20 Verifying the EC20 Can Read the SIM Card Disable the SIM card’s PIN, insert it into the card slot, connect the EC20 to the antenna, and power it on. You should then see several ttyUSB ports in /dev:\nttyUSB0 ttyUSB1 PCM voice, GPS signal ttyUSB2 Control commands ttyUSB3 Use minicom to open the ttyUSB2 port:\nminicom -D /dev/ttyUSB2 # Enter ATI to check the EC20's version: ATI Quectel EC20F Revision: EC20CEFAGR06A15M4G If everything is normal, you can reset the EC20 first to prevent the previous user from having set incorrect configurations (but do not reset the EC20 too frequently, as the reset operation can wear out the dongle’s flash memory):\nReset module at+qprtpara=3 Restart AT+CFUN=1,1 After resetting and restarting, you can check if the SIM card has registered successfully using the following commands (the example below is for China Unicom; the same applies to other carriers):\nAT+COPS? +COPS: 0,0,\"CHN-UNICOM\",7 AT+QNWINFO +QNWINFO: \"FDD LTE\",\"46001\",\"LTE BAND 3\",1650 AT+QENG=\"servingcell\" +QENG: \"servingcell\",\"CONNECT\",\"LTE\",\"FDD\",460,01 Configuring VoLTE With major carriers gradually phasing out 2G and 3G, configuring VoLTE for the dongle is becoming increasingly necessary. The following procedure refers to this PDF:\nEnable IMS AT+QCFG=\"ims\",1 View mbn files in the dongle AT+QMBNCFG=\"List\" +QMBNCFG: \"List\",0,1,1,\"ROW_Generic_3GPP\",0x05010824,201806201 +QMBNCFG: \"List\",1,0,0,\"OpenMkt-Commercial-CU\",0x05011510,201911151 +QMBNCFG: \"List\",2,0,0,\"OpenMkt-Commercial-CT\",0x0501131C,201911141 +QMBNCFG: \"List\",3,0,0,\"Volte_OpenMkt-Commercial-CMCC\",0x05012011,201904261 # Although it lists VoLTE configuration files for China Mobile, China Unicom, and China Telecom, using the default automatic selection of CU/CT/CMCC cannot register VoLTE. After a long period of experimentation, the author found that forcing the selection of ROW_Generic_3GPP is necessary to register VoLTE successfully. Disable automatic mbn selection AT+QMBNCFG=\"AutoSel\",0 Deactivate current mbn at+qmbncfg=\"deactivate\" Force selection of 3gpp AT+QMBNCFG=\"select\",\"ROW_Generic_3GPP\" Restart AT+CFUN=1,1 You can check the mbn selection status again. If the second and third digits of ROW_Generic_3GPP are both 1, it indicates that the dongle has selected this configuration. AT+QMBNCFG=\"List\" +QMBNCFG: \"List\",0,1,1,\"ROW_Generic_3GPP\",0x05010824,201806201 +QMBNCFG: \"List\",1,0,0,\"OpenMkt-Commercial-CU\",0x05011510,201911151 +QMBNCFG: \"List\",2,0,0,\"OpenMkt-Commercial-CT\",0x0501131C,201911141 +QMBNCFG: \"List\",3,0,0,\"Volte_OpenMkt-Commercial-CMCC\",0x05012011,201904261 After restarting, check the IMS status AT+QCFG=\"ims\" If it returns +QCFG: \"ims\",1,1, it's enabled. If it returns +QCFG: \"ims\",1,0, it's not enabled. Optional (Activate UAC Digital Audio) Refer to https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/2:\nAT+QCFG=\"usbcfg\",0x2C7C,0x0125,1,1,1,1,1,0,1 This command will also open an adb daemon. You can use adb shell to enter the module’s built-in Android system. If the system has a password (whether or not it has a password does not affect subsequent configurations), you can use adb pull to pull the dongle’s /etc/passwd, remove the root password, and then push it back.\nAfter activation, you can check if there is an Android device by using aplay -L.\ndmix:CARD=Android,DEV=0 Android, USB Audio Direct sample mixing device Installing the Asterisk Virtual Machine FreePBX’s built-in Asterisk is tightly coupled with FreePBX configurations, making it difficult for the author to use. Also, CentOS doesn’t seem to be able to read the dongle’s UAC interface. Therefore, the author configured a simple Asterisk system based on a discussion by the Quectel channel driver author. The author uses Debian 11 here and installs the Asterisk 16 included in the package manager. After installing Asterisk, remember to pass through the dongle’s USB interface into the virtual machine.\nInstalling Asterisk and Some Dependencies apt update apt install asterisk asterisk-dev adb git autoconf automake libsqlite3-dev build-essential libasound2-dev alsa-utils Downloading asterisk-chan-quectel: git clone https://github.com/IchthysMaranatha/asterisk-chan-quectel cd asterisk-chan-quectel ./bootstrap ./configure --with-astversion=16 make make install Then, copy uac/quectel.conf to /etc/asterisk. Restart Asterisk using systemctl restart asterisk.\nEnter Asterisk’s CLI interface using asterisk -rvvv and enter quectel show devices. You should see the identified dongle, including its IMEI and the SIM card’s IMSI:\n# asterisk -rvvv Asterisk 16.16.1~dfsg-1+deb11u1, Copyright (C) 1999 - 2018, Digium, Inc. and others. Created by Mark Spencer Asterisk comes with ABSOLUTELY NO WARRANTY; type 'core show warranty' for details. This is free software, with components licensed under the GNU General Public License version 2 and other licenses; you are welcome to redistribute it under certain conditions. Type 'core show license' for details. ========================================================================= Connected to Asterisk 16.16.1~dfsg-1+deb11u1 currently running on debian-asterisk (pid = 1403) debian-asterisk*CLI\u003e quectel show devices ID Group State RSSI Mode Submode Provider Name Model Firmware IMEI IMSI Number quectel0 0 Free 27 0 0 CHN-UNICOM EC20F EC20CEFAGR06A15M4 86XXXXX 46XXXXX Unknown debian-asterisk*CLI\u003e Configuring the Dialplan Directly refer to the post written by the driver author and download the sipext.zip from that post. Extract it and place the files in /etc/asterisk. At the same time, modify /etc/asterisk/extensions.conf (please do not copy directly! Modify according to your situation and the driver author’s post):\n[incoming-mobile] ;exten =\u003e _.,1,Dial(SIP/70/100) ;same =\u003e n,Hangup() exten =\u003e sms,1,Verbose(Incoming SMS from ${CALLERID(num)} ${BASE64_DECODE(${SMS_BASE64})}) ;store exten =\u003e sms,n,System(echo '${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME} - ${CALLERID(num)}: ${BASE64_DECODE(${SMS_BASE64})}' \u003e\u003e /var/log/asterisk/sms.txt) ;for tg bot use exten =\u003e sms,n,System(echo '${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME} - ${CALLERID(num)}\\n${BASE64_DECODE(${SMS_BASE64})}' \u003e\u003e /var/log/asterisk/unread_sms/${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}-${CALLERID(num)}.txt) exten =\u003e sms,n,Hangup() exten =\u003e ussd,1,Verbose(Incoming USSD: ${BASE64_DECODE(${USSD_BASE64})}) exten =\u003e ussd,n,System(echo '${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME}: ${BASE64_DECODE(${USSD_BASE64})}' \u003e\u003e /var/log/asterisk/ussd.txt) exten =\u003e ussd,n,Hangup() exten =\u003e _.,1,Dial(SIP/70/100) exten =\u003e s,n,Hangup() [Outbound-1001] exten =\u003e _.,1,Dial(Quectel/quectel0/${EXTEN}) same =\u003e n,Hangup() After modifying, restart Asterisk again.\nTesting Sending and Receiving SMS You can try sending an SMS to 10010 at this point to test sending and receiving messages:\nSending SMS (send “cxll” to 10010) asterisk -rx 'quectel sms quectel0 10010 \"cxll\"' Receiving SMS According to the previous dialplan, after receiving an SMS, Asterisk will directly write the SMS content into /var/log/asterisk/sms.txt, which will look something like this:\ntail -f /var/log/asterisk/sms.txt 2022-10-01 00:00:00 - quectel0 - 10010: 【权益领取提醒】尊敬的用户，您已获得2个月视频会员体验资格（原价15元/月），腾讯、爱奇艺、优酷、芒果TV、QQ音乐等20款会员每月任选1款，点击 https://u.10010.cn 即可参与(活动规则详见页面说明，限48小时内参与，短信转发无效，已办理请忽略)。如需屏蔽，请在“广东联通”官方公众号内回复“TD”，首次关注可领4GB流量【广东联通】 If you need to further forward the SMS, just read this file, or modify the output format of the SMS in the dialplan.\nUsing a Telegram Bot for Self-Service SMS Sending and Receiving The following scripts are all written with ChatGPT, and the author has not encountered any obvious problems using them for the time being:\nSending SMS Systemd service:\n[Unit] Description=Outbound SMS service for TG-SMS Wants=network-online.target After=network-online.target [Service] Type=simple ExecStart=/opt/tg-sms/outbound/.venv/bin/python3 /opt/tg-sms/outbound/outbound-sms.py Restart=on-failure RestartSec=5 User=asterisk [Install] WantedBy=multi-user.target Script (you need to install the old version of python-telegram-bot pip install python-telegram-bot==13.15):\nfrom telegram import Update, ForceReply from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext # We'll use a dictionary to store each user's state. user_data = {} # List of allowed user/group IDs. ALLOWED_IDS = [11111111] def send(update: Update, context: CallbackContext) -\u003e None: if update.message.chat_id not in ALLOWED_IDS: update.message.reply_text('您没有权限使用这个 bot。') return if len(context.args) != 1: update.message.reply_text('请按照以下格式发送命令：/send ') return user_data[update.message.chat_id] = {'phone_number': context.args[0]} update.message.reply_text('请输入您要发送的信息：', reply_markup=ForceReply()) def cancel(update: Update, context: CallbackContext) -\u003e None: user_data.pop(update.message.chat_id, None) update.message.reply_text('操作已取消。') def handle_message(update: Update, context: CallbackContext) -\u003e None: if update.message.chat_id not in user_data: return if 'message' not in user_data[update.message.chat_id]: user_data[update.message.chat_id]['message'] = update.message.text update.message.reply_text('请确认信息：\\n手机号：{}\\n信息：{}'.format(user_data[update.message.chat_id]['phone_number'], user_data[update.message.chat_id]['message']), reply_markup=ForceReply()) else: confirmation = update.message.text if confirmation.lower() == 'yes': import os result = os.popen('asterisk -rx \\'quectel sms quectel0 {} \"{}\"\\''.format(user_data[update.message.chat_id]['phone_number'], user_data[update.message.chat_id]['message'])).read() update.message.reply_text('命令执行结果：\\n{}'.format(result)) else: update.message.reply_text('操作已取消。') user_data.pop(update.message.chat_id, None) def main() -\u003e None: updater = Updater(token='your_token', use_context=True) dispatcher = updater.dispatcher dispatcher.add_handler(CommandHandler(\"send\", send)) dispatcher.add_handler(CommandHandler(\"cancel\", cancel)) dispatcher.add_handler(MessageHandler(Filters.text \u0026 ~Filters.command, handle_message)) updater.start_polling() updater.idle() if __name__ == '__main__': main() Receiving SMS import requests import sys import urllib.parse import re # extract verify code def extract_verification_code(sms_text): # 定位到“验证码”关键词 keyword_index = sms_text.find('验证码') if keyword_index == -1: return None # 从关键词后开始匹配4-6位的数字 match = re.search(r'(\\d{4,6})', sms_text[keyword_index:]) if match: return match.group(1) return None # tg tg_bot_token = \"\" tg_send_msg_url = \"https://api.telegram.org/bot\"+tg_bot_token+\"/sendMessage\" tg_receive_msg_url = \"https://api.telegram.org/bot\"+tg_bot_token+\"/getUpdates\" # wecom wecom_send_msg_url = \"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key\" bark_send_msg_url = \"https://api.day.app/bark-token/\" def incoming_sms_tg(msg_text): send_body = {} send_body['chat_id'] = '11111111' send_body['text'] = msg_text requests.post(tg_send_msg_url, json=send_body) def incoming_sms_wecom(msg_text): send_body = {} send_body['msgtype'] = 'text' send_body['text'] = {} send_body['text']['content'] = msg_text requests.post(wecom_send_msg_url, json=send_body) def incoming_sms_bark(msg_text): requests.get(bark_send_msg_url + urllib.parse.quote_plus(msg_text) + \"?copy=\" + extract_verification_code(msg_text)) def incoming(): msg_text = sys.argv[1] incoming_sms_wecom(msg_text) incoming_sms_bark(msg_text) incoming_sms_tg(msg_text) incoming() Installing the FreePBX Virtual Machine Download the FreePBX ISO image from the official FreePBX website (it appears to be a CentOS 7 system): https://www.freepbx.org/downloads/. Install the system using the image, choosing freepbx 16 with asterisk 18 during the installation. After installation, access the virtual machine’s IP in a browser and set the initial administrator password (you can temporarily not open the firewall at the beginning for easy configuration).\nAdding an Extension Number In Applications - Extensions, click “add extension” - SIP extension, and add an extension with the number 200 (the number is arbitrary as long as it doesn’t clash with the numbers in the Asterisk virtual machine):\n添加 sip extensions Keep the rest as default, click “submit,” and then click the apply config button in the upper right corner.\nAdding a Trunk Before adding, first, follow the instructions in the previous post, modify /etc/asterisk/sip.conf in the Asterisk virtual machine, changing the host=192.168.x.x of the bottom 70 extension to the IP of the FreePBX virtual machine, and restart Asterisk.\nIn FreePBX, under Connectivity - Trunks, add a SIP Trunk. Configure it as follows, with other settings at default:\nRename outbound CallerID to the number in asterisk VM (70) Change SIP server to the ip of asterisk VM Routing In Connectivity - Outbound Routes, create a new route and forward all outbound routes to the SIP trunk created in the previous step:\noutbound-route In Connectivity - Inbound Routes, create a new route and forward all inbound routes to the extension number set above:\ninbound-route If you connect multiple extensions or multiple dongles in the future and need to route calls based on the user, you can configure the above DID and CallerID to filter calls in detail.\nTesting Calls Download a free version of zoiper. When adding an account, enter the username as extension number@FreePBX's IP, and the password as the one set above (make sure you do not enter it incorrectly; FreePBX has fail2ban enabled by default. Entering the SIP password incorrectly will also trigger fail2ban, and you will need to manually delete the iptables rules).\nAfter confirming registration, try calling 10010 or your own phone via Zoiper to test if voice and DTMF tones are recognized. If an incoming call to the dongle’s number comes into FreePBX, it will be directly transferred to the extension, at which point Zoiper will give you a prompt. You can answer the call at that point.\nPort Forwarding, SIP Push, etc. For SIP, in addition to forwarding the default SIP port (5201, you can view this in FreePBX settings under settings - asterisk sip setting), you also need to forward RTP ports. If you only want to forward one port, you can consider using an IAX2 extension, referring to EC20 Module + Issabel for VoIP - Hanako Blog. For SIP Push (displaying a push notification on your phone when a call is received), currently only Zoiper provides a more convenient way to configure it, but it requires payment. Refer to How to Get Rid of the SIM Card From Your Phone – IAM-LC for details.\nUsing the Module for Internet Access If the SIM card you’re using has a data plan, you can also configure the module for internet access. This ensures that SMS forwarding and calls can continue normally if the machine’s wired/wireless network goes down.\nFirst, after connecting to the serial port, enter AT+QCFG=\"usbnet\",1 to set the usbnet mode to ECM (1 for ECM, 2 for NDIS, and 3 for RNDIS).\nThen, restart the module using AT+CFUN=1,1 and check ip a. You should see an interface similar to enxe2eeabcd123. You can run dhclient directly on this interface to obtain a v4 or v6 address. If you’re concerned about the interface name changing frequently, you can refer to this question to rename the interface based on the MAC address to something more manageable like quectel-usbX.\n3: quectel-usb0: mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000 link/ether ff:ff:ff:ff:ff:ff brd ff:ff:ff:ff:ff:ff inet 192.168.225.41/24 brd 192.168.225.255 scope global dynamic quectel-usb0 valid_lft 28802sec preferred_lft 28802sec inet6 2408::/64 scope global dynamic mngtmpaddr valid_lft forever preferred_lft forever inet6 fe80::/64 scope link valid_lft forever preferred_lft forever Misc When the SIP client is not open (or in background), calls to the dongle will indicate that the user is busy. You need to use the SIP push method mentioned in the previous section or keep the client open to receive calls normally. References The EC20 AT command set can be downloaded from https://www.quectel.com/ProductDownload/EC20.html. Quectel driver on Asterisk: https://github.com/IchthysMaranatha/asterisk-chan-quectel/ https://gao.md/blog/2014/10/05/sms-gateway-setup-huawei-e1750-asterisk-chan-dongle/ https://iam.lc/2024/01/how-to-get-rid-of-sim.ping https://forums.quectel.com/t/ec25-e-mini-additional-mbn-files/13473/2 ","wordCount":"3121","inLanguage":"en","image":"https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/ec20-taobao.jpg","datePublished":"2022-10-08T12:00:00Z","dateModified":"2025-01-29T22:58:05+08:00","author":{"@type":"Person","name":"sparktour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/"},"publisher":{"@type":"Organization","name":"Sparktour’s Blog","logo":{"@type":"ImageObject","url":"https://blog.sparktour.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.sparktour.me/en/ accesskey=h title="Sparktour’s Blog (Alt + H)">Sparktour’s Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.sparktour.me/ title=中文 aria-label=中文>中文</a></li></ul></div></div><ul id=menu><li><a href=https://blog.sparktour.me/en/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.sparktour.me/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.sparktour.me/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.sparktour.me/en/about/ title=About><span>About</span></a></li><li><a href=https://blog.sparktour.me/en/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.sparktour.me/en/>Home</a></div><h1 class="post-title entry-hint-parent">Using EC20 Module, Asterisk, and FreePBX for SMS Forwarding and VoIP</h1><div class=post-description>In many parts of the world, mobile phone numbers are increasingly intertwined with online services and personal identity. This is particularly true in mainland China, where a single user may find themselves managing multiple phone numbers for various applications and platforms. While solutions like telegram-sms and SMS-forwarder have emerged to address the inconvenience of managing multiple physical SIM cards, they come with limitations. These apps, typically installed on smartphones, are often hampered by aggressive background process management common on Android devices, leading to unreliable SMS forwarding. Furthermore, the practice of keeping older devices powered on long-term for this purpose introduces safety concerns, such as battery swelling. Perhaps the most significant limitation is the inability to handle phone calls; these apps only address SMS. This article details a project where the author, leveraging an EC20 cellular module and a blend of software tools, overcame these limitations. The setup allows for SMS messaging through instant messaging applications like Telegram, and makes and receives phone calls over the internet using SIP clients, providing a more robust and flexible solution.</div><div class=post-meta><span title='2022-10-08 12:00:00 +0000 UTC'>2022-10-08</span>&nbsp;·&nbsp;<span title='2025-01-29 22:58:05 +0800 +0800'>LastMod: 2025-01-29</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;sparktour&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/>中文</a></li></ul></div></header><figure class=entry-cover><img loading=eager src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/ec20-taobao.jpg alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#other-solutions-the-author-investigated aria-label="Other Solutions the Author Investigated">Other Solutions the Author Investigated</a><ul><li><a href=#multi-sim-box-%e5%a4%9a%e5%8d%a1%e5%ae%9d aria-label="Multi-SIM Box (多卡宝)">Multi-SIM Box (多卡宝)</a></li><li><a href=#goip-devices aria-label="GOIP Devices">GOIP Devices</a></li></ul></li><li><a href=#materials-and-costs aria-label="Materials and Costs">Materials and Costs</a><ul><li><a href=#ec20-and-peripherals aria-label="EC20 and Peripherals">EC20 and Peripherals</a></li><li><a href=#vm-host aria-label="VM Host">VM Host</a></li></ul></li><li><a href=#configuring-the-ec20 aria-label="Configuring the EC20">Configuring the EC20</a><ul><li><a href=#verifying-the-ec20-can-read-the-sim-card aria-label="Verifying the EC20 Can Read the SIM Card">Verifying the EC20 Can Read the SIM Card</a></li><li><a href=#configuring-volte aria-label="Configuring VoLTE">Configuring VoLTE</a></li><li><a href=#optional-activate-uac-digital-audio aria-label="Optional (Activate UAC Digital Audio)">Optional (Activate UAC Digital Audio)</a></li></ul></li><li><a href=#installing-the-asterisk-virtual-machine aria-label="Installing the Asterisk Virtual Machine">Installing the Asterisk Virtual Machine</a><ul><li><a href=#installing-asterisk-and-some-dependencies aria-label="Installing Asterisk and Some Dependencies">Installing Asterisk and Some Dependencies</a></li><li><a href=#downloading-asterisk-chan-quectel aria-label="Downloading asterisk-chan-quectel:">Downloading asterisk-chan-quectel:</a></li><li><a href=#configuring-the-dialplan aria-label="Configuring the Dialplan">Configuring the Dialplan</a></li><li><a href=#testing-sending-and-receiving-sms aria-label="Testing Sending and Receiving SMS">Testing Sending and Receiving SMS</a><ul><li><a href=#sending-sms-send-cxll-to-10010 aria-label="Sending SMS (send &ldquo;cxll&rdquo; to 10010)">Sending SMS (send &ldquo;cxll&rdquo; to 10010)</a></li><li><a href=#receiving-sms aria-label="Receiving SMS">Receiving SMS</a></li></ul></li><li><a href=#using-a-telegram-bot-for-self-service-sms-sending-and-receiving aria-label="Using a Telegram Bot for Self-Service SMS Sending and Receiving">Using a Telegram Bot for Self-Service SMS Sending and Receiving</a></li><li><a href=#sending-sms aria-label="Sending SMS">Sending SMS</a></li><li><a href=#receiving-sms-1 aria-label="Receiving SMS">Receiving SMS</a></li></ul></li><li><a href=#installing-the-freepbx-virtual-machine aria-label="Installing the FreePBX Virtual Machine">Installing the FreePBX Virtual Machine</a><ul><li><a href=#adding-an-extension-number aria-label="Adding an Extension Number">Adding an Extension Number</a></li><li><a href=#adding-a-trunk aria-label="Adding a Trunk">Adding a Trunk</a></li><li><a href=#routing aria-label=Routing>Routing</a></li><li><a href=#testing-calls aria-label="Testing Calls">Testing Calls</a></li><li><a href=#port-forwarding-sip-push-etc aria-label="Port Forwarding, SIP Push, etc.">Port Forwarding, SIP Push, etc.</a></li></ul></li><li><a href=#using-the-module-for-internet-access aria-label="Using the Module for Internet Access">Using the Module for Internet Access</a></li><li><a href=#misc aria-label=Misc>Misc</a></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>In many parts of the world, mobile phone numbers are increasingly intertwined with online services and personal identity. This is particularly true in mainland China, where a single user may find themselves managing multiple phone numbers for various applications and platforms. While solutions like <a href=https://github.com/telegram-sms/telegram-sms-china>telegram-sms</a> and <a href=https://github.com/pppscn/SmsForwarder>SMS-forwarder</a> have emerged to address the inconvenience of managing multiple physical SIM cards, they come with limitations. These apps, typically installed on smartphones, are often hampered by aggressive background process management common on Android devices, leading to unreliable SMS forwarding. Furthermore, the practice of keeping older devices powered on long-term for this purpose introduces safety concerns, such as battery swelling. Perhaps the most significant limitation is the inability to handle phone calls; these apps only address SMS. This article details a project where the author, using an EC20 cellular module and a blend of software tools like asterisk, to overcame these limitations. The setup allows for SMS messaging through instant messaging applications like Telegram, and makes and receives phone calls over the internet using SIP clients, providing a more robust and flexible solution.</p><hr><h2 id=other-solutions-the-author-investigated>Other Solutions the Author Investigated<a hidden class=anchor aria-hidden=true href=#other-solutions-the-author-investigated>#</a></h2><h3 id=multi-sim-box-多卡宝><a href=https://cn.ucloudlink.com/html/devices-simbox/>Multi-SIM Box (多卡宝)</a><a hidden class=anchor aria-hidden=true href=#multi-sim-box-多卡宝>#</a></h3><p>A popular SIM card hosting solution one or two years ago, it could hold four cards and have two cards on standby simultaneously, forwarding SMS and calls using its own app. According to <a href=https://fccid.io/2AC88-C1-CN/Internal-Photos/Internal-Photos-4057106>FCCID&rsquo;s PDF</a>, it uses a Qualcomm <a href=https://www.qualcomm.com/products/application/smartphones/qualcomm-2-series-mobile-platforms/snapdragon-processors-210>Snapdragon 210</a> processor, commonly found in some 4G feature phones. Therefore, the author suspects the multi-SIM box used a modified Android system. However, in the second half of 2021, multi-SIM boxes were removed from domestic e-commerce platforms, likely due to regulatory reasons (possibly being used for telecom fraud?). Also, because SMS and voice data must go through a third-party server, there are some security concerns.</p><h3 id=goip-devices>GOIP Devices<a hidden class=anchor aria-hidden=true href=#goip-devices>#</a></h3><p>Commonly known as &ldquo;cat pools,&rdquo; these devices are too expensive for the author to afford.</p><h2 id=materials-and-costs>Materials and Costs<a hidden class=anchor aria-hidden=true href=#materials-and-costs>#</a></h2><h3 id=ec20-and-peripherals>EC20 and Peripherals<a hidden class=anchor aria-hidden=true href=#ec20-and-peripherals>#</a></h3><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/ec20-taobao.jpg alt=ec20-taobao><figcaption>ec20-taobao</figcaption></figure></p><p>A 4G card from Quectel that supports LTE Cat4 and uses the <a href=https://www.qualcomm.com/products/technology/modems/snapdragon-modems-4g-lte-x5>Snapdragon X5 LTE Modem</a>. This card has several versions, some of which only support internet access and not calls or SMS. If you need to send/receive SMS and make calls, try to purchase the top-tier <code>EC20CEFAG-512-SGNS</code>, with a mini-pcie interface. It costs about 200 RMB from Quectel&rsquo;s Taobao store, or about 50-60 RMB on Xianyu (a second-hand market).</p><p>Each card also requires a mini PCIE to USB adapter card with a SIM slot, which costs about 25 RMB. Search for &ldquo;4G module adapter board Mini PCIE to USB&rdquo; on Taobao. The card slot usually takes a Mini SIM, if you only have a nano SIM, you may need to buy a SIM adapter.</p><p>Additionally, you&rsquo;ll need to buy some IPEX to SMA adapter cables and SMA interface 4G antennas, which can be found by searching those keywords on Taobao.</p><h3 id=vm-host>VM Host<a hidden class=anchor aria-hidden=true href=#vm-host>#</a></h3><p>The requirements are not high; generally, you just need a USB port and a wired network port. It&rsquo;s recommended to install a virtualization system like PVE or ESXi. (Raspberry Pi may not work due to <a href="https://github.com/IchthysMaranatha/asterisk-chan-quectel#:~:text=Note%20for%20Pi%20users%3A%20If,of%20the%20waveshare%20sim7600%20dongle.">insufficient power</a>). The author bought a second-hand Optiplex 3050mff with an i3-6100T, 8GB of RAM, and a 256GB SSD for about 600 RMB.</p><h2 id=configuring-the-ec20>Configuring the EC20<a hidden class=anchor aria-hidden=true href=#configuring-the-ec20>#</a></h2><h3 id=verifying-the-ec20-can-read-the-sim-card>Verifying the EC20 Can Read the SIM Card<a hidden class=anchor aria-hidden=true href=#verifying-the-ec20-can-read-the-sim-card>#</a></h3><p><strong>Disable the SIM card&rsquo;s PIN</strong>, insert it into the card slot, connect the EC20 to the antenna, and power it on. You should then see several <code>ttyUSB</code> ports in <code>/dev</code>:</p><pre tabindex=0><code>ttyUSB0
ttyUSB1 PCM voice, GPS signal
ttyUSB2 Control commands
ttyUSB3
</code></pre><p>Use minicom to open the <code>ttyUSB2</code> port:</p><pre tabindex=0><code>minicom -D /dev/ttyUSB2

# Enter ATI to check the EC20&#39;s version:
ATI
Quectel
EC20F
Revision: EC20CEFAGR06A15M4G
</code></pre><p>If everything is normal, you can reset the EC20 first to prevent the previous user from having set incorrect configurations (but do not reset the EC20 too frequently, as the reset operation can wear out the dongle&rsquo;s flash memory):</p><pre tabindex=0><code>Reset module at+qprtpara=3
Restart AT+CFUN=1,1
</code></pre><p>After resetting and restarting, you can check if the SIM card has registered successfully using the following commands (the example below is for China Unicom; the same applies to other carriers):</p><pre tabindex=0><code>AT+COPS? 
+COPS: 0,0,&#34;CHN-UNICOM&#34;,7

AT+QNWINFO
+QNWINFO: &#34;FDD LTE&#34;,&#34;46001&#34;,&#34;LTE BAND 3&#34;,1650

AT+QENG=&#34;servingcell&#34;
+QENG: &#34;servingcell&#34;,&#34;CONNECT&#34;,&#34;LTE&#34;,&#34;FDD&#34;,460,01
</code></pre><h3 id=configuring-volte>Configuring VoLTE<a hidden class=anchor aria-hidden=true href=#configuring-volte>#</a></h3><p>With major carriers gradually phasing out 2G and 3G, configuring VoLTE for the dongle is becoming increasingly necessary. The following procedure refers to <a href=https://www.quectel.com/wp-content/uploads/2021/09/Quectel_EC2xEG9xEG2x-GEM05_Series_IMS_Application_Note_V1.0.pdf>this PDF</a>:</p><pre tabindex=0><code>Enable IMS AT+QCFG=&#34;ims&#34;,1

View mbn files in the dongle AT+QMBNCFG=&#34;List&#34;
+QMBNCFG: &#34;List&#34;,0,1,1,&#34;ROW_Generic_3GPP&#34;,0x05010824,201806201
+QMBNCFG: &#34;List&#34;,1,0,0,&#34;OpenMkt-Commercial-CU&#34;,0x05011510,201911151
+QMBNCFG: &#34;List&#34;,2,0,0,&#34;OpenMkt-Commercial-CT&#34;,0x0501131C,201911141
+QMBNCFG: &#34;List&#34;,3,0,0,&#34;Volte_OpenMkt-Commercial-CMCC&#34;,0x05012011,201904261

# Although it lists VoLTE configuration files for China Mobile, China Unicom, and China Telecom, using the default automatic selection of CU/CT/CMCC cannot register VoLTE. After a long period of experimentation, the author found that forcing the selection of ROW_Generic_3GPP is necessary to register VoLTE successfully.

Disable automatic mbn selection AT+QMBNCFG=&#34;AutoSel&#34;,0
Deactivate current mbn at+qmbncfg=&#34;deactivate&#34;

Force selection of 3gpp AT+QMBNCFG=&#34;select&#34;,&#34;ROW_Generic_3GPP&#34;
Restart AT+CFUN=1,1

You can check the mbn selection status again. If the second and third digits of ROW_Generic_3GPP are both 1, it indicates that the dongle has selected this configuration. AT+QMBNCFG=&#34;List&#34;
+QMBNCFG: &#34;List&#34;,0,1,1,&#34;ROW_Generic_3GPP&#34;,0x05010824,201806201
+QMBNCFG: &#34;List&#34;,1,0,0,&#34;OpenMkt-Commercial-CU&#34;,0x05011510,201911151
+QMBNCFG: &#34;List&#34;,2,0,0,&#34;OpenMkt-Commercial-CT&#34;,0x0501131C,201911141
+QMBNCFG: &#34;List&#34;,3,0,0,&#34;Volte_OpenMkt-Commercial-CMCC&#34;,0x05012011,201904261

After restarting, check the IMS status AT+QCFG=&#34;ims&#34;

If it returns +QCFG: &#34;ims&#34;,1,1, it&#39;s enabled. If it returns +QCFG: &#34;ims&#34;,1,0, it&#39;s not enabled.
</code></pre><h3 id=optional-activate-uac-digital-audio>Optional (Activate UAC Digital Audio)<a hidden class=anchor aria-hidden=true href=#optional-activate-uac-digital-audio>#</a></h3><p>Refer to <a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/2>https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/2</a>:</p><pre tabindex=0><code>AT+QCFG=&#34;usbcfg&#34;,0x2C7C,0x0125,1,1,1,1,1,0,1
</code></pre><p>This command will also open an adb daemon. You can use <code>adb shell</code> to enter the module&rsquo;s built-in Android system. If the system has a password (whether or not it has a password does not affect subsequent configurations), you can use <code>adb pull</code> to pull the dongle&rsquo;s <code>/etc/passwd</code>, remove the root password, and then <code>push</code> it back.</p><p>After activation, you can check if there is an Android device by using <code>aplay -L</code>.</p><pre tabindex=0><code>dmix:CARD=Android,DEV=0
    Android, USB Audio
    Direct sample mixing device
</code></pre><h2 id=installing-the-asterisk-virtual-machine>Installing the Asterisk Virtual Machine<a hidden class=anchor aria-hidden=true href=#installing-the-asterisk-virtual-machine>#</a></h2><p>FreePBX&rsquo;s built-in Asterisk is tightly coupled with FreePBX configurations, making it difficult for the author to use. Also, CentOS doesn&rsquo;t seem to be able to read the dongle&rsquo;s UAC interface. Therefore, the author configured a simple Asterisk system based on a <a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/13>discussion</a> by the Quectel channel driver author. The author uses Debian 11 here and installs the Asterisk 16 included in the package manager. <strong>After installing Asterisk, remember to pass through the dongle&rsquo;s USB interface into the virtual machine.</strong></p><h3 id=installing-asterisk-and-some-dependencies>Installing Asterisk and Some Dependencies<a hidden class=anchor aria-hidden=true href=#installing-asterisk-and-some-dependencies>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install asterisk asterisk-dev adb git autoconf automake libsqlite3-dev build-essential libasound2-dev alsa-utils
</span></span></code></pre></div><h3 id=downloading-asterisk-chan-quectel>Downloading <a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel>asterisk-chan-quectel</a>:<a hidden class=anchor aria-hidden=true href=#downloading-asterisk-chan-quectel>#</a></h3><pre tabindex=0><code>git clone https://github.com/IchthysMaranatha/asterisk-chan-quectel
cd asterisk-chan-quectel

./bootstrap
./configure --with-astversion=16
make
make install
</code></pre><p>Then, copy <code>uac/quectel.conf</code> to <code>/etc/asterisk</code>. Restart Asterisk using <code>systemctl restart asterisk</code>.</p><p>Enter Asterisk&rsquo;s CLI interface using <code>asterisk -rvvv</code> and enter <code>quectel show devices</code>. You should see the identified dongle, including its IMEI and the SIM card&rsquo;s IMSI:</p><pre tabindex=0><code># asterisk -rvvv
Asterisk 16.16.1~dfsg-1+deb11u1, Copyright (C) 1999 - 2018, Digium, Inc. and others.
Created by Mark Spencer &lt;markster@digium.com&gt;
Asterisk comes with ABSOLUTELY NO WARRANTY; type &#39;core show warranty&#39; for details.
This is free software, with components licensed under the GNU General Public
License version 2 and other licenses; you are welcome to redistribute it under
certain conditions. Type &#39;core show license&#39; for details.
=========================================================================
Connected to Asterisk 16.16.1~dfsg-1+deb11u1 currently running on debian-asterisk (pid = 1403)
debian-asterisk*CLI&gt; quectel show devices
ID           Group State      RSSI Mode Submode Provider Name  Model      Firmware          IMEI             IMSI             Number        
quectel0     0     Free       27   0    0       CHN-UNICOM     EC20F      EC20CEFAGR06A15M4 86XXXXX  46XXXXX  Unknown       
debian-asterisk*CLI&gt; 
</code></pre><h3 id=configuring-the-dialplan>Configuring the Dialplan<a hidden class=anchor aria-hidden=true href=#configuring-the-dialplan>#</a></h3><p>Directly refer to the post written by the driver author and download the <a href="https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/13#:~:text=Download%20attached%20zip%20file%20with%20this%20post%20and%20extract%20sip.conf%20and%20extensions.conf%0Asipext.zip">sipext.zip</a> from that post. Extract it and place the files in <code>/etc/asterisk</code>. At the same time, modify <code>/etc/asterisk/extensions.conf</code> (please do not copy directly! Modify according to your situation and the driver author&rsquo;s <a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/13>post</a>):</p><pre tabindex=0><code>[incoming-mobile]
;exten =&gt; _.,1,Dial(SIP/70/100)
;same =&gt; n,Hangup()
exten =&gt; sms,1,Verbose(Incoming SMS from ${CALLERID(num)} ${BASE64_DECODE(${SMS_BASE64})})
;store
exten =&gt; sms,n,System(echo &#39;${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME} - ${CALLERID(num)}: ${BASE64_DECODE(${SMS_BASE64})}&#39; &gt;&gt; /var/log/asterisk/sms.txt)
;for tg bot use
exten =&gt; sms,n,System(echo &#39;${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME} - ${CALLERID(num)}\n${BASE64_DECODE(${SMS_BASE64})}&#39; &gt;&gt; /var/log/asterisk/unread_sms/${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}-${CALLERID(num)}.txt)
exten =&gt; sms,n,Hangup()

exten =&gt; ussd,1,Verbose(Incoming USSD: ${BASE64_DECODE(${USSD_BASE64})})
exten =&gt; ussd,n,System(echo &#39;${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME}: ${BASE64_DECODE(${USSD_BASE64})}&#39; &gt;&gt; /var/log/asterisk/ussd.txt)
exten =&gt; ussd,n,Hangup()

exten =&gt; _.,1,Dial(SIP/70/100)
exten =&gt; s,n,Hangup()


[Outbound-1001]
exten =&gt; _.,1,Dial(Quectel/quectel0/${EXTEN})
same =&gt; n,Hangup()
</code></pre><p>After modifying, restart Asterisk again.</p><h3 id=testing-sending-and-receiving-sms>Testing Sending and Receiving SMS<a hidden class=anchor aria-hidden=true href=#testing-sending-and-receiving-sms>#</a></h3><p>You can try sending an SMS to 10010 at this point to test sending and receiving messages:</p><h4 id=sending-sms-send-cxll-to-10010>Sending SMS (send &ldquo;cxll&rdquo; to 10010)<a hidden class=anchor aria-hidden=true href=#sending-sms-send-cxll-to-10010>#</a></h4><pre tabindex=0><code>asterisk -rx &#39;quectel sms quectel0 10010 &#34;cxll&#34;&#39;
</code></pre><h4 id=receiving-sms>Receiving SMS<a hidden class=anchor aria-hidden=true href=#receiving-sms>#</a></h4><p>According to the previous dialplan, after receiving an SMS, Asterisk will directly write the SMS content into <code>/var/log/asterisk/sms.txt</code>, which will look something like this:</p><pre tabindex=0><code>tail -f /var/log/asterisk/sms.txt

2022-10-01 00:00:00 - quectel0 - 10010: 【权益领取提醒】尊敬的用户，您已获得2个月视频会员体验资格（原价15元/月），腾讯、爱奇艺、优酷、芒果TV、QQ音乐等20款会员每月任选1款，点击 https://u.10010.cn 即可参与(活动规则详见页面说明，限48小时内参与，短信转发无效，已办理请忽略)。如需屏蔽，请在“广东联通”官方公众号内回复“TD”，首次关注可领4GB流量【广东联通】
</code></pre><p>If you need to further forward the SMS, just read this file, or modify the output format of the SMS in the dialplan.</p><h3 id=using-a-telegram-bot-for-self-service-sms-sending-and-receiving>Using a Telegram Bot for Self-Service SMS Sending and Receiving<a hidden class=anchor aria-hidden=true href=#using-a-telegram-bot-for-self-service-sms-sending-and-receiving>#</a></h3><p><em>The following scripts are all written with ChatGPT, and the author has not encountered any obvious problems using them for the time being:</em></p><h3 id=sending-sms>Sending SMS<a hidden class=anchor aria-hidden=true href=#sending-sms>#</a></h3><p>Systemd service:</p><pre tabindex=0><code>[Unit]
Description=Outbound SMS service for TG-SMS
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
ExecStart=/opt/tg-sms/outbound/.venv/bin/python3 /opt/tg-sms/outbound/outbound-sms.py
Restart=on-failure
RestartSec=5
User=asterisk

[Install]
WantedBy=multi-user.target
</code></pre><p>Script (you need to install the old version of python-telegram-bot <code>pip install python-telegram-bot==13.15</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>telegram</span> <span class=kn>import</span> <span class=n>Update</span><span class=p>,</span> <span class=n>ForceReply</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>telegram.ext</span> <span class=kn>import</span> <span class=n>Updater</span><span class=p>,</span> <span class=n>CommandHandler</span><span class=p>,</span> <span class=n>MessageHandler</span><span class=p>,</span> <span class=n>Filters</span><span class=p>,</span> <span class=n>CallbackContext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># We&#39;ll use a dictionary to store each user&#39;s state.</span>
</span></span><span class=line><span class=cl><span class=n>user_data</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># List of allowed user/group IDs.</span>
</span></span><span class=line><span class=cl><span class=n>ALLOWED_IDS</span> <span class=o>=</span> <span class=p>[</span><span class=mi>11111111</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>(</span><span class=n>update</span><span class=p>:</span> <span class=n>Update</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>CallbackContext</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ALLOWED_IDS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;您没有权限使用这个 bot。&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;请按照以下格式发送命令：/send &lt;phone_number&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;phone_number&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;请输入您要发送的信息：&#39;</span><span class=p>,</span> <span class=n>reply_markup</span><span class=o>=</span><span class=n>ForceReply</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cancel</span><span class=p>(</span><span class=n>update</span><span class=p>:</span> <span class=n>Update</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>CallbackContext</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>user_data</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;操作已取消。&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_message</span><span class=p>(</span><span class=n>update</span><span class=p>:</span> <span class=n>Update</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>CallbackContext</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;message&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;message&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;请确认信息：</span><span class=se>\n</span><span class=s1>手机号：</span><span class=si>{}</span><span class=se>\n</span><span class=s1>信息：</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;phone_number&#39;</span><span class=p>],</span> <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;message&#39;</span><span class=p>]),</span> <span class=n>reply_markup</span><span class=o>=</span><span class=n>ForceReply</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>confirmation</span> <span class=o>=</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>confirmation</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;yes&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>popen</span><span class=p>(</span><span class=s1>&#39;asterisk -rx </span><span class=se>\&#39;</span><span class=s1>quectel sms quectel0 </span><span class=si>{}</span><span class=s1> &#34;</span><span class=si>{}</span><span class=s1>&#34;</span><span class=se>\&#39;</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;phone_number&#39;</span><span class=p>],</span> <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;message&#39;</span><span class=p>]))</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;命令执行结果：</span><span class=se>\n</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;操作已取消。&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>user_data</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>updater</span> <span class=o>=</span> <span class=n>Updater</span><span class=p>(</span><span class=n>token</span><span class=o>=</span><span class=s1>&#39;your_token&#39;</span><span class=p>,</span> <span class=n>use_context</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dispatcher</span> <span class=o>=</span> <span class=n>updater</span><span class=o>.</span><span class=n>dispatcher</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dispatcher</span><span class=o>.</span><span class=n>add_handler</span><span class=p>(</span><span class=n>CommandHandler</span><span class=p>(</span><span class=s2>&#34;send&#34;</span><span class=p>,</span> <span class=n>send</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>dispatcher</span><span class=o>.</span><span class=n>add_handler</span><span class=p>(</span><span class=n>CommandHandler</span><span class=p>(</span><span class=s2>&#34;cancel&#34;</span><span class=p>,</span> <span class=n>cancel</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>dispatcher</span><span class=o>.</span><span class=n>add_handler</span><span class=p>(</span><span class=n>MessageHandler</span><span class=p>(</span><span class=n>Filters</span><span class=o>.</span><span class=n>text</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>Filters</span><span class=o>.</span><span class=n>command</span><span class=p>,</span> <span class=n>handle_message</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>updater</span><span class=o>.</span><span class=n>start_polling</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>updater</span><span class=o>.</span><span class=n>idle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=receiving-sms-1>Receiving SMS<a hidden class=anchor aria-hidden=true href=#receiving-sms-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># extract verify code</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_verification_code</span><span class=p>(</span><span class=n>sms_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 定位到“验证码”关键词</span>
</span></span><span class=line><span class=cl>    <span class=n>keyword_index</span> <span class=o>=</span> <span class=n>sms_text</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;验证码&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>keyword_index</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 从关键词后开始匹配4-6位的数字</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;(\d{4,6})&#39;</span><span class=p>,</span> <span class=n>sms_text</span><span class=p>[</span><span class=n>keyword_index</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># tg</span>
</span></span><span class=line><span class=cl><span class=n>tg_bot_token</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tg_send_msg_url</span> <span class=o>=</span> <span class=s2>&#34;https://api.telegram.org/bot&#34;</span><span class=o>+</span><span class=n>tg_bot_token</span><span class=o>+</span><span class=s2>&#34;/sendMessage&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tg_receive_msg_url</span> <span class=o>=</span> <span class=s2>&#34;https://api.telegram.org/bot&#34;</span><span class=o>+</span><span class=n>tg_bot_token</span><span class=o>+</span><span class=s2>&#34;/getUpdates&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># wecom</span>
</span></span><span class=line><span class=cl><span class=n>wecom_send_msg_url</span> <span class=o>=</span> <span class=s2>&#34;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key&#34;</span>
</span></span><span class=line><span class=cl><span class=n>bark_send_msg_url</span> <span class=o>=</span> <span class=s2>&#34;https://api.day.app/bark-token/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incoming_sms_tg</span><span class=p>(</span><span class=n>msg_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;chat_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;11111111&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>msg_text</span>
</span></span><span class=line><span class=cl>    <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>tg_send_msg_url</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>send_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incoming_sms_wecom</span><span class=p>(</span><span class=n>msg_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;msgtype&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;text&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>][</span><span class=s1>&#39;content&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>msg_text</span>
</span></span><span class=line><span class=cl>    <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>wecom_send_msg_url</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>send_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incoming_sms_bark</span><span class=p>(</span><span class=n>msg_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>bark_send_msg_url</span> <span class=o>+</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>quote_plus</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                 <span class=s2>&#34;?copy=&#34;</span> <span class=o>+</span> <span class=n>extract_verification_code</span><span class=p>(</span><span class=n>msg_text</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incoming</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>msg_text</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>incoming_sms_wecom</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>incoming_sms_bark</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>incoming_sms_tg</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>incoming</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=installing-the-freepbx-virtual-machine>Installing the FreePBX Virtual Machine<a hidden class=anchor aria-hidden=true href=#installing-the-freepbx-virtual-machine>#</a></h2><p>Download the FreePBX ISO image from the official FreePBX website (it appears to be a CentOS 7 system): <a href=https://www.freepbx.org/downloads/>https://www.freepbx.org/downloads/</a>. Install the system using the image, choosing <code>freepbx 16 with asterisk 18</code> during the installation. After installation, access the virtual machine&rsquo;s IP in a browser and set the initial administrator password (you can temporarily not open the firewall at the beginning for easy configuration).</p><h3 id=adding-an-extension-number>Adding an Extension Number<a hidden class=anchor aria-hidden=true href=#adding-an-extension-number>#</a></h3><p>In Applications - Extensions, click &ldquo;add extension&rdquo; - SIP extension, and add an extension with the number 200 (the number is arbitrary as long as it doesn&rsquo;t clash with the numbers in the Asterisk virtual machine):</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/add-sip-extensions.jpg alt="添加 sip extensions"><figcaption>添加 sip extensions</figcaption></figure></p><p>Keep the rest as default, click &ldquo;submit,&rdquo; and then click the <strong>apply config</strong> button in the upper right corner.</p><h3 id=adding-a-trunk>Adding a Trunk<a hidden class=anchor aria-hidden=true href=#adding-a-trunk>#</a></h3><p>Before adding, first, follow the instructions in the previous post, modify <code>/etc/asterisk/sip.conf</code> in the Asterisk virtual machine, changing the <code>host=192.168.x.x</code> of the bottom 70 extension to the IP of the FreePBX virtual machine, and restart Asterisk.</p><p>In FreePBX, under Connectivity - Trunks, add a SIP Trunk. Configure it as follows, with other settings at default:</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/sip-trunk.jpg alt="Rename outbound CallerID to the number in asterisk VM (70)"><figcaption>Rename outbound CallerID to the number in asterisk VM (70)</figcaption></figure><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/sip-trunk2.jpg alt="Change SIP server to the ip of asterisk VM"><figcaption>Change SIP server to the ip of asterisk VM</figcaption></figure></p><h3 id=routing>Routing<a hidden class=anchor aria-hidden=true href=#routing>#</a></h3><p>In Connectivity - Outbound Routes, create a new route and forward all outbound routes to the SIP trunk created in the previous step:</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/outbound-route.jpg alt=outbound-route><figcaption>outbound-route</figcaption></figure></p><p>In Connectivity - Inbound Routes, create a new route and forward all inbound routes to the extension number set above:</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/inbound-route.jpg alt=inbound-route><figcaption>inbound-route</figcaption></figure></p><p>If you connect multiple extensions or multiple dongles in the future and need to route calls based on the user, you can configure the above DID and CallerID to filter calls in detail.</p><h3 id=testing-calls>Testing Calls<a hidden class=anchor aria-hidden=true href=#testing-calls>#</a></h3><p>Download a free version of <a href=https://www.zoiper.com/en/voip-softphone/download/current>zoiper</a>. When adding an account, enter the username as <code>extension number@FreePBX's IP</code>, and the password as the one set above (make sure you do not enter it incorrectly; FreePBX has fail2ban enabled by default. Entering the SIP password incorrectly will also trigger fail2ban, and you will need to manually delete the iptables rules).</p><p>After confirming registration, try calling 10010 or your own phone via Zoiper to test if voice and DTMF tones are recognized. If an incoming call to the dongle&rsquo;s number comes into FreePBX, it will be directly transferred to the extension, at which point Zoiper will give you a prompt. You can answer the call at that point.</p><h3 id=port-forwarding-sip-push-etc>Port Forwarding, SIP Push, etc.<a hidden class=anchor aria-hidden=true href=#port-forwarding-sip-push-etc>#</a></h3><p>For SIP, in addition to forwarding the default SIP port (5201, you can view this in FreePBX settings under <code>settings - asterisk sip setting</code>), you also need to forward RTP ports. If you only want to forward one port, you can consider using an IAX2 extension, referring to <a href=https://hanako.me/ec20_issabel.html>EC20 Module + Issabel for VoIP - Hanako Blog</a>. For SIP Push (displaying a push notification on your phone when a call is received), currently only <a href=https://www.zoiper.com/en/support/home/article/205/Zoiper%20Push%20Proxy>Zoiper</a> provides a more convenient way to configure it, but it requires payment. Refer to <a href=https://iam.lc/2024/01/how-to-get-rid-of-sim.ping>How to Get Rid of the SIM Card From Your Phone – IAM-LC</a> for details.</p><h2 id=using-the-module-for-internet-access>Using the Module for Internet Access<a hidden class=anchor aria-hidden=true href=#using-the-module-for-internet-access>#</a></h2><p>If the SIM card you&rsquo;re using has a data plan, you can also configure the module for internet access. This ensures that SMS forwarding and calls can continue normally if the machine&rsquo;s wired/wireless network goes down.</p><p>First, after connecting to the serial port, enter <code>AT+QCFG="usbnet",1</code> to set the usbnet mode to <a href=https://lishiwen4.github.io/network/cdc-and-rndis>ECM</a> (1 for ECM, 2 for NDIS, and 3 for RNDIS).</p><p>Then, restart the module using <code>AT+CFUN=1,1</code> and check <code>ip a</code>. You should see an interface similar to <code>enxe2eeabcd123</code>. You can run dhclient directly on this interface to obtain a v4 or v6 address. If you&rsquo;re concerned about the interface name changing frequently, you can refer to <a href=https://unix.stackexchange.com/questions/733080/debian-11-rename-network-interfaces>this question</a> to rename the interface based on the MAC address to something more manageable like <code>quectel-usbX</code>.</p><pre tabindex=0><code>3: quectel-usb0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000
    link/ether ff:ff:ff:ff:ff:ff brd ff:ff:ff:ff:ff:ff
    inet 192.168.225.41/24 brd 192.168.225.255 scope global dynamic quectel-usb0
       valid_lft 28802sec preferred_lft 28802sec
    inet6 2408::/64 scope global dynamic mngtmpaddr 
       valid_lft forever preferred_lft forever
    inet6 fe80::/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><h2 id=misc>Misc<a hidden class=anchor aria-hidden=true href=#misc>#</a></h2><ul><li>When the SIP client is not open (or in background), calls to the dongle will indicate that the user is busy. You need to use the SIP push method mentioned in the previous section or keep the client open to receive calls normally.</li></ul><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li>The EC20 AT command set can be downloaded from <a href=https://www.quectel.com/ProductDownload/EC20.html>https://www.quectel.com/ProductDownload/EC20.html</a>.</li><li>Quectel driver on Asterisk: <a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel/>https://github.com/IchthysMaranatha/asterisk-chan-quectel/</a></li><li><a href=https://gao.md/blog/2014/10/05/sms-gateway-setup-huawei-e1750-asterisk-chan-dongle/>https://gao.md/blog/2014/10/05/sms-gateway-setup-huawei-e1750-asterisk-chan-dongle/</a></li><li><a href=https://iam.lc/2024/01/how-to-get-rid-of-sim.ping>https://iam.lc/2024/01/how-to-get-rid-of-sim.ping</a></li><li><a href=https://forums.quectel.com/t/ec25-e-mini-additional-mbn-files/13473/2>https://forums.quectel.com/t/ec25-e-mini-additional-mbn-files/13473/2</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.sparktour.me/en/tags/tech/>Tech</a></li><li><a href=https://blog.sparktour.me/en/tags/ec20/>Ec20</a></li><li><a href=https://blog.sparktour.me/en/tags/asterisk/>Asterisk</a></li><li><a href=https://blog.sparktour.me/en/tags/freepbx/>Freepbx</a></li><li><a href=https://blog.sparktour.me/en/tags/sip/>Sip</a></li><li><a href=https://blog.sparktour.me/en/tags/volte/>Volte</a></li></ul><nav class=paginav><a class=prev href=https://blog.sparktour.me/en/posts/2022/11/20/configure-esim-me-card-with-pc-sc-reader/><span class=title>« Prev</span><br><span>Configure esim.me SIM Card with PC/SC Smart Card Reader</span>
</a><a class=next href=https://blog.sparktour.me/en/posts/2022/07/18/qinghai-gansu-trip-2022/><span class=title>Next »</span><br><span>Graduation Trip Under the 'Dynamic Zero-COVID Policy' - Qinghai-Gansu Grand Tour</span></a></nav></footer><div class="callout callout-default"><img src=https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg alt="CC BY-NC-SA 4.0" style=width:88px;height:31px><p style=font-size:12px>Licensed Under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></p><p style=font-size:12px>Post Link: <a href=https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/ target=_blank rel=noopener>https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/</a></p></div><script src=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js crossorigin=anonymous></script><div id=disqusjs></div><script>const disqusjs=new DisqusJS({shortname:"sparktour",siteName:"",identifier:"",url:"",title:"",api:"https://disqus.com/api/",apikey:"QhJnXpS5igyHkjYQ91XYC4dSAuEJYAEsHX8hjLrRc1HU9AApOHLrqkwwIp2sKOLk",admin:"",adminLabel:""});disqusjs.render(document.getElementById("disqusjs"))</script></article></main><footer class=footer><span>&copy; 2026 <a href=https://blog.sparktour.me/en/>Sparktour’s Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>