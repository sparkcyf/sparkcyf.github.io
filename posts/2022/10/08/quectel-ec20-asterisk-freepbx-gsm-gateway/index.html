<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用EC20模块配合asterisk及freepbx实现短信转发和网络电话 | Sparktour's Blog</title><meta name=keywords content="tech,ec20,asterisk,freepbx,sip,volte"><meta name=description content="由于内地各种互联网服务与手机强绑定的前提下，每个人手上的手机号码变得越来越多。在互联网上，早已有包括telegram-sms，SMS-forwarder等不同的应用被用来解决不想随身带着某张手机卡，却还需要拿他接收发送短信的场景。不过美中不足的是，由于这些应用均需要安装在手机上，这些短信转发应用均存在因国产android系统严格的后台限制被休眠导致无法转发短信的情况。同时，将带电池的旧手机长期插电也有一些安全隐患（电池鼓包等）。最重要的是，这些短信转发转发软件无法转移呼入和呼出的电话。为了解决上述的这些问题，在本文中，笔者基于EC20和东拼西凑的软件，实现了通过telegram等即时通讯软件收发短信，并通过SIP客户端从互联网呼出和接听电话。


笔者调研的其他方案
多卡宝
一到两年前非常流行的SIM卡托管方案，可以插4张卡，并且同时可待机两张卡，使用自有app转发短信及通话。根据FCCID的PDF，其使用了高通Snapdragon 210处理器，其常见于一些4G老人机上，鉴于此，笔者怀疑多卡宝使用了魔改的android系统。但在2021年下半年，多卡宝疑似因监管原因（可能是被用于电信诈骗？）被国内电商下架，并且因短信语音均需要经过三方服务器，也有一些安全隐患。"><meta name=author content="sparktour"><link rel=canonical href=https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/><link crossorigin=anonymous href=/assets/css/stylesheet.93f625d739f1d6a5c6f20c146bc6a8d26b233492b34b2220c54b12fd46a04ded.css integrity="sha256-k/Yl1znx1qXG8gwUa8ao0msjNJKzSyIgxUsS/UagTe0=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.sparktour.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.sparktour.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.sparktour.me/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.sparktour.me/apple-touch-icon.png><link rel=mask-icon href=https://blog.sparktour.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/><link rel=alternate hreflang=en href=https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://blog.sparktour.me/scss/callout.css><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-6EJ4YX1XZ8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6EJ4YX1XZ8")}</script><meta property="og:url" content="https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/"><meta property="og:site_name" content="Sparktour's Blog"><meta property="og:title" content="使用EC20模块配合asterisk及freepbx实现短信转发和网络电话"><meta property="og:description" content="由于内地各种互联网服务与手机强绑定的前提下，每个人手上的手机号码变得越来越多。在互联网上，早已有包括telegram-sms，SMS-forwarder等不同的应用被用来解决不想随身带着某张手机卡，却还需要拿他接收发送短信的场景。不过美中不足的是，由于这些应用均需要安装在手机上，这些短信转发应用均存在因国产android系统严格的后台限制被休眠导致无法转发短信的情况。同时，将带电池的旧手机长期插电也有一些安全隐患（电池鼓包等）。最重要的是，这些短信转发转发软件无法转移呼入和呼出的电话。为了解决上述的这些问题，在本文中，笔者基于EC20和东拼西凑的软件，实现了通过telegram等即时通讯软件收发短信，并通过SIP客户端从互联网呼出和接听电话。
笔者调研的其他方案 多卡宝 一到两年前非常流行的SIM卡托管方案，可以插4张卡，并且同时可待机两张卡，使用自有app转发短信及通话。根据FCCID的PDF，其使用了高通Snapdragon 210处理器，其常见于一些4G老人机上，鉴于此，笔者怀疑多卡宝使用了魔改的android系统。但在2021年下半年，多卡宝疑似因监管原因（可能是被用于电信诈骗？）被国内电商下架，并且因短信语音均需要经过三方服务器，也有一些安全隐患。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-08T12:00:00+00:00"><meta property="article:modified_time" content="2024-04-14T21:54:57+08:00"><meta property="article:tag" content="Tech"><meta property="article:tag" content="Ec20"><meta property="article:tag" content="Asterisk"><meta property="article:tag" content="Freepbx"><meta property="article:tag" content="Sip"><meta property="article:tag" content="Volte"><meta property="og:image" content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:title content="使用EC20模块配合asterisk及freepbx实现短信转发和网络电话"><meta name=twitter:description content="由于内地各种互联网服务与手机强绑定的前提下，每个人手上的手机号码变得越来越多。在互联网上，早已有包括telegram-sms，SMS-forwarder等不同的应用被用来解决不想随身带着某张手机卡，却还需要拿他接收发送短信的场景。不过美中不足的是，由于这些应用均需要安装在手机上，这些短信转发应用均存在因国产android系统严格的后台限制被休眠导致无法转发短信的情况。同时，将带电池的旧手机长期插电也有一些安全隐患（电池鼓包等）。最重要的是，这些短信转发转发软件无法转移呼入和呼出的电话。为了解决上述的这些问题，在本文中，笔者基于EC20和东拼西凑的软件，实现了通过telegram等即时通讯软件收发短信，并通过SIP客户端从互联网呼出和接听电话。


笔者调研的其他方案
多卡宝
一到两年前非常流行的SIM卡托管方案，可以插4张卡，并且同时可待机两张卡，使用自有app转发短信及通话。根据FCCID的PDF，其使用了高通Snapdragon 210处理器，其常见于一些4G老人机上，鉴于此，笔者怀疑多卡宝使用了魔改的android系统。但在2021年下半年，多卡宝疑似因监管原因（可能是被用于电信诈骗？）被国内电商下架，并且因短信语音均需要经过三方服务器，也有一些安全隐患。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.sparktour.me/posts/"},{"@type":"ListItem","position":2,"name":"使用EC20模块配合asterisk及freepbx实现短信转发和网络电话","item":"https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用EC20模块配合asterisk及freepbx实现短信转发和网络电话","name":"使用EC20模块配合asterisk及freepbx实现短信转发和网络电话","description":"由于内地各种互联网服务与手机强绑定的前提下，每个人手上的手机号码变得越来越多。在互联网上，早已有包括telegram-sms，SMS-forwarder等不同的应用被用来解决不想随身带着某张手机卡，却还需要拿他接收发送短信的场景。不过美中不足的是，由于这些应用均需要安装在手机上，这些短信转发应用均存在因国产android系统严格的后台限制被休眠导致无法转发短信的情况。同时，将带电池的旧手机长期插电也有一些安全隐患（电池鼓包等）。最重要的是，这些短信转发转发软件无法转移呼入和呼出的电话。为了解决上述的这些问题，在本文中，笔者基于EC20和东拼西凑的软件，实现了通过telegram等即时通讯软件收发短信，并通过SIP客户端从互联网呼出和接听电话。\n笔者调研的其他方案 多卡宝 一到两年前非常流行的SIM卡托管方案，可以插4张卡，并且同时可待机两张卡，使用自有app转发短信及通话。根据FCCID的PDF，其使用了高通Snapdragon 210处理器，其常见于一些4G老人机上，鉴于此，笔者怀疑多卡宝使用了魔改的android系统。但在2021年下半年，多卡宝疑似因监管原因（可能是被用于电信诈骗？）被国内电商下架，并且因短信语音均需要经过三方服务器，也有一些安全隐患。\n","keywords":["tech","ec20","asterisk","freepbx","sip","volte"],"articleBody":"由于内地各种互联网服务与手机强绑定的前提下，每个人手上的手机号码变得越来越多。在互联网上，早已有包括telegram-sms，SMS-forwarder等不同的应用被用来解决不想随身带着某张手机卡，却还需要拿他接收发送短信的场景。不过美中不足的是，由于这些应用均需要安装在手机上，这些短信转发应用均存在因国产android系统严格的后台限制被休眠导致无法转发短信的情况。同时，将带电池的旧手机长期插电也有一些安全隐患（电池鼓包等）。最重要的是，这些短信转发转发软件无法转移呼入和呼出的电话。为了解决上述的这些问题，在本文中，笔者基于EC20和东拼西凑的软件，实现了通过telegram等即时通讯软件收发短信，并通过SIP客户端从互联网呼出和接听电话。\n笔者调研的其他方案 多卡宝 一到两年前非常流行的SIM卡托管方案，可以插4张卡，并且同时可待机两张卡，使用自有app转发短信及通话。根据FCCID的PDF，其使用了高通Snapdragon 210处理器，其常见于一些4G老人机上，鉴于此，笔者怀疑多卡宝使用了魔改的android系统。但在2021年下半年，多卡宝疑似因监管原因（可能是被用于电信诈骗？）被国内电商下架，并且因短信语音均需要经过三方服务器，也有一些安全隐患。\nGOIP设备 俗称猫池，设备太贵，笔者负担不起。\n材料及成本 EC20及周边设备 ec20-taobao 移远出品的一款4G卡，支持LTE Cat4，使用Snapdragon X5 LTE Modem，这个卡有很多个版本，有部分版本只带上网功能，不能接打电话和发短信。如果需要收发短信和打电话，请尽量购买最高级的EC20CEFAG-512-SGNS，买mini-pcie接口的 ，移远的淘宝店买大概200一片，闲鱼购买大约50-60一片。\n每张卡还需要另外加大约25元买一张4G模块转接板Mini PCIE转USB的卡座，卡座上有插SIM的地方（卡座一般用的是Mini Sim，如果只有nanosim的话可以去买一个卡套）。在淘宝上搜索「4G模块转接板Mini PCIE转USB」即可。\n除此之外，还需购买若干根IPEX转SMA转接线及SMA接口的4G天线，淘宝上搜相应关键词即可。\n电脑主机 要求不高，一般只要有usb口和有线网口即可，建议安装pve或esxi等虚拟机管理系统。（树莓派不一定行，因为供电不足）。笔者单独去闲鱼上买了一台Optiplex 3050mff，配i3-6100T，8G内存，256G SSD，大概花费了600元。\n配置EC20 确认EC20能够正常读取SIM卡 关闭SIM卡的PIN，插入卡座，把EC20接上天线并通电，此时应该可以在/dev里看到若干个ttyUSB端口：\nttyUSB0 ttyUSB1 PCM语音，GPS信号 ttyUSB2 控制命令 ttyUSB3 使用minicom打开ttyUSB2端口：\nminicom -D /dev/ttyUSB2 # 输入ATI看一下EC20的版本号： ATI Quectel EC20F Revision: EC20CEFAGR06A15M4G 如果一切正常的话，可以先重置一遍EC20，以防上一个用户在卡内设置了错误的配置（但不要经常重置EC20，重置操作对dongle的闪存有损耗）。\n重置模块 at+qprtpara=3 重启 AT+CFUN=1,1 重置并重启完后，可以通过以下命令检查一下SIM卡是否已经注册成功了（下面的例子是联通的，其他运营商同理）：\nAT+COPS? +COPS: 0,0,\"CHN-UNICOM\",7 AT+QNWINFO +QNWINFO: \"FDD LTE\",\"46001\",\"LTE BAND 3\",1650 AT+QENG=\"servingcell\" +QENG: \"servingcell\",\"CONNECT\",\"LTE\",\"FDD\",460,01 配置VoLTE 随着三大运营商开始逐步退网2G及3G，为dongle配置VoLTE也变得十分必要了。以下流程参考了此PDF：\n打开ims AT+QCFG=\"ims\",1 查看dongle内的mbn文件 AT+QMBNCFG=\"List\" +QMBNCFG: \"List\",0,1,1,\"ROW_Generic_3GPP\",0x05010824,201806201 +QMBNCFG: \"List\",1,0,0,\"OpenMkt-Commercial-CU\",0x05011510,201911151 +QMBNCFG: \"List\",2,0,0,\"OpenMkt-Commercial-CT\",0x0501131C,201911141 +QMBNCFG: \"List\",3,0,0,\"Volte_OpenMkt-Commercial-CMCC\",0x05012011,201904261 # 尽管这里列出了移动联通电信的VoLTE配置文件，但使用默认的自动选择CU/CT/CMCC并不能注册VoLTE，在摸索很久之后，笔者发现需要强制选择ROW_Generic_3GPP才能成功注册VoLTE。 关闭自动选择mbn文件 AT+QMBNCFG=\"AutoSel\",0 反激活当前的mbn at+qmbncfg=\"deactivate\" 强制选择3gpp AT+QMBNCFG=\"select\",\"ROW_Generic_3GPP\" 重启 AT+CFUN=1,1 可以再确认一下mbn的选择状态，如果ROW_Generic_3GPP的第二位和第三位都是1的话，说明dongle目前选择了这个配置 AT+QMBNCFG=\"List\" +QMBNCFG: \"List\",0,1,1,\"ROW_Generic_3GPP\",0x05010824,201806201 +QMBNCFG: \"List\",1,0,0,\"OpenMkt-Commercial-CU\",0x05011510,201911151 +QMBNCFG: \"List\",2,0,0,\"OpenMkt-Commercial-CT\",0x0501131C,201911141 +QMBNCFG: \"List\",3,0,0,\"Volte_OpenMkt-Commercial-CMCC\",0x05012011,201904261 重启完后检查ims的状态 AT+QCFG=\"ims\" 如果返回的是 +QCFG: \"ims\",1,1 即为激活，如果是+QCFG: \"ims\",1,0 说明没有激活 可选（激活UAC数字音频） 参考https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/2：\nAT+QCFG=\"usbcfg\",0x2C7C,0x0125,1,1,1,1,1,0,1 这个命令同时也会打开一个adb daemon，可以通过adb shell进到模块自带的一个android系统里。如果发现系统有密码的话（有无密码均不影响后续配置），可以用adb pull把dongle的/etc/passwd拉出来，去掉root的密码之后push回去。\n激活之后可以通过aplay -L查看有没有一个android设备。\ndmix:CARD=Android,DEV=0 Android, USB Audio Direct sample mixing device 安装asterisk虚拟机 freepbx自带的asterisk耦合了很多freepbx相关的配置，令笔者无从下手，同时centos似乎没有办法读取dongle的UAC接口，因此笔者参考quectel channel驱动作者的一篇讨论配置了一个简易的asterisk系统。笔者在这里使用的是Debian11，安装的是包管理器里自带的asterisk 16。安装asterisk之后记得把dongle的USB接口直通进虚拟机。\n安装asterisk和一些依赖 apt update apt install asterisk asterisk-dev adb git autoconf automake libsqlite3-dev build-essential libasound2-dev alsa-utils 下载asterisk-chan-quectel： git clone https://github.com/IchthysMaranatha/asterisk-chan-quectel cd asterisk-chan-quectel ./bootstrap ./configure --with-astversion=16 make make install 随后把uac/quectel.conf复制到/etc/asterisk里。并通过systemctl restart asterisk重启asterisk。\n输入asterisk -rvvv进入asterisk的cli界面并输入quectel show devices即可看到识别到的dongle了，也能看到dongle的imei和SIM卡的imsi：\n# asterisk -rvvv Asterisk 16.16.1~dfsg-1+deb11u1, Copyright (C) 1999 - 2018, Digium, Inc. and others. Created by Mark Spencer Asterisk comes with ABSOLUTELY NO WARRANTY; type 'core show warranty' for details. This is free software, with components licensed under the GNU General Public License version 2 and other licenses; you are welcome to redistribute it under certain conditions. Type 'core show license' for details. ========================================================================= Connected to Asterisk 16.16.1~dfsg-1+deb11u1 currently running on debian-asterisk (pid = 1403) debian-asterisk*CLI\u003e quectel show devices ID Group State RSSI Mode Submode Provider Name Model Firmware IMEI IMSI Number quectel0 0 Free 27 0 0 CHN-UNICOM EC20F EC20CEFAGR06A15M4 86XXXXX 46XXXXX Unknown debian-asterisk*CLI\u003e 配置dialplan 直接参考驱动作者写的帖子，下载帖子里的sipext.zip，解压后放到/etc/asterisk下，同时修改一下/etc/asterisk/extensions.conf（请不要直接照抄！根据自己的实际情况和驱动作者的帖子修改）：\n[incoming-mobile] ;exten =\u003e _.,1,Dial(SIP/70/100) ;same =\u003e n,Hangup() exten =\u003e sms,1,Verbose(Incoming SMS from ${CALLERID(num)} ${BASE64_DECODE(${SMS_BASE64})}) ;store exten =\u003e sms,n,System(echo '${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME} - ${CALLERID(num)}: ${BASE64_DECODE(${SMS_BASE64})}' \u003e\u003e /var/log/asterisk/sms.txt) ;for tg bot use exten =\u003e sms,n,System(echo '${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME} - ${CALLERID(num)}\\n${BASE64_DECODE(${SMS_BASE64})}' \u003e\u003e /var/log/asterisk/unread_sms/${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}-${CALLERID(num)}.txt) exten =\u003e sms,n,Hangup() exten =\u003e ussd,1,Verbose(Incoming USSD: ${BASE64_DECODE(${USSD_BASE64})}) exten =\u003e ussd,n,System(echo '${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME}: ${BASE64_DECODE(${USSD_BASE64})}' \u003e\u003e /var/log/asterisk/ussd.txt) exten =\u003e ussd,n,Hangup() exten =\u003e _.,1,Dial(SIP/70/100) exten =\u003e s,n,Hangup() [Outbound-1001] exten =\u003e _.,1,Dial(Quectel/quectel0/${EXTEN}) same =\u003e n,Hangup() 修改完后再重启一次asterisk。\n测试收发短信 此时可以尝试发个短信给10010，测试一下收发短信：\n发短信（给10010发cxll） asterisk -rx 'quectel sms quectel0 10010 \"cxll\"' 收短信 根据前面的dialplan，收到短信后，asterisk会直接把短信内容写进/var/log/asterisk/sms.txt，类似于这样：\ntail -f /var/log/asterisk/sms.txt 2022-10-01 00:00:00 - quectel0 - 10010: 【权益领取提醒】尊敬的用户，您已获得2个月视频会员体验资格（原价15元/月），腾讯、爱奇艺、优酷、芒果TV、QQ音乐等20款会员每月任选1款，点击 https://u.10010.cn 即可参与(活动规则详见页面说明，限48小时内参与，短信转发无效，已办理请忽略)。如需屏蔽，请在“广东联通”官方公众号内回复“TD”，首次关注可领4GB流量【广东联通】 如果需要进一步转发短信，直接读取这个文件，或者修改dialplan中输出短信的格式即可。\n用Telegram Bot自助收发短信 以下脚本都是用chatgpt写的，笔者用起来暂时没有遇到明显的问题：\n发短信 Systemd service:\n[Unit] Description=Outbound SMS service for TG-SMS Wants=network-online.target After=network-online.target [Service] Type=simple ExecStart=/opt/tg-sms/outbound/.venv/bin/python3 /opt/tg-sms/outbound/outbound-sms.py Restart=on-failure RestartSec=5 User=asterisk [Install] WantedBy=multi-user.target 脚本（需要安装老版本的python-telegram-bot pip install python-telegram-bot==13.15）：\nfrom telegram import Update, ForceReply from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext # We'll use a dictionary to store each user's state. user_data = {} # List of allowed user/group IDs. ALLOWED_IDS = [11111111] def send(update: Update, context: CallbackContext) -\u003e None: if update.message.chat_id not in ALLOWED_IDS: update.message.reply_text('您没有权限使用这个 bot。') return if len(context.args) != 1: update.message.reply_text('请按照以下格式发送命令：/send ') return user_data[update.message.chat_id] = {'phone_number': context.args[0]} update.message.reply_text('请输入您要发送的信息：', reply_markup=ForceReply()) def cancel(update: Update, context: CallbackContext) -\u003e None: user_data.pop(update.message.chat_id, None) update.message.reply_text('操作已取消。') def handle_message(update: Update, context: CallbackContext) -\u003e None: if update.message.chat_id not in user_data: return if 'message' not in user_data[update.message.chat_id]: user_data[update.message.chat_id]['message'] = update.message.text update.message.reply_text('请确认信息：\\n手机号：{}\\n信息：{}'.format(user_data[update.message.chat_id]['phone_number'], user_data[update.message.chat_id]['message']), reply_markup=ForceReply()) else: confirmation = update.message.text if confirmation.lower() == 'yes': import os result = os.popen('asterisk -rx \\'quectel sms quectel0 {} \"{}\"\\''.format(user_data[update.message.chat_id]['phone_number'], user_data[update.message.chat_id]['message'])).read() update.message.reply_text('命令执行结果：\\n{}'.format(result)) else: update.message.reply_text('操作已取消。') user_data.pop(update.message.chat_id, None) def main() -\u003e None: updater = Updater(token='your_token', use_context=True) dispatcher = updater.dispatcher dispatcher.add_handler(CommandHandler(\"send\", send)) dispatcher.add_handler(CommandHandler(\"cancel\", cancel)) dispatcher.add_handler(MessageHandler(Filters.text \u0026 ~Filters.command, handle_message)) updater.start_polling() updater.idle() if __name__ == '__main__': main() 收短信 import requests import sys import urllib.parse import re # extract verify code def extract_verification_code(sms_text): # 定位到“验证码”关键词 keyword_index = sms_text.find('验证码') if keyword_index == -1: return None # 从关键词后开始匹配4-6位的数字 match = re.search(r'(\\d{4,6})', sms_text[keyword_index:]) if match: return match.group(1) return None # tg tg_bot_token = \"\" tg_send_msg_url = \"https://api.telegram.org/bot\"+tg_bot_token+\"/sendMessage\" tg_receive_msg_url = \"https://api.telegram.org/bot\"+tg_bot_token+\"/getUpdates\" # wecom wecom_send_msg_url = \"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key\" bark_send_msg_url = \"https://api.day.app/bark-token/\" def incoming_sms_tg(msg_text): send_body = {} send_body['chat_id'] = '11111111' send_body['text'] = msg_text requests.post(tg_send_msg_url, json=send_body) def incoming_sms_wecom(msg_text): send_body = {} send_body['msgtype'] = 'text' send_body['text'] = {} send_body['text']['content'] = msg_text requests.post(wecom_send_msg_url, json=send_body) def incoming_sms_bark(msg_text): requests.get(bark_send_msg_url + urllib.parse.quote_plus(msg_text) + \"?copy=\" + extract_verification_code(msg_text)) def incoming(): msg_text = sys.argv[1] incoming_sms_wecom(msg_text) incoming_sms_bark(msg_text) incoming_sms_tg(msg_text) incoming() 安装freepbx虚拟机 去freepbx官网上下载freepbx的iso镜像（看起来是一个CentOS7）：https://www.freepbx.org/downloads/。使用镜像安装系统，安装时选择freepbx 16 with asterisk 18。安装完后用浏览器访问虚拟机的IP，设置初始的管理员密码（最开始可以暂不打开防火墙，方便配置）。\n添加分机号 在 Applications-Extensions 里，点击add extension- SIP extension，加一个200的extension（号码随意，只要不和asterisk虚拟机里的号码撞上了就行）：\n添加 sip extensions 剩下部分保持默认，点submit，并点击一下右上角的apply config。\n添加Trunk 添加之前，先按照前面的帖子的指引，修改asterisk虚拟机里的/etc/asterisk/sip.conf，把最底下70分机的host=192.168.x.x改成freepbx虚拟机的IP，重启asterisk。\n在freepbx的Connectivity-Trunks里添加一个SIP Trunk，配置如下，其他默认：\n名字随意，outbound CallerID改成asterisk虚拟机那边设置的数值（70） SIP server要改成asterisk虚拟机的IP 路由 在Connectivity-Outbound Routes里，新建路由，将出方向的路由都转发给前一步创建的SIP trunk：\noutbound-route 在Connectivity-Inbound Routes里，新建路由，将入方向的路由都转发给extensions-上面设置的分机号：\ninbound-route 如果未来连接了多个分机或者多个dongle，需要根据用户进行分流的话，可以详细配置上面的DID和CallerID来进行过滤。\n测试通话 下载一个免费版的zoiper，添加账户的时候用户名输入分机号@freepbx的IP，密码即上面设置的密码（注意不要输错了，freepbx默认有打开fail2ban，输错SIP密码也会触发fail2ban，还需要手动去删除iptables规则）。\n确认注册上了之后可以尝试通过zoiper呼出到10010或者是自己的电话，测试一下语音和按键的DTMF音有被识别到。如果是外部呼入dongle里的号码的电话，呼入到freepbx之后会被直接转移给分机，此时zeoiper会有提示，直接点接听即可。\n端口转发，SIP push等 对于sip，除了需要转发sip的默认端口（5201，可以在freepbx的设置里查看（settings - asterisk sip setting），还需要转发RTP端口。如果只想转发一个端口，可以考虑参考EC20 模块+Issabel 实现网络电话 - Hanako Blog使用IAX2 extension。SIP Push（在接到电话时在手机上弹推送）目前只有zoiper提供了比较方便的配置方式，但需收费，具体可参考 如何把SIM卡从手机中取出 – IAM-LC。\n使用模块上网 如果使用的手机卡包含流量，我们也可以一并配置模块的上网功能，以便在机器的有线/无线网络挂掉后，还能正常的转发短信和通话。\n首先，在连上串口后输入AT+QCFG=\"usbnet\",1，设置usbnet模式为ECM（1是ECM，2是NDIS，3是RNDIS）\n接着，用AT+CFUN=1,1重启一下模块，随后查看ip a，应该能看到一个类似enxe2eeabcd123的接口，在这个接口上直接运行dhclient即可获取v4或v6地址。如果怕interface的名字经常变化，可以参考这个问题，把interface的名字根据MAC地址重命名成quectel-usbX这样方便管理的名字。\n3: quectel-usb0: mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000 link/ether ff:ff:ff:ff:ff:ff brd ff:ff:ff:ff:ff:ff inet 192.168.225.41/24 brd 192.168.225.255 scope global dynamic quectel-usb0 valid_lft 28802sec preferred_lft 28802sec inet6 2408::/64 scope global dynamic mngtmpaddr valid_lft forever preferred_lft forever inet6 fe80::/64 scope link valid_lft forever preferred_lft forever 其他 在不打开SIP客户端时，打到dongle上的电话会提示用户忙，需要使用前一节中提到的sip push的方式，或者保持客户端常开才能正常接到电话。 参考资料 EC20的AT指令集可以在https://www.quectel.com/ProductDownload/EC20.html处下载。 asterisk上的Quectel驱动： https://github.com/IchthysMaranatha/asterisk-chan-quectel/ https://gao.md/blog/2014/10/05/sms-gateway-setup-huawei-e1750-asterisk-chan-dongle/ https://iam.lc/2024/01/how-to-get-rid-of-sim.ping https://forums.quectel.com/t/ec25-e-mini-additional-mbn-files/13473/2 ","wordCount":"5551","inLanguage":"zh","image":"https://assets.sparktour.me/img/blog/misc/about-bg.jpg","datePublished":"2022-10-08T12:00:00Z","dateModified":"2024-04-14T21:54:57+08:00","author":{"@type":"Person","name":"sparktour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/"},"publisher":{"@type":"Organization","name":"Sparktour's Blog","logo":{"@type":"ImageObject","url":"https://blog.sparktour.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.sparktour.me/ accesskey=h title="Sparktour's Blog (Alt + H)">Sparktour's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.sparktour.me/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.sparktour.me/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.sparktour.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.sparktour.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.sparktour.me/about/ title=About><span>About</span></a></li><li><a href=https://blog.sparktour.me/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.sparktour.me/>主页</a>&nbsp;»&nbsp;<a href=https://blog.sparktour.me/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">使用EC20模块配合asterisk及freepbx实现短信转发和网络电话</h1><div class=post-meta><span title='2022-10-08 12:00:00 +0000 UTC'>2022-10-08</span>&nbsp;·&nbsp;<span title='2024-04-14 21:54:57 +0800 +0800'>更新于: 2024-04-14</span>&nbsp;·&nbsp;12 分钟&nbsp;·&nbsp;sparktour&nbsp;|&nbsp;语言:<ul class=i18n_list><li><a href=https://blog.sparktour.me/en/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/>English</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e7%ac%94%e8%80%85%e8%b0%83%e7%a0%94%e7%9a%84%e5%85%b6%e4%bb%96%e6%96%b9%e6%a1%88 aria-label=笔者调研的其他方案>笔者调研的其他方案</a><ul><li><a href=#%e5%a4%9a%e5%8d%a1%e5%ae%9d aria-label=多卡宝>多卡宝</a></li><li><a href=#goip%e8%ae%be%e5%a4%87 aria-label=GOIP设备>GOIP设备</a></li></ul></li><li><a href=#%e6%9d%90%e6%96%99%e5%8f%8a%e6%88%90%e6%9c%ac aria-label=材料及成本>材料及成本</a><ul><li><a href=#ec20%e5%8f%8a%e5%91%a8%e8%be%b9%e8%ae%be%e5%a4%87 aria-label=EC20及周边设备>EC20及周边设备</a></li><li><a href=#%e7%94%b5%e8%84%91%e4%b8%bb%e6%9c%ba aria-label=电脑主机>电脑主机</a></li></ul></li><li><a href=#%e9%85%8d%e7%bd%aeec20 aria-label=配置EC20>配置EC20</a><ul><li><a href=#%e7%a1%ae%e8%ae%a4ec20%e8%83%bd%e5%a4%9f%e6%ad%a3%e5%b8%b8%e8%af%bb%e5%8f%96sim%e5%8d%a1 aria-label=确认EC20能够正常读取SIM卡>确认EC20能够正常读取SIM卡</a></li><li><a href=#%e9%85%8d%e7%bd%aevolte aria-label=配置VoLTE>配置VoLTE</a></li><li><a href=#%e5%8f%af%e9%80%89%e6%bf%80%e6%b4%bbuac%e6%95%b0%e5%ad%97%e9%9f%b3%e9%a2%91 aria-label=可选（激活UAC数字音频）>可选（激活UAC数字音频）</a></li></ul></li><li><a href=#%e5%ae%89%e8%a3%85asterisk%e8%99%9a%e6%8b%9f%e6%9c%ba aria-label=安装asterisk虚拟机>安装asterisk虚拟机</a><ul><li><a href=#%e5%ae%89%e8%a3%85asterisk%e5%92%8c%e4%b8%80%e4%ba%9b%e4%be%9d%e8%b5%96 aria-label=安装asterisk和一些依赖>安装asterisk和一些依赖</a></li><li><a href=#%e4%b8%8b%e8%bd%bdasterisk-chan-quectel aria-label=下载asterisk-chan-quectel：>下载asterisk-chan-quectel：</a></li><li><a href=#%e9%85%8d%e7%bd%aedialplan aria-label=配置dialplan>配置dialplan</a></li><li><a href=#%e6%b5%8b%e8%af%95%e6%94%b6%e5%8f%91%e7%9f%ad%e4%bf%a1 aria-label=测试收发短信>测试收发短信</a><ul><li><a href=#%e5%8f%91%e7%9f%ad%e4%bf%a1%e7%bb%9910010%e5%8f%91cxll aria-label=发短信（给10010发cxll）>发短信（给10010发cxll）</a></li><li><a href=#%e6%94%b6%e7%9f%ad%e4%bf%a1 aria-label=收短信>收短信</a></li></ul></li><li><a href=#%e7%94%a8telegram-bot%e8%87%aa%e5%8a%a9%e6%94%b6%e5%8f%91%e7%9f%ad%e4%bf%a1 aria-label="用Telegram Bot自助收发短信">用Telegram Bot自助收发短信</a></li><li><a href=#%e5%8f%91%e7%9f%ad%e4%bf%a1 aria-label=发短信>发短信</a></li><li><a href=#%e6%94%b6%e7%9f%ad%e4%bf%a1-1 aria-label=收短信>收短信</a></li></ul></li><li><a href=#%e5%ae%89%e8%a3%85freepbx%e8%99%9a%e6%8b%9f%e6%9c%ba aria-label=安装freepbx虚拟机>安装freepbx虚拟机</a><ul><li><a href=#%e6%b7%bb%e5%8a%a0%e5%88%86%e6%9c%ba%e5%8f%b7 aria-label=添加分机号>添加分机号</a></li><li><a href=#%e6%b7%bb%e5%8a%a0trunk aria-label=添加Trunk>添加Trunk</a></li><li><a href=#%e8%b7%af%e7%94%b1 aria-label=路由>路由</a></li><li><a href=#%e6%b5%8b%e8%af%95%e9%80%9a%e8%af%9d aria-label=测试通话>测试通话</a></li><li><a href=#%e7%ab%af%e5%8f%a3%e8%bd%ac%e5%8f%91sip-push%e7%ad%89 aria-label="端口转发，SIP push等">端口转发，SIP push等</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%a8%a1%e5%9d%97%e4%b8%8a%e7%bd%91 aria-label=使用模块上网>使用模块上网</a></li><li><a href=#%e5%85%b6%e4%bb%96 aria-label=其他>其他</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a></li></ul></div></details></div><div class=post-content><p>由于内地各种互联网服务与手机强绑定的前提下，每个人手上的手机号码变得越来越多。在互联网上，早已有包括<a href=https://github.com/telegram-sms/telegram-sms-china>telegram-sms</a>，<a href=https://github.com/pppscn/SmsForwarder>SMS-forwarder</a>等不同的应用被用来解决不想随身带着某张手机卡，却还需要拿他接收发送短信的场景。不过美中不足的是，由于这些应用均需要安装在手机上，这些短信转发应用均存在因国产android系统严格的后台限制被休眠导致无法转发短信的情况。同时，将带电池的旧手机长期插电也有一些安全隐患（电池鼓包等）。最重要的是，这些短信转发转发软件无法转移呼入和呼出的电话。为了解决上述的这些问题，在本文中，笔者基于EC20和东拼西凑的软件，实现了通过telegram等即时通讯软件收发短信，并通过SIP客户端从互联网呼出和接听电话。</p><hr><h2 id=笔者调研的其他方案>笔者调研的其他方案<a hidden class=anchor aria-hidden=true href=#笔者调研的其他方案>#</a></h2><h3 id=多卡宝><a href=https://cn.ucloudlink.com/html/devices-simbox/>多卡宝</a><a hidden class=anchor aria-hidden=true href=#多卡宝>#</a></h3><p>一到两年前非常流行的SIM卡托管方案，可以插4张卡，并且同时可待机两张卡，使用自有app转发短信及通话。根据<a href=https://fccid.io/2AC88-C1-CN/Internal-Photos/Internal-Photos-4057106>FCCID的PDF</a>，其使用了高通<a href=https://www.qualcomm.com/products/application/smartphones/qualcomm-2-series-mobile-platforms/snapdragon-processors-210>Snapdragon 210</a>处理器，其常见于一些4G老人机上，鉴于此，笔者怀疑多卡宝使用了魔改的android系统。但在2021年下半年，多卡宝疑似因监管原因（可能是被用于电信诈骗？）被国内电商下架，并且因短信语音均需要经过三方服务器，也有一些安全隐患。</p><h3 id=goip设备>GOIP设备<a hidden class=anchor aria-hidden=true href=#goip设备>#</a></h3><p>俗称猫池，设备太贵，笔者负担不起。</p><h2 id=材料及成本>材料及成本<a hidden class=anchor aria-hidden=true href=#材料及成本>#</a></h2><h3 id=ec20及周边设备>EC20及周边设备<a hidden class=anchor aria-hidden=true href=#ec20及周边设备>#</a></h3><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/ec20-taobao.jpg alt=ec20-taobao><figcaption>ec20-taobao</figcaption></figure></p><p>移远出品的一款4G卡，支持LTE Cat4，使用<a href=https://www.qualcomm.com/products/technology/modems/snapdragon-modems-4g-lte-x5>Snapdragon X5 LTE Modem</a>，这个卡有很多个版本，有部分版本只带上网功能，不能接打电话和发短信。如果需要收发短信和打电话，请尽量购买最高级的<code>EC20CEFAG-512-SGNS</code>，买mini-pcie接口的 ，移远的淘宝店买大概200一片，闲鱼购买大约50-60一片。</p><p>每张卡还需要另外加大约25元买一张4G模块转接板Mini PCIE转USB的卡座，卡座上有插SIM的地方（卡座一般用的是Mini Sim，如果只有nanosim的话可以去买一个卡套）。在淘宝上搜索「4G模块转接板Mini PCIE转USB」即可。</p><p>除此之外，还需购买若干根IPEX转SMA转接线及SMA接口的4G天线，淘宝上搜相应关键词即可。</p><h3 id=电脑主机>电脑主机<a hidden class=anchor aria-hidden=true href=#电脑主机>#</a></h3><p>要求不高，一般只要有usb口和有线网口即可，建议安装pve或esxi等虚拟机管理系统。（树莓派不一定行，因为<a href="https://github.com/IchthysMaranatha/asterisk-chan-quectel#:~:text=Note%20for%20Pi%20users%3A%20If,of%20the%20waveshare%20sim7600%20dongle.">供电不足</a>）。笔者单独去闲鱼上买了一台Optiplex 3050mff，配i3-6100T，8G内存，256G SSD，大概花费了600元。</p><h2 id=配置ec20>配置EC20<a hidden class=anchor aria-hidden=true href=#配置ec20>#</a></h2><h3 id=确认ec20能够正常读取sim卡>确认EC20能够正常读取SIM卡<a hidden class=anchor aria-hidden=true href=#确认ec20能够正常读取sim卡>#</a></h3><p><strong>关闭SIM卡的PIN</strong>，插入卡座，把EC20接上天线并通电，此时应该可以在<code>/dev</code>里看到若干个ttyUSB端口：</p><pre tabindex=0><code>ttyUSB0
ttyUSB1 PCM语音，GPS信号
ttyUSB2 控制命令
ttyUSB3
</code></pre><p>使用minicom打开ttyUSB2端口：</p><pre tabindex=0><code>minicom -D /dev/ttyUSB2


# 输入ATI看一下EC20的版本号：
ATI
Quectel
EC20F
Revision: EC20CEFAGR06A15M4G
</code></pre><p>如果一切正常的话，可以先重置一遍EC20，以防上一个用户在卡内设置了错误的配置（但不要经常重置EC20，重置操作对dongle的闪存有损耗）。</p><pre tabindex=0><code>重置模块 at+qprtpara=3
重启 AT+CFUN=1,1
</code></pre><p>重置并重启完后，可以通过以下命令检查一下SIM卡是否已经注册成功了（下面的例子是联通的，其他运营商同理）：</p><pre tabindex=0><code>AT+COPS? 
+COPS: 0,0,&#34;CHN-UNICOM&#34;,7

AT+QNWINFO
+QNWINFO: &#34;FDD LTE&#34;,&#34;46001&#34;,&#34;LTE BAND 3&#34;,1650

AT+QENG=&#34;servingcell&#34;
+QENG: &#34;servingcell&#34;,&#34;CONNECT&#34;,&#34;LTE&#34;,&#34;FDD&#34;,460,01
</code></pre><h3 id=配置volte>配置VoLTE<a hidden class=anchor aria-hidden=true href=#配置volte>#</a></h3><p>随着三大运营商开始逐步退网2G及3G，为dongle配置VoLTE也变得十分必要了。以下流程参考了<a href=https://www.quectel.com/wp-content/uploads/2021/09/Quectel_EC2xEG9xEG2x-GEM05_Series_IMS_Application_Note_V1.0.pdf>此PDF</a>：</p><pre tabindex=0><code>打开ims AT+QCFG=&#34;ims&#34;,1

查看dongle内的mbn文件 AT+QMBNCFG=&#34;List&#34;
+QMBNCFG: &#34;List&#34;,0,1,1,&#34;ROW_Generic_3GPP&#34;,0x05010824,201806201
+QMBNCFG: &#34;List&#34;,1,0,0,&#34;OpenMkt-Commercial-CU&#34;,0x05011510,201911151
+QMBNCFG: &#34;List&#34;,2,0,0,&#34;OpenMkt-Commercial-CT&#34;,0x0501131C,201911141
+QMBNCFG: &#34;List&#34;,3,0,0,&#34;Volte_OpenMkt-Commercial-CMCC&#34;,0x05012011,201904261

# 尽管这里列出了移动联通电信的VoLTE配置文件，但使用默认的自动选择CU/CT/CMCC并不能注册VoLTE，在摸索很久之后，笔者发现需要强制选择ROW_Generic_3GPP才能成功注册VoLTE。

关闭自动选择mbn文件 AT+QMBNCFG=&#34;AutoSel&#34;,0
反激活当前的mbn at+qmbncfg=&#34;deactivate&#34;

强制选择3gpp AT+QMBNCFG=&#34;select&#34;,&#34;ROW_Generic_3GPP&#34;
重启 AT+CFUN=1,1

可以再确认一下mbn的选择状态，如果ROW_Generic_3GPP的第二位和第三位都是1的话，说明dongle目前选择了这个配置 AT+QMBNCFG=&#34;List&#34;
+QMBNCFG: &#34;List&#34;,0,1,1,&#34;ROW_Generic_3GPP&#34;,0x05010824,201806201
+QMBNCFG: &#34;List&#34;,1,0,0,&#34;OpenMkt-Commercial-CU&#34;,0x05011510,201911151
+QMBNCFG: &#34;List&#34;,2,0,0,&#34;OpenMkt-Commercial-CT&#34;,0x0501131C,201911141
+QMBNCFG: &#34;List&#34;,3,0,0,&#34;Volte_OpenMkt-Commercial-CMCC&#34;,0x05012011,201904261

重启完后检查ims的状态 AT+QCFG=&#34;ims&#34;

如果返回的是 +QCFG: &#34;ims&#34;,1,1 即为激活，如果是+QCFG: &#34;ims&#34;,1,0 说明没有激活
</code></pre><h3 id=可选激活uac数字音频>可选（激活UAC数字音频）<a hidden class=anchor aria-hidden=true href=#可选激活uac数字音频>#</a></h3><p>参考<a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/2>https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/2</a>：</p><pre tabindex=0><code>AT+QCFG=&#34;usbcfg&#34;,0x2C7C,0x0125,1,1,1,1,1,0,1
</code></pre><p>这个命令同时也会打开一个adb daemon，可以通过adb shell进到模块自带的一个android系统里。如果发现系统有密码的话（有无密码均不影响后续配置），可以用adb pull把dongle的<code>/etc/passwd</code>拉出来，去掉root的密码之后push回去。</p><p>激活之后可以通过<code>aplay -L</code>查看有没有一个android设备。</p><pre tabindex=0><code>dmix:CARD=Android,DEV=0
    Android, USB Audio
    Direct sample mixing device
</code></pre><h2 id=安装asterisk虚拟机>安装asterisk虚拟机<a hidden class=anchor aria-hidden=true href=#安装asterisk虚拟机>#</a></h2><p>freepbx自带的asterisk耦合了很多freepbx相关的配置，令笔者无从下手，同时centos似乎没有办法读取dongle的UAC接口，因此笔者参考quectel channel驱动作者的<a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/13>一篇讨论</a>配置了一个简易的asterisk系统。笔者在这里使用的是Debian11，安装的是包管理器里自带的asterisk 16。<strong>安装asterisk之后记得把dongle的USB接口直通进虚拟机。</strong></p><h3 id=安装asterisk和一些依赖>安装asterisk和一些依赖<a hidden class=anchor aria-hidden=true href=#安装asterisk和一些依赖>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install asterisk asterisk-dev adb git autoconf automake libsqlite3-dev build-essential libasound2-dev alsa-utils
</span></span></code></pre></div><h3 id=下载asterisk-chan-quectel>下载<a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel>asterisk-chan-quectel</a>：<a hidden class=anchor aria-hidden=true href=#下载asterisk-chan-quectel>#</a></h3><pre tabindex=0><code>git clone https://github.com/IchthysMaranatha/asterisk-chan-quectel
cd asterisk-chan-quectel

./bootstrap
./configure --with-astversion=16
make
make install
</code></pre><p>随后把<code>uac/quectel.conf</code>复制到<code>/etc/asterisk</code>里。并通过<code>systemctl restart asterisk</code>重启asterisk。</p><p>输入<code>asterisk -rvvv</code>进入asterisk的cli界面并输入<code>quectel show devices</code>即可看到识别到的dongle了，也能看到dongle的imei和SIM卡的imsi：</p><pre tabindex=0><code># asterisk -rvvv
Asterisk 16.16.1~dfsg-1+deb11u1, Copyright (C) 1999 - 2018, Digium, Inc. and others.
Created by Mark Spencer &lt;markster@digium.com&gt;
Asterisk comes with ABSOLUTELY NO WARRANTY; type &#39;core show warranty&#39; for details.
This is free software, with components licensed under the GNU General Public
License version 2 and other licenses; you are welcome to redistribute it under
certain conditions. Type &#39;core show license&#39; for details.
=========================================================================
Connected to Asterisk 16.16.1~dfsg-1+deb11u1 currently running on debian-asterisk (pid = 1403)
debian-asterisk*CLI&gt; quectel show devices
ID           Group State      RSSI Mode Submode Provider Name  Model      Firmware          IMEI             IMSI             Number        
quectel0     0     Free       27   0    0       CHN-UNICOM     EC20F      EC20CEFAGR06A15M4 86XXXXX  46XXXXX  Unknown       
debian-asterisk*CLI&gt; 
</code></pre><h3 id=配置dialplan>配置dialplan<a hidden class=anchor aria-hidden=true href=#配置dialplan>#</a></h3><p>直接参考驱动作者写的帖子，下载帖子里的<a href="https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/13#:~:text=Download%20attached%20zip%20file%20with%20this%20post%20and%20extract%20sip.conf%20and%20extensions.conf%0Asipext.zip">sipext.zip</a>，解压后放到<code>/etc/asterisk</code>下，同时修改一下<code>/etc/asterisk/extensions.conf</code>（请不要直接照抄！根据自己的实际情况和驱动作者的<a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel/discussions/13>帖子</a>修改）：</p><pre tabindex=0><code>[incoming-mobile]
;exten =&gt; _.,1,Dial(SIP/70/100)
;same =&gt; n,Hangup()
exten =&gt; sms,1,Verbose(Incoming SMS from ${CALLERID(num)} ${BASE64_DECODE(${SMS_BASE64})})
;store
exten =&gt; sms,n,System(echo &#39;${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME} - ${CALLERID(num)}: ${BASE64_DECODE(${SMS_BASE64})}&#39; &gt;&gt; /var/log/asterisk/sms.txt)
;for tg bot use
exten =&gt; sms,n,System(echo &#39;${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME} - ${CALLERID(num)}\n${BASE64_DECODE(${SMS_BASE64})}&#39; &gt;&gt; /var/log/asterisk/unread_sms/${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}-${CALLERID(num)}.txt)
exten =&gt; sms,n,Hangup()

exten =&gt; ussd,1,Verbose(Incoming USSD: ${BASE64_DECODE(${USSD_BASE64})})
exten =&gt; ussd,n,System(echo &#39;${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${QUECTELNAME}: ${BASE64_DECODE(${USSD_BASE64})}&#39; &gt;&gt; /var/log/asterisk/ussd.txt)
exten =&gt; ussd,n,Hangup()

exten =&gt; _.,1,Dial(SIP/70/100)
exten =&gt; s,n,Hangup()


[Outbound-1001]
exten =&gt; _.,1,Dial(Quectel/quectel0/${EXTEN})
same =&gt; n,Hangup()
</code></pre><p>修改完后再重启一次asterisk。</p><h3 id=测试收发短信>测试收发短信<a hidden class=anchor aria-hidden=true href=#测试收发短信>#</a></h3><p>此时可以尝试发个短信给10010，测试一下收发短信：</p><h4 id=发短信给10010发cxll>发短信（给10010发cxll）<a hidden class=anchor aria-hidden=true href=#发短信给10010发cxll>#</a></h4><pre tabindex=0><code>asterisk -rx &#39;quectel sms quectel0 10010 &#34;cxll&#34;&#39;
</code></pre><h4 id=收短信>收短信<a hidden class=anchor aria-hidden=true href=#收短信>#</a></h4><p>根据前面的dialplan，收到短信后，asterisk会直接把短信内容写进<code>/var/log/asterisk/sms.txt</code>，类似于这样：</p><pre tabindex=0><code>tail -f /var/log/asterisk/sms.txt

2022-10-01 00:00:00 - quectel0 - 10010: 【权益领取提醒】尊敬的用户，您已获得2个月视频会员体验资格（原价15元/月），腾讯、爱奇艺、优酷、芒果TV、QQ音乐等20款会员每月任选1款，点击 https://u.10010.cn 即可参与(活动规则详见页面说明，限48小时内参与，短信转发无效，已办理请忽略)。如需屏蔽，请在“广东联通”官方公众号内回复“TD”，首次关注可领4GB流量【广东联通】
</code></pre><p>如果需要进一步转发短信，直接读取这个文件，或者修改dialplan中输出短信的格式即可。</p><h3 id=用telegram-bot自助收发短信>用Telegram Bot自助收发短信<a hidden class=anchor aria-hidden=true href=#用telegram-bot自助收发短信>#</a></h3><p><em>以下脚本都是用chatgpt写的，笔者用起来暂时没有遇到明显的问题：</em></p><h3 id=发短信>发短信<a hidden class=anchor aria-hidden=true href=#发短信>#</a></h3><p>Systemd service:</p><pre tabindex=0><code>[Unit]
Description=Outbound SMS service for TG-SMS
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
ExecStart=/opt/tg-sms/outbound/.venv/bin/python3 /opt/tg-sms/outbound/outbound-sms.py
Restart=on-failure
RestartSec=5
User=asterisk

[Install]
WantedBy=multi-user.target
</code></pre><p>脚本（需要安装老版本的python-telegram-bot <code>pip install python-telegram-bot==13.15</code>）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>telegram</span> <span class=kn>import</span> <span class=n>Update</span><span class=p>,</span> <span class=n>ForceReply</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>telegram.ext</span> <span class=kn>import</span> <span class=n>Updater</span><span class=p>,</span> <span class=n>CommandHandler</span><span class=p>,</span> <span class=n>MessageHandler</span><span class=p>,</span> <span class=n>Filters</span><span class=p>,</span> <span class=n>CallbackContext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># We&#39;ll use a dictionary to store each user&#39;s state.</span>
</span></span><span class=line><span class=cl><span class=n>user_data</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># List of allowed user/group IDs.</span>
</span></span><span class=line><span class=cl><span class=n>ALLOWED_IDS</span> <span class=o>=</span> <span class=p>[</span><span class=mi>11111111</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>(</span><span class=n>update</span><span class=p>:</span> <span class=n>Update</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>CallbackContext</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ALLOWED_IDS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;您没有权限使用这个 bot。&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;请按照以下格式发送命令：/send &lt;phone_number&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;phone_number&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;请输入您要发送的信息：&#39;</span><span class=p>,</span> <span class=n>reply_markup</span><span class=o>=</span><span class=n>ForceReply</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cancel</span><span class=p>(</span><span class=n>update</span><span class=p>:</span> <span class=n>Update</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>CallbackContext</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>user_data</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;操作已取消。&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_message</span><span class=p>(</span><span class=n>update</span><span class=p>:</span> <span class=n>Update</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>CallbackContext</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;message&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;message&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;请确认信息：</span><span class=se>\n</span><span class=s1>手机号：</span><span class=si>{}</span><span class=se>\n</span><span class=s1>信息：</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;phone_number&#39;</span><span class=p>],</span> <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;message&#39;</span><span class=p>]),</span> <span class=n>reply_markup</span><span class=o>=</span><span class=n>ForceReply</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>confirmation</span> <span class=o>=</span> <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>confirmation</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;yes&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>popen</span><span class=p>(</span><span class=s1>&#39;asterisk -rx </span><span class=se>\&#39;</span><span class=s1>quectel sms quectel0 </span><span class=si>{}</span><span class=s1> &#34;</span><span class=si>{}</span><span class=s1>&#34;</span><span class=se>\&#39;</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;phone_number&#39;</span><span class=p>],</span> <span class=n>user_data</span><span class=p>[</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>][</span><span class=s1>&#39;message&#39;</span><span class=p>]))</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;命令执行结果：</span><span class=se>\n</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>reply_text</span><span class=p>(</span><span class=s1>&#39;操作已取消。&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>user_data</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>update</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>chat_id</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>updater</span> <span class=o>=</span> <span class=n>Updater</span><span class=p>(</span><span class=n>token</span><span class=o>=</span><span class=s1>&#39;your_token&#39;</span><span class=p>,</span> <span class=n>use_context</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dispatcher</span> <span class=o>=</span> <span class=n>updater</span><span class=o>.</span><span class=n>dispatcher</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dispatcher</span><span class=o>.</span><span class=n>add_handler</span><span class=p>(</span><span class=n>CommandHandler</span><span class=p>(</span><span class=s2>&#34;send&#34;</span><span class=p>,</span> <span class=n>send</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>dispatcher</span><span class=o>.</span><span class=n>add_handler</span><span class=p>(</span><span class=n>CommandHandler</span><span class=p>(</span><span class=s2>&#34;cancel&#34;</span><span class=p>,</span> <span class=n>cancel</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>dispatcher</span><span class=o>.</span><span class=n>add_handler</span><span class=p>(</span><span class=n>MessageHandler</span><span class=p>(</span><span class=n>Filters</span><span class=o>.</span><span class=n>text</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>Filters</span><span class=o>.</span><span class=n>command</span><span class=p>,</span> <span class=n>handle_message</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>updater</span><span class=o>.</span><span class=n>start_polling</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>updater</span><span class=o>.</span><span class=n>idle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=收短信-1>收短信<a hidden class=anchor aria-hidden=true href=#收短信-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># extract verify code</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_verification_code</span><span class=p>(</span><span class=n>sms_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 定位到“验证码”关键词</span>
</span></span><span class=line><span class=cl>    <span class=n>keyword_index</span> <span class=o>=</span> <span class=n>sms_text</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;验证码&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>keyword_index</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 从关键词后开始匹配4-6位的数字</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;(\d{4,6})&#39;</span><span class=p>,</span> <span class=n>sms_text</span><span class=p>[</span><span class=n>keyword_index</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># tg</span>
</span></span><span class=line><span class=cl><span class=n>tg_bot_token</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tg_send_msg_url</span> <span class=o>=</span> <span class=s2>&#34;https://api.telegram.org/bot&#34;</span><span class=o>+</span><span class=n>tg_bot_token</span><span class=o>+</span><span class=s2>&#34;/sendMessage&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tg_receive_msg_url</span> <span class=o>=</span> <span class=s2>&#34;https://api.telegram.org/bot&#34;</span><span class=o>+</span><span class=n>tg_bot_token</span><span class=o>+</span><span class=s2>&#34;/getUpdates&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># wecom</span>
</span></span><span class=line><span class=cl><span class=n>wecom_send_msg_url</span> <span class=o>=</span> <span class=s2>&#34;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key&#34;</span>
</span></span><span class=line><span class=cl><span class=n>bark_send_msg_url</span> <span class=o>=</span> <span class=s2>&#34;https://api.day.app/bark-token/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incoming_sms_tg</span><span class=p>(</span><span class=n>msg_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;chat_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;11111111&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>msg_text</span>
</span></span><span class=line><span class=cl>    <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>tg_send_msg_url</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>send_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incoming_sms_wecom</span><span class=p>(</span><span class=n>msg_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;msgtype&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;text&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>send_body</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>][</span><span class=s1>&#39;content&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>msg_text</span>
</span></span><span class=line><span class=cl>    <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>wecom_send_msg_url</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>send_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incoming_sms_bark</span><span class=p>(</span><span class=n>msg_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>bark_send_msg_url</span> <span class=o>+</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>quote_plus</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                 <span class=s2>&#34;?copy=&#34;</span> <span class=o>+</span> <span class=n>extract_verification_code</span><span class=p>(</span><span class=n>msg_text</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incoming</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>msg_text</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>incoming_sms_wecom</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>incoming_sms_bark</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>incoming_sms_tg</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>incoming</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=安装freepbx虚拟机>安装freepbx虚拟机<a hidden class=anchor aria-hidden=true href=#安装freepbx虚拟机>#</a></h2><p>去freepbx官网上下载freepbx的iso镜像（看起来是一个CentOS7）：https://www.freepbx.org/downloads/。使用镜像安装系统，安装时选择<code>freepbx 16 with asterisk 18</code>。安装完后用浏览器访问虚拟机的IP，设置初始的管理员密码（最开始可以暂不打开防火墙，方便配置）。</p><h3 id=添加分机号>添加分机号<a hidden class=anchor aria-hidden=true href=#添加分机号>#</a></h3><p>在 Applications-Extensions 里，点击add extension- SIP extension，加一个200的extension（号码随意，只要不和asterisk虚拟机里的号码撞上了就行）：</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/add-sip-extensions.jpg alt="添加 sip extensions"><figcaption>添加 sip extensions</figcaption></figure></p><p>剩下部分保持默认，点submit，并点击一下右上角的<strong>apply config</strong>。</p><h3 id=添加trunk>添加Trunk<a hidden class=anchor aria-hidden=true href=#添加trunk>#</a></h3><p>添加之前，先按照前面的帖子的指引，修改asterisk虚拟机里的<code>/etc/asterisk/sip.conf</code>，把最底下70分机的<code>host=192.168.x.x</code>改成freepbx虚拟机的IP，重启asterisk。</p><p>在freepbx的Connectivity-Trunks里添加一个SIP Trunk，配置如下，其他默认：</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/sip-trunk.jpg alt="名字随意，outbound CallerID改成asterisk虚拟机那边设置的数值（70）"><figcaption>名字随意，outbound CallerID改成asterisk虚拟机那边设置的数值（70）</figcaption></figure><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/sip-trunk2.jpg alt="SIP server要改成asterisk虚拟机的IP"><figcaption>SIP server要改成asterisk虚拟机的IP</figcaption></figure></p><h3 id=路由>路由<a hidden class=anchor aria-hidden=true href=#路由>#</a></h3><p>在Connectivity-Outbound Routes里，新建路由，将出方向的路由都转发给前一步创建的SIP trunk：</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/outbound-route.jpg alt=outbound-route><figcaption>outbound-route</figcaption></figure></p><p>在Connectivity-Inbound Routes里，新建路由，将入方向的路由都转发给extensions-上面设置的分机号：</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/quectel-ec20-asterisk-freepbx-gsm-gateway/inbound-route.jpg alt=inbound-route><figcaption>inbound-route</figcaption></figure></p><p>如果未来连接了多个分机或者多个dongle，需要根据用户进行分流的话，可以详细配置上面的DID和CallerID来进行过滤。</p><h3 id=测试通话>测试通话<a hidden class=anchor aria-hidden=true href=#测试通话>#</a></h3><p>下载一个免费版的<a href=https://www.zoiper.com/en/voip-softphone/download/current>zoiper</a>，添加账户的时候用户名输入<code>分机号@freepbx的IP</code>，密码即上面设置的密码（注意不要输错了，freepbx默认有打开fail2ban，输错SIP密码也会触发fail2ban，还需要手动去删除iptables规则）。</p><p>确认注册上了之后可以尝试通过zoiper呼出到10010或者是自己的电话，测试一下语音和按键的DTMF音有被识别到。如果是外部呼入dongle里的号码的电话，呼入到freepbx之后会被直接转移给分机，此时zeoiper会有提示，直接点接听即可。</p><h3 id=端口转发sip-push等>端口转发，SIP push等<a hidden class=anchor aria-hidden=true href=#端口转发sip-push等>#</a></h3><p>对于sip，除了需要转发sip的默认端口（5201，可以在freepbx的设置里查看（<code>settings - asterisk sip setting</code>），还需要转发RTP端口。如果只想转发一个端口，可以考虑参考<a href=https://hanako.me/ec20_issabel.html>EC20 模块+Issabel 实现网络电话 - Hanako Blog</a>使用IAX2 extension。SIP Push（在接到电话时在手机上弹推送）目前只有<a href=https://www.zoiper.com/en/support/home/article/205/Zoiper%20Push%20Proxy>zoiper</a>提供了比较方便的配置方式，但需收费，具体可参考 <a href=https://iam.lc/2024/01/how-to-get-rid-of-sim.ping>如何把SIM卡从手机中取出 – IAM-LC</a>。</p><h2 id=使用模块上网>使用模块上网<a hidden class=anchor aria-hidden=true href=#使用模块上网>#</a></h2><p>如果使用的手机卡包含流量，我们也可以一并配置模块的上网功能，以便在机器的有线/无线网络挂掉后，还能正常的转发短信和通话。</p><p>首先，在连上串口后输入<code>AT+QCFG="usbnet",1</code>，设置usbnet模式为<a href=https://lishiwen4.github.io/network/cdc-and-rndis>ECM</a>（1是ECM，2是NDIS，3是RNDIS）</p><p>接着，用<code>AT+CFUN=1,1</code>重启一下模块，随后查看<code>ip a</code>，应该能看到一个类似<code>enxe2eeabcd123</code>的接口，在这个接口上直接运行dhclient即可获取v4或v6地址。如果怕interface的名字经常变化，可以参考<a href=https://unix.stackexchange.com/questions/733080/debian-11-rename-network-interfaces>这个问题</a>，把interface的名字根据MAC地址重命名成<code>quectel-usbX</code>这样方便管理的名字。</p><pre tabindex=0><code>3: quectel-usb0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000
    link/ether ff:ff:ff:ff:ff:ff brd ff:ff:ff:ff:ff:ff
    inet 192.168.225.41/24 brd 192.168.225.255 scope global dynamic quectel-usb0
       valid_lft 28802sec preferred_lft 28802sec
    inet6 2408::/64 scope global dynamic mngtmpaddr 
       valid_lft forever preferred_lft forever
    inet6 fe80::/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><h2 id=其他>其他<a hidden class=anchor aria-hidden=true href=#其他>#</a></h2><ul><li>在不打开SIP客户端时，打到dongle上的电话会提示用户忙，需要使用前一节中提到的sip push的方式，或者保持客户端常开才能正常接到电话。</li></ul><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2><ul><li>EC20的AT指令集可以在<a href=https://www.quectel.com/ProductDownload/EC20.html>https://www.quectel.com/ProductDownload/EC20.html</a>处下载。</li><li>asterisk上的Quectel驱动： <a href=https://github.com/IchthysMaranatha/asterisk-chan-quectel/>https://github.com/IchthysMaranatha/asterisk-chan-quectel/</a></li><li><a href=https://gao.md/blog/2014/10/05/sms-gateway-setup-huawei-e1750-asterisk-chan-dongle/>https://gao.md/blog/2014/10/05/sms-gateway-setup-huawei-e1750-asterisk-chan-dongle/</a></li><li><a href=https://iam.lc/2024/01/how-to-get-rid-of-sim.ping>https://iam.lc/2024/01/how-to-get-rid-of-sim.ping</a></li><li><a href=https://forums.quectel.com/t/ec25-e-mini-additional-mbn-files/13473/2>https://forums.quectel.com/t/ec25-e-mini-additional-mbn-files/13473/2</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.sparktour.me/tags/tech/>Tech</a></li><li><a href=https://blog.sparktour.me/tags/ec20/>Ec20</a></li><li><a href=https://blog.sparktour.me/tags/asterisk/>Asterisk</a></li><li><a href=https://blog.sparktour.me/tags/freepbx/>Freepbx</a></li><li><a href=https://blog.sparktour.me/tags/sip/>Sip</a></li><li><a href=https://blog.sparktour.me/tags/volte/>Volte</a></li></ul><nav class=paginav><a class=prev href=https://blog.sparktour.me/posts/2022/10/14/voip-fxo-via-asterisk-freepbx-dahdi/><span class=title>« 上一页</span><br><span>使用FXO卡配合asterisk及freepbx将固定电话信号转为VoIP</span>
</a><a class=next href=https://blog.sparktour.me/posts/2022/09/18/openwrt-mikrotik-layer2-network-with-ipip-and-eoip-tunnel/><span class=title>下一页 »</span><br><span>Openwrt 和 MikroTik RouterOS 路由器通过 IPIP/EOIP 进行二层组网</span></a></nav></footer><div class="callout callout-default"><img src=https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg alt="CC BY-NC-SA 4.0" style=width:88px;height:31px><p style=font-size:12px>Licensed Under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></p><p style=font-size:12px>Post Link: <a href=https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/ target=_blank rel=noopener>https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/</a></p></div><script src=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js crossorigin=anonymous></script><div id=disqusjs></div><script>const disqusjs=new DisqusJS({shortname:"sparktour",siteName:"",identifier:"",url:"",title:"",api:"https://disqus.com/api/",apikey:"QhJnXpS5igyHkjYQ91XYC4dSAuEJYAEsHX8hjLrRc1HU9AApOHLrqkwwIp2sKOLk",admin:"",adminLabel:""});disqusjs.render(document.getElementById("disqusjs"))</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.sparktour.me/>Sparktour's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>