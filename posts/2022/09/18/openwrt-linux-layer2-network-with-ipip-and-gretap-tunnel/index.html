<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Openwrt 和通用Linux设备通过 IPIP/GRETAP 进行二层组网 | Sparktour's Blog</title><meta name=keywords content="tech,openwrt,gre,ipip,gretap"><meta name=description content="在前一篇文章中，笔者尝试了用Openwrt和RouterOS配合IPIP和EoIP隧道进行二层组网。但由于Openwrt的EoIP包是一个用户态的包，AX6s转发EoIP流量的性能并不是特别好（有线500Mbps，无线300Mbps），同时RouterOS也是一个收费系统，并不是所有人都会只为了组网来购买RouterOS的授权。鉴于此，笔者也在下文提供一种将IPoE替换为GRETAP协议进行二层组网的方案，此方案仅需一台运行于实验室内网的通用Linux设备即可（本文使用的是Debian11）。


GRETAP？
相比于GRE，GRETAP是类似EoIP的二层协议，因此我们同样可以将其用于二层组网。但很可惜RouterOS不支持GRETAP（怀疑是为了推广自家的EoIP协议），因此笔者只能使用另一台Linux设备和Openwrt路由器进行组网了。
网络结构
此处依然简要列出一下代配置的网络结构："><meta name=author content="sparktour"><link rel=canonical href=https://blog.sparktour.me/posts/2022/09/18/openwrt-linux-layer2-network-with-ipip-and-gretap-tunnel/><link crossorigin=anonymous href=/assets/css/stylesheet.93f625d739f1d6a5c6f20c146bc6a8d26b233492b34b2220c54b12fd46a04ded.css integrity="sha256-k/Yl1znx1qXG8gwUa8ao0msjNJKzSyIgxUsS/UagTe0=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.sparktour.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.sparktour.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.sparktour.me/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.sparktour.me/apple-touch-icon.png><link rel=mask-icon href=https://blog.sparktour.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.sparktour.me/posts/2022/09/18/openwrt-linux-layer2-network-with-ipip-and-gretap-tunnel/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://blog.sparktour.me/scss/callout.css><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-6EJ4YX1XZ8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6EJ4YX1XZ8")}</script><meta property="og:url" content="https://blog.sparktour.me/posts/2022/09/18/openwrt-linux-layer2-network-with-ipip-and-gretap-tunnel/"><meta property="og:site_name" content="Sparktour's Blog"><meta property="og:title" content="Openwrt 和通用Linux设备通过 IPIP/GRETAP 进行二层组网"><meta property="og:description" content="在前一篇文章中，笔者尝试了用Openwrt和RouterOS配合IPIP和EoIP隧道进行二层组网。但由于Openwrt的EoIP包是一个用户态的包，AX6s转发EoIP流量的性能并不是特别好（有线500Mbps，无线300Mbps），同时RouterOS也是一个收费系统，并不是所有人都会只为了组网来购买RouterOS的授权。鉴于此，笔者也在下文提供一种将IPoE替换为GRETAP协议进行二层组网的方案，此方案仅需一台运行于实验室内网的通用Linux设备即可（本文使用的是Debian11）。
GRETAP？ 相比于GRE，GRETAP是类似EoIP的二层协议，因此我们同样可以将其用于二层组网。但很可惜RouterOS不支持GRETAP（怀疑是为了推广自家的EoIP协议），因此笔者只能使用另一台Linux设备和Openwrt路由器进行组网了。
网络结构 此处依然简要列出一下代配置的网络结构："><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-18T12:00:00+00:00"><meta property="article:modified_time" content="2024-04-19T09:59:44+08:00"><meta property="article:tag" content="Tech"><meta property="article:tag" content="Openwrt"><meta property="article:tag" content="Gre"><meta property="article:tag" content="Ipip"><meta property="article:tag" content="Gretap"><meta property="og:image" content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:title content="Openwrt 和通用Linux设备通过 IPIP/GRETAP 进行二层组网"><meta name=twitter:description content="在前一篇文章中，笔者尝试了用Openwrt和RouterOS配合IPIP和EoIP隧道进行二层组网。但由于Openwrt的EoIP包是一个用户态的包，AX6s转发EoIP流量的性能并不是特别好（有线500Mbps，无线300Mbps），同时RouterOS也是一个收费系统，并不是所有人都会只为了组网来购买RouterOS的授权。鉴于此，笔者也在下文提供一种将IPoE替换为GRETAP协议进行二层组网的方案，此方案仅需一台运行于实验室内网的通用Linux设备即可（本文使用的是Debian11）。


GRETAP？
相比于GRE，GRETAP是类似EoIP的二层协议，因此我们同样可以将其用于二层组网。但很可惜RouterOS不支持GRETAP（怀疑是为了推广自家的EoIP协议），因此笔者只能使用另一台Linux设备和Openwrt路由器进行组网了。
网络结构
此处依然简要列出一下代配置的网络结构："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.sparktour.me/posts/"},{"@type":"ListItem","position":2,"name":"Openwrt 和通用Linux设备通过 IPIP/GRETAP 进行二层组网","item":"https://blog.sparktour.me/posts/2022/09/18/openwrt-linux-layer2-network-with-ipip-and-gretap-tunnel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Openwrt 和通用Linux设备通过 IPIP/GRETAP 进行二层组网","name":"Openwrt 和通用Linux设备通过 IPIP\/GRETAP 进行二层组网","description":"在前一篇文章中，笔者尝试了用Openwrt和RouterOS配合IPIP和EoIP隧道进行二层组网。但由于Openwrt的EoIP包是一个用户态的包，AX6s转发EoIP流量的性能并不是特别好（有线500Mbps，无线300Mbps），同时RouterOS也是一个收费系统，并不是所有人都会只为了组网来购买RouterOS的授权。鉴于此，笔者也在下文提供一种将IPoE替换为GRETAP协议进行二层组网的方案，此方案仅需一台运行于实验室内网的通用Linux设备即可（本文使用的是Debian11）。\nGRETAP？ 相比于GRE，GRETAP是类似EoIP的二层协议，因此我们同样可以将其用于二层组网。但很可惜RouterOS不支持GRETAP（怀疑是为了推广自家的EoIP协议），因此笔者只能使用另一台Linux设备和Openwrt路由器进行组网了。\n网络结构 此处依然简要列出一下代配置的网络结构：\n","keywords":["tech","openwrt","gre","ipip","gretap"],"articleBody":"在前一篇文章中，笔者尝试了用Openwrt和RouterOS配合IPIP和EoIP隧道进行二层组网。但由于Openwrt的EoIP包是一个用户态的包，AX6s转发EoIP流量的性能并不是特别好（有线500Mbps，无线300Mbps），同时RouterOS也是一个收费系统，并不是所有人都会只为了组网来购买RouterOS的授权。鉴于此，笔者也在下文提供一种将IPoE替换为GRETAP协议进行二层组网的方案，此方案仅需一台运行于实验室内网的通用Linux设备即可（本文使用的是Debian11）。\nGRETAP？ 相比于GRE，GRETAP是类似EoIP的二层协议，因此我们同样可以将其用于二层组网。但很可惜RouterOS不支持GRETAP（怀疑是为了推广自家的EoIP协议），因此笔者只能使用另一台Linux设备和Openwrt路由器进行组网了。\n网络结构 此处依然简要列出一下代配置的网络结构：\n实验室路由器：ikuai，向实验室内设备分配192.168.102.0/24的IP。\n安装在实验室的Debian服务器：Debian 11，有两个网络接口，接口ens192获取校园网IP 10.20.1.1；接口ens224连接ikuai，配置前暂不分配IP。\n安装在宿舍的Openwrt路由器：Openwrt 22.03.0，WAN口分配10.20.1.2的校园网IP。\n配置IPIP隧道 由于学校内网封锁GRE协议，因此配置的第一步依然是在两侧设置用于承载GRETAP数据的的IPIP隧道。\nDebian 侧 启用IPv4转发：\necho 'net.ipv4.ip_forward=1' \u003e\u003e /etc/sysctl.conf sysctl -p 安装ipip和桥接包：\napt install ipip bridge-utils 添加隧道：\n# 启用内核模块 modprobe ip_gre modprobe ipip # 添加隧道 ip tunnel add ipip2 local 10.20.2.223 remote 10.16.212.255 ip link set ipip2 up ip addr add 6.0.0.1/24 dev ipip2 Openwrt 侧 先安装IPIP相关的包：\nopkg update opkg install luci-proto-ipip 重启路由器，随后添加IPIP interface：\nNetwork \u003e Interface \u003e Add new interface... name: ipip1 protocal: IPv4-in-IPv4 (RFC2003) Remote IPv4 address or FQDN: 10.20.1.1 Local IPv4 address: 10.20.1.2 Bind interface: wan 同时也需要在Advanced Settings里去掉Use Default Gateway的选项。 给IPIP的interface分配一个静态IP：\nNetwork \u003e Interface \u003e Add new interface... name: ipip1static protocal: Static Device: ipip-ipip0 IPv4 address: 6.0.0.2/24 IPv4 gateway: 6.0.0.1 同时也需要在Advanced Settings里去掉Use Default Gateway的选项。 RouterOS和Openwrt一侧都配置好IPIP隧道后，可以互相ping一下对方的隧道IP （6.0.0.1， 6.0.0.2）来检查一下隧道是否通了。\n添加GRETAP隧道并桥接上级网口 Debian 侧 添加隧道：\n# gretap tunnel # 如果不添加IPIP隧道，可以将remote和local的ip根据实际情况修改 ip link add name gretap1 type gretap remote 6.0.0.2 local 6.0.0.1 # mtu请根据实际情况设置 ip link set gretap1 up mtu 1420 桥接配置：\n# bridge ip link add grebr0 type bridge ip link set ens224 master grebr0 ip link set gretap1 master grebr0 ip link set grebr0 up 不过笔者在配置时发现，按照上述配置拉起网桥后，GRETAP另一侧的Openwrt似乎无法收到ikuai发回的DHCP offer包，但在ens224端口上执行dhclient -i ens224 -4 -v后莫名其妙的解决了该问题。\nOpenwrt 侧 安装GRE相关的包并重启：\nopkg update opkg install luci-proto-gre ip-full 添加GRETAP interface：\nNetwork \u003e Interface \u003e Add new interface... name: gretap1 protocal: GRETAP Tunnel over IPv4 Remote IPv4 address or FQDN: 6.0.0.1 Local IPv4 address: 6.0.0.2 同时也需要在Advanced Settings里去掉Use Default Gateway的选项。 Debian 侧配置隧道开机自启 如要让Debian一侧的IPIP和GRETAP隧道开机自启，可以用systemd在开机时运行以下脚本：\n/root/gretap-spark.sh：\n#modprobe modprobe ip_gre modprobe ipip #ipip tunnel ip tunnel add ipip2 local 10.20.2.223 remote 10.16.212.255 ip link set ipip2 up ip addr add 6.0.0.1/24 dev ipip2 # gretap tunnel ip link add name gretap1 type gretap remote 6.0.0.2 local 6.0.0.1 ip link set gretap1 up mtu 1420 # bridge ip link add grebr0 type bridge ip link set ens224 master grebr0 ip link set gretap1 master grebr0 ip link set grebr0 up dhclient -i ens224 -4 /lib/systemd/system/gre-and-ipip-tunnel.service：\n[Unit] Description=bring up gretap tunnel After=network-online.target [Service] Type=simple User=root ExecStartPre=/bin/sh -c 'until ping -c1 1.2.4.8; do sleep 1; done;' ExecStart=/bin/bash /root/gretap-spark.sh [Install] WantedBy=multi-user.target 通过隧道分配IP IPv4 在Openwrt上新建一个interface，名字叫dhcpgretap4，Protocal选择dhcp client，Device选择gre4t-gretap1（默认可能不提供这个选项，可能需要在最下面手动输入），并勾选Use default gateway，防火墙划分到WAN区。\n如果不特别配置的话，隧道接口的MAC地址每次重启都会变化（这是由于gretap这个接口没办法固定mac导致的），openwrt似乎没发直接固定这个地址。变通的方案可以在network - device界面创建一个bridge（如grebr），然后给bridge配置v6地址，再将前面dhcpgretap4的Device指定到grebr上，此时dhcpgretap4的MAC就被固定成那个bridge的地址了。 IPv6 把WAN6的接口改为gre4t-gretap1（可能也需要手动输入）即可。\n全部配置完成后，dhcpipip4和wan6的interface理论上均能取得上级路由器（ikuai）分配的IP。\n性能 有线下iperf3测速可达800Mbps，无线下可达500Mbps。速度相比EoIP协议的内层隧道已有明显改善。\n参考资料 https://forum.openwrt.org/t/howto-l2-trunk-over-wifi-with-gretap/75689 https://david-waiting.medium.com/a-beginners-guide-to-generic-routing-encapsulation-fb2b4fb63abb ","wordCount":"2043","inLanguage":"zh","image":"https://assets.sparktour.me/img/blog/misc/about-bg.jpg","datePublished":"2022-09-18T12:00:00Z","dateModified":"2024-04-19T09:59:44+08:00","author":{"@type":"Person","name":"sparktour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sparktour.me/posts/2022/09/18/openwrt-linux-layer2-network-with-ipip-and-gretap-tunnel/"},"publisher":{"@type":"Organization","name":"Sparktour's Blog","logo":{"@type":"ImageObject","url":"https://blog.sparktour.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.sparktour.me/ accesskey=h title="Sparktour's Blog (Alt + H)">Sparktour's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.sparktour.me/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.sparktour.me/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.sparktour.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.sparktour.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.sparktour.me/about/ title=About><span>About</span></a></li><li><a href=https://blog.sparktour.me/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.sparktour.me/>主页</a>&nbsp;»&nbsp;<a href=https://blog.sparktour.me/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Openwrt 和通用Linux设备通过 IPIP/GRETAP 进行二层组网</h1><div class=post-meta><span title='2022-09-18 12:00:00 +0000 UTC'>2022-09-18</span>&nbsp;·&nbsp;<span title='2024-04-19 09:59:44 +0800 +0800'>更新于: 2024-04-19</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;sparktour</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#gretap aria-label=GRETAP？>GRETAP？</a></li><li><a href=#%e7%bd%91%e7%bb%9c%e7%bb%93%e6%9e%84 aria-label=网络结构>网络结构</a></li><li><a href=#%e9%85%8d%e7%bd%aeipip%e9%9a%a7%e9%81%93 aria-label=配置IPIP隧道>配置IPIP隧道</a><ul><li><a href=#debian-%e4%be%a7 aria-label="Debian 侧">Debian 侧</a></li><li><a href=#openwrt-%e4%be%a7 aria-label="Openwrt 侧">Openwrt 侧</a></li></ul></li><li><a href=#%e6%b7%bb%e5%8a%a0gretap%e9%9a%a7%e9%81%93%e5%b9%b6%e6%a1%a5%e6%8e%a5%e4%b8%8a%e7%ba%a7%e7%bd%91%e5%8f%a3 aria-label=添加GRETAP隧道并桥接上级网口>添加GRETAP隧道并桥接上级网口</a><ul><li><a href=#debian-%e4%be%a7-1 aria-label="Debian 侧">Debian 侧</a></li><li><a href=#openwrt-%e4%be%a7-1 aria-label="Openwrt 侧">Openwrt 侧</a></li></ul></li><li><a href=#debian-%e4%be%a7%e9%85%8d%e7%bd%ae%e9%9a%a7%e9%81%93%e5%bc%80%e6%9c%ba%e8%87%aa%e5%90%af aria-label="Debian 侧配置隧道开机自启">Debian 侧配置隧道开机自启</a></li><li><a href=#%e9%80%9a%e8%bf%87%e9%9a%a7%e9%81%93%e5%88%86%e9%85%8dip aria-label=通过隧道分配IP>通过隧道分配IP</a><ul><li><a href=#ipv4 aria-label=IPv4>IPv4</a></li><li><a href=#ipv6 aria-label=IPv6>IPv6</a></li></ul></li><li><a href=#%e6%80%a7%e8%83%bd aria-label=性能>性能</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a></li></ul></div></details></div><div class=post-content><p>在<a href=/posts/2022/09/18/openwrt-mikrotik-layer2-network-with-ipip-and-eoip-tunnel/>前一篇文章中</a>，笔者尝试了用Openwrt和RouterOS配合IPIP和EoIP隧道进行二层组网。但由于Openwrt的EoIP包是一个<a href=https://forum.openwrt.org/t/please-add-2-new-packages-for-eoip/57113>用户态的包</a>，AX6s转发EoIP流量的性能并不是特别好（有线500Mbps，无线300Mbps），同时RouterOS也是一个收费系统，并不是所有人都会只为了组网来购买RouterOS的授权。鉴于此，笔者也在下文提供一种将IPoE替换为GRETAP协议进行二层组网的方案，此方案仅需一台运行于实验室内网的通用Linux设备即可（本文使用的是Debian11）。</p><hr><h2 id=gretap>GRETAP？<a hidden class=anchor aria-hidden=true href=#gretap>#</a></h2><p>相比于GRE，GRETAP是类似EoIP的二层协议，因此我们同样可以将其用于二层组网。但很可惜<a href="https://forum.mikrotik.com/viewtopic.php?t=160484">RouterOS不支持GRETAP</a>（怀疑是为了推广自家的EoIP协议），因此笔者只能使用另一台Linux设备和Openwrt路由器进行组网了。</p><h2 id=网络结构>网络结构<a hidden class=anchor aria-hidden=true href=#网络结构>#</a></h2><p>此处依然简要列出一下代配置的网络结构：</p><ul><li><p>实验室路由器：ikuai，向实验室内设备分配<code>192.168.102.0/24</code>的IP。</p></li><li><p>安装在实验室的Debian服务器：Debian 11，有两个网络接口，接口<code>ens192</code>获取校园网IP <code>10.20.1.1</code>；接口<code>ens224</code>连接ikuai，配置前暂不分配IP。</p></li><li><p>安装在宿舍的Openwrt路由器：Openwrt 22.03.0，WAN口分配<code>10.20.1.2</code>的校园网IP。</p></li></ul><h2 id=配置ipip隧道>配置IPIP隧道<a hidden class=anchor aria-hidden=true href=#配置ipip隧道>#</a></h2><p>由于学校内网封锁GRE协议，因此配置的第一步依然是在两侧设置用于承载GRETAP数据的的IPIP隧道。</p><h3 id=debian-侧>Debian 侧<a hidden class=anchor aria-hidden=true href=#debian-侧>#</a></h3><p>启用IPv4转发：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;net.ipv4.ip_forward=1&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span class=line><span class=cl>sysctl -p
</span></span></code></pre></div><p>安装ipip和桥接包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>apt install ipip bridge-utils
</span></span></code></pre></div><p>添加隧道：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 启用内核模块</span>
</span></span><span class=line><span class=cl>modprobe ip_gre
</span></span><span class=line><span class=cl>modprobe ipip
</span></span><span class=line><span class=cl><span class=c1># 添加隧道</span>
</span></span><span class=line><span class=cl>ip tunnel add ipip2 <span class=nb>local</span> 10.20.2.223 remote 10.16.212.255
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> ipip2 up
</span></span><span class=line><span class=cl>ip addr add 6.0.0.1/24 dev ipip2
</span></span></code></pre></div><h3 id=openwrt-侧>Openwrt 侧<a hidden class=anchor aria-hidden=true href=#openwrt-侧>#</a></h3><p>先安装IPIP相关的包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>opkg update
</span></span><span class=line><span class=cl>opkg install luci-proto-ipip
</span></span></code></pre></div><p>重启路由器，随后添加IPIP interface：</p><pre tabindex=0><code>Network &gt; Interface &gt; Add new interface...
name: ipip1
protocal: IPv4-in-IPv4 (RFC2003)
Remote IPv4 address or FQDN: 10.20.1.1
Local IPv4 address: 10.20.1.2
Bind interface: wan

同时也需要在Advanced Settings里去掉Use Default Gateway的选项。
</code></pre><p>给IPIP的interface分配一个静态IP：</p><pre tabindex=0><code>Network &gt; Interface &gt; Add new interface...
name: ipip1static
protocal: Static
Device: ipip-ipip0
IPv4 address: 6.0.0.2/24
IPv4 gateway: 6.0.0.1

同时也需要在Advanced Settings里去掉Use Default Gateway的选项。
</code></pre><p>RouterOS和Openwrt一侧都配置好IPIP隧道后，可以互相ping一下对方的隧道IP （<code>6.0.0.1</code>， <code>6.0.0.2</code>）来检查一下隧道是否通了。</p><h2 id=添加gretap隧道并桥接上级网口>添加GRETAP隧道并桥接上级网口<a hidden class=anchor aria-hidden=true href=#添加gretap隧道并桥接上级网口>#</a></h2><h3 id=debian-侧-1>Debian 侧<a hidden class=anchor aria-hidden=true href=#debian-侧-1>#</a></h3><p>添加隧道：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># gretap tunnel</span>
</span></span><span class=line><span class=cl><span class=c1># 如果不添加IPIP隧道，可以将remote和local的ip根据实际情况修改</span>
</span></span><span class=line><span class=cl>ip link add name gretap1 <span class=nb>type</span> gretap remote 6.0.0.2 <span class=nb>local</span> 6.0.0.1
</span></span><span class=line><span class=cl><span class=c1># mtu请根据实际情况设置</span>
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> gretap1 up mtu <span class=m>1420</span>
</span></span></code></pre></div><p>桥接配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># bridge</span>
</span></span><span class=line><span class=cl>ip link add grebr0 <span class=nb>type</span> bridge
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> ens224 master grebr0
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> gretap1 master grebr0
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> grebr0 up
</span></span></code></pre></div><p>不过笔者在配置时发现，按照上述配置拉起网桥后，GRETAP另一侧的Openwrt似乎无法收到ikuai发回的DHCP offer包，<strong>但在ens224端口上执行<code>dhclient -i ens224 -4 -v</code>后莫名其妙的解决了该问题</strong>。</p><h3 id=openwrt-侧-1>Openwrt 侧<a hidden class=anchor aria-hidden=true href=#openwrt-侧-1>#</a></h3><p>安装GRE相关的包并重启：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>opkg update
</span></span><span class=line><span class=cl>opkg install luci-proto-gre ip-full
</span></span></code></pre></div><p>添加GRETAP interface：</p><pre tabindex=0><code>Network &gt; Interface &gt; Add new interface...
name: gretap1
protocal: GRETAP Tunnel over IPv4
Remote IPv4 address or FQDN: 6.0.0.1
Local IPv4 address: 6.0.0.2

同时也需要在Advanced Settings里去掉Use Default Gateway的选项。
</code></pre><h2 id=debian-侧配置隧道开机自启>Debian 侧配置隧道开机自启<a hidden class=anchor aria-hidden=true href=#debian-侧配置隧道开机自启>#</a></h2><p>如要让Debian一侧的IPIP和GRETAP隧道开机自启，可以用systemd在开机时运行以下脚本：</p><p><code>/root/gretap-spark.sh</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1>#modprobe</span>
</span></span><span class=line><span class=cl>modprobe ip_gre
</span></span><span class=line><span class=cl>modprobe ipip
</span></span><span class=line><span class=cl><span class=c1>#ipip tunnel</span>
</span></span><span class=line><span class=cl>ip tunnel add ipip2 <span class=nb>local</span> 10.20.2.223 remote 10.16.212.255
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> ipip2 up
</span></span><span class=line><span class=cl>ip addr add 6.0.0.1/24 dev ipip2
</span></span><span class=line><span class=cl><span class=c1># gretap tunnel</span>
</span></span><span class=line><span class=cl>ip link add name gretap1 <span class=nb>type</span> gretap remote 6.0.0.2 <span class=nb>local</span> 6.0.0.1
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> gretap1 up mtu <span class=m>1420</span>
</span></span><span class=line><span class=cl><span class=c1># bridge</span>
</span></span><span class=line><span class=cl>ip link add grebr0 <span class=nb>type</span> bridge
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> ens224 master grebr0
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> gretap1 master grebr0
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> grebr0 up
</span></span><span class=line><span class=cl>dhclient -i ens224 -4
</span></span></code></pre></div><p><code>/lib/systemd/system/gre-and-ipip-tunnel.service</code>：</p><pre tabindex=0><code>[Unit]
Description=bring up gretap tunnel
After=network-online.target

[Service]
Type=simple
User=root
ExecStartPre=/bin/sh -c &#39;until ping -c1 1.2.4.8; do sleep 1; done;&#39;
ExecStart=/bin/bash /root/gretap-spark.sh

[Install]
WantedBy=multi-user.target
</code></pre><h2 id=通过隧道分配ip>通过隧道分配IP<a hidden class=anchor aria-hidden=true href=#通过隧道分配ip>#</a></h2><h3 id=ipv4>IPv4<a hidden class=anchor aria-hidden=true href=#ipv4>#</a></h3><p>在Openwrt上新建一个interface，名字叫<code>dhcpgretap4</code>，Protocal选择<code>dhcp client</code>，Device选择<code>gre4t-gretap1</code>（默认可能不提供这个选项，可能需要在最下面手动输入），并勾选<code>Use default gateway</code>，防火墙划分到<code>WAN</code>区。</p><div class="callout callout-warning">如果不特别配置的话，隧道接口的MAC地址每次重启都会变化（这是由于gretap这个接口没办法固定mac导致的），openwrt似乎没发直接固定这个地址。变通的方案可以在<code>network - device</code>界面创建一个bridge（如grebr），然后给bridge配置v6地址，再将前面<code>dhcpgretap4</code>的Device指定到grebr上，此时<code>dhcpgretap4</code>的MAC就被固定成那个bridge的地址了。</div><h3 id=ipv6>IPv6<a hidden class=anchor aria-hidden=true href=#ipv6>#</a></h3><p>把<code>WAN6</code>的接口改为<code>gre4t-gretap1</code>（可能也需要手动输入）即可。</p><hr><p>全部配置完成后，<code>dhcpipip4</code>和<code>wan6</code>的interface理论上均能取得上级路由器（ikuai）分配的IP。</p><h2 id=性能>性能<a hidden class=anchor aria-hidden=true href=#性能>#</a></h2><p>有线下iperf3测速可达800Mbps，无线下可达500Mbps。速度相比EoIP协议的内层隧道已有明显改善。</p><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2><ul><li><a href=https://forum.openwrt.org/t/howto-l2-trunk-over-wifi-with-gretap/75689>https://forum.openwrt.org/t/howto-l2-trunk-over-wifi-with-gretap/75689</a></li><li><a href=https://david-waiting.medium.com/a-beginners-guide-to-generic-routing-encapsulation-fb2b4fb63abb>https://david-waiting.medium.com/a-beginners-guide-to-generic-routing-encapsulation-fb2b4fb63abb</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.sparktour.me/tags/tech/>Tech</a></li><li><a href=https://blog.sparktour.me/tags/openwrt/>Openwrt</a></li><li><a href=https://blog.sparktour.me/tags/gre/>Gre</a></li><li><a href=https://blog.sparktour.me/tags/ipip/>Ipip</a></li><li><a href=https://blog.sparktour.me/tags/gretap/>Gretap</a></li></ul><nav class=paginav><a class=prev href=https://blog.sparktour.me/posts/2022/09/18/openwrt-mikrotik-layer2-network-with-ipip-and-eoip-tunnel/><span class=title>« 上一页</span><br><span>Openwrt 和 MikroTik RouterOS 路由器通过 IPIP/EOIP 进行二层组网</span>
</a><a class=next href=https://blog.sparktour.me/posts/2022/07/18/qinghai-gansu-trip-2022/><span class=title>下一页 »</span><br><span>「动态清零」下的毕业旅行——青甘大环线</span></a></nav></footer><div class="callout callout-default"><img src=https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg alt="CC BY-NC-SA 4.0" style=width:88px;height:31px><p style=font-size:12px>Licensed Under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></p><p style=font-size:12px>Post Link: <a href=https://blog.sparktour.me/posts/2022/09/18/openwrt-linux-layer2-network-with-ipip-and-gretap-tunnel/ target=_blank rel=noopener>https://blog.sparktour.me/posts/2022/09/18/openwrt-linux-layer2-network-with-ipip-and-gretap-tunnel/</a></p></div><script src=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js crossorigin=anonymous></script><div id=disqusjs></div><script>const disqusjs=new DisqusJS({shortname:"sparktour",siteName:"",identifier:"",url:"",title:"",api:"https://disqus.com/api/",apikey:"QhJnXpS5igyHkjYQ91XYC4dSAuEJYAEsHX8hjLrRc1HU9AApOHLrqkwwIp2sKOLk",admin:"",adminLabel:""});disqusjs.render(document.getElementById("disqusjs"))</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.sparktour.me/>Sparktour's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>