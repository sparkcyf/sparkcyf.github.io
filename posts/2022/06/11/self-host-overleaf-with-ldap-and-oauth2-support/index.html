<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>为自部署Overleaf/Sharelatex实例添加LDAP和OAuth2/OpenID Connect登录支持 | Sparktour's Blog</title><meta name=keywords content="overleaf,sharelatex,LDAP,OAuth2,OpenID,keycloak"><meta name=description content="
    
    效果图


既去年给自部署Overleaf实例添加了邮箱注册功能之后，最近在TUNA的同学的帮助下，笔者也为南科大的Overleaf实例添加了LDAP登录和OAuth2/OpenID Connect登录的选项，进一步减少了用户登录Overleaf时需要的步骤。由于加上了外部的单点登录，学校的Overleaf也就不再需要邮件注册的功能了，因此本文将不再提及如何启用邮件注册，如需了解可以看笔者之前写的文章。"><meta name=author content="sparktour"><link rel=canonical href=https://blog.sparktour.me/posts/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.sparktour.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.sparktour.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.sparktour.me/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.sparktour.me/apple-touch-icon.png><link rel=mask-icon href=https://blog.sparktour.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.sparktour.me/posts/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://blog.sparktour.me/scss/callout.css><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-6EJ4YX1XZ8"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6EJ4YX1XZ8")}</script><meta property="og:url" content="https://blog.sparktour.me/posts/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/"><meta property="og:site_name" content="Sparktour's Blog"><meta property="og:title" content="为自部署Overleaf/Sharelatex实例添加LDAP和OAuth2/OpenID Connect登录支持"><meta property="og:description" content=" 效果图 既去年给自部署Overleaf实例添加了邮箱注册功能之后，最近在TUNA的同学的帮助下，笔者也为南科大的Overleaf实例添加了LDAP登录和OAuth2/OpenID Connect登录的选项，进一步减少了用户登录Overleaf时需要的步骤。由于加上了外部的单点登录，学校的Overleaf也就不再需要邮件注册的功能了，因此本文将不再提及如何启用邮件注册，如需了解可以看笔者之前写的文章。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-11T09:00:00+00:00"><meta property="article:modified_time" content="2024-04-18T18:30:45+08:00"><meta property="article:tag" content="Overleaf"><meta property="article:tag" content="Sharelatex"><meta property="article:tag" content="LDAP"><meta property="article:tag" content="OAuth2"><meta property="article:tag" content="OpenID"><meta property="article:tag" content="Keycloak"><meta property="og:image" content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:title content="为自部署Overleaf/Sharelatex实例添加LDAP和OAuth2/OpenID Connect登录支持"><meta name=twitter:description content="
    
    效果图


既去年给自部署Overleaf实例添加了邮箱注册功能之后，最近在TUNA的同学的帮助下，笔者也为南科大的Overleaf实例添加了LDAP登录和OAuth2/OpenID Connect登录的选项，进一步减少了用户登录Overleaf时需要的步骤。由于加上了外部的单点登录，学校的Overleaf也就不再需要邮件注册的功能了，因此本文将不再提及如何启用邮件注册，如需了解可以看笔者之前写的文章。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.sparktour.me/posts/"},{"@type":"ListItem","position":2,"name":"为自部署Overleaf/Sharelatex实例添加LDAP和OAuth2/OpenID Connect登录支持","item":"https://blog.sparktour.me/posts/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"为自部署Overleaf/Sharelatex实例添加LDAP和OAuth2/OpenID Connect登录支持","name":"为自部署Overleaf\/Sharelatex实例添加LDAP和OAuth2\/OpenID Connect登录支持","description":" 效果图 既去年给自部署Overleaf实例添加了邮箱注册功能之后，最近在TUNA的同学的帮助下，笔者也为南科大的Overleaf实例添加了LDAP登录和OAuth2/OpenID Connect登录的选项，进一步减少了用户登录Overleaf时需要的步骤。由于加上了外部的单点登录，学校的Overleaf也就不再需要邮件注册的功能了，因此本文将不再提及如何启用邮件注册，如需了解可以看笔者之前写的文章。\n","keywords":["overleaf","sharelatex","LDAP","OAuth2","OpenID","keycloak"],"articleBody":" 效果图 既去年给自部署Overleaf实例添加了邮箱注册功能之后，最近在TUNA的同学的帮助下，笔者也为南科大的Overleaf实例添加了LDAP登录和OAuth2/OpenID Connect登录的选项，进一步减少了用户登录Overleaf时需要的步骤。由于加上了外部的单点登录，学校的Overleaf也就不再需要邮件注册的功能了，因此本文将不再提及如何启用邮件注册，如需了解可以看笔者之前写的文章。\n2024年3月更新 ldap-overleaf-sl已参考本文合并oauth2相关的修改，如需在版本4以上的overleaf适配oauth/ldap登陆，请参考他们的repo进行操作。如在内地网络环境下遇到下载缓慢，pygments可执行包找不到等问题，可以替换ldap-overleaf-sl/Dockerfile （https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2/-/blob/ldap-overleaf-sl/ldap-overleaf-sl/Dockerfile）为以下的修改版：\n点此展开Dockerfile FROM sharelatex/sharelatex:4.2.0 # FROM sharelatex/sharelatex:latest # latest might not be tested # e.g. the AuthenticationManager.js script had to be adapted after versions 2.3.1 LABEL maintainer=\"Simon Haller-Seeber\" LABEL version=\"0.1\" # passed from .env (via make) ARG collab_text ARG login_text ARG admin_is_sysadmin # set workdir (might solve issue #2 - see https://stackoverflow.com/questions/57534295/) WORKDIR /overleaf/services/web # change apt source RUN sed -i s@/archive.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list RUN sed -i s@/security.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list RUN tlmgr option repository https://mirrors.sustech.edu.cn/CTAN/systems/texlive/tlnet # install latest npm RUN npm install -g npm --registry=https://registry.npmmirror.com \u0026\u0026 \\ ## clean cache (might solve issue #2) # npm cache clean --force \u0026\u0026 \\ npm install ldap-escape ldapts-search ldapts@3.2.4 --registry=https://registry.npmmirror.com \u0026\u0026 \\ # npm install bcrypt@5.0.0 \u0026\u0026 \\ apt-get update \u0026\u0026 \\ apt-get -y install libxml-libxslt-perl cpanminus libbtparse2 python-pygments \u0026\u0026 \\ # now install latest texlive2023 from tlmgr tlmgr update --self --all \u0026\u0026 \\ tlmgr install scheme-full --verify-repo=none # fonts RUN apt-get -y install fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome # flush font cache RUN fc-cache -fv # pip and pygments fix RUN apt-get -y install python3-pip RUN pip3 config set global.index-url https://mirrors.sustech.edu.cn/pypi/web/simple RUN pip3 install Pygments # latex-bin must be on path to be found in compilation process # needed for biber epstopdf and others ENV PATH=\"/usr/local/texlive/2023/bin/x86_64-linux:${PATH};\" # overwrite some files COPY sharelatex/AuthenticationManager.js /overleaf/services/web/app/src/Features/Authentication/ COPY sharelatex/AuthenticationController.js /overleaf/services/web/app/src/Features/Authentication/ COPY sharelatex/ContactController.js /overleaf/services/web/app/src/Features/Contacts/ COPY sharelatex/router.js /overleaf/services/web/app/src/router.js # Too much changes to do inline (\u003e10 Lines). COPY sharelatex/settings.pug /overleaf/services/web/app/views/user/ COPY sharelatex/login.pug /overleaf/services/web/app/views/user/ COPY sharelatex/navbar.pug /overleaf/services/web/app/views/layout/ COPY sharelatex/navbar-marketing.pug /overleaf/services/web/app/views/layout/ # Non LDAP User Registration for Admins COPY sharelatex/admin-index.pug /overleaf/services/web/app/views/admin/index.pug COPY sharelatex/admin-sysadmin.pug /tmp/admin-sysadmin.pug ## comment out this line to prevent sed accidently remove the brackets of the email(username) field # sed -iE '/email@example.com/{n;N;N;d}' /overleaf/services/web/app/views/user/login.pug \u0026\u0026 \\ RUN sed -iE \"s/email@example.com/${login_text:-user}/g\" /overleaf/services/web/app/views/user/login.pug \u0026\u0026 \\ ## Collaboration settings display (share project placeholder) | edit line 146 ## share.pug file was removed in later versions # sed -iE \"s%placeholder=.*$%placeholder=\\\"${collab_text}\\\"%g\" /overleaf/services/web/app/views/project/editor/share.pug \u0026\u0026 \\ ## extend pdflatex with option shell-esacpe ( fix for closed overleaf/overleaf/issues/217 and overleaf/docker-image/issues/45 ) ## do this in different ways for different sharelatex versions sed -iE \"s%-synctex=1\\\",%-synctex=1\\\", \\\"-shell-escape\\\",%g\" /overleaf/services/clsi/app/js/LatexRunner.js \u0026\u0026 \\ sed -iE \"s%'-synctex=1',%'-synctex=1', '-shell-escape',%g\" /overleaf/services/clsi/app/js/LatexRunner.js \u0026\u0026 \\ if [ \"${admin_is_sysadmin}\" = \"true\" ] ; \\ then cp /tmp/admin-sysadmin.pug /overleaf/services/web/app/views/admin/index.pug ; \\ else rm /tmp/admin-sysadmin.pug ; \\ fi # This seems to be fixed in Sharelatex 4. # \u0026\u0026 \\ # rm /overleaf/services/web/modules/user-activate/app/views/user/register.pug \u0026\u0026 \\ ### To remove comments entirly (bug https://github.com/overleaf/overleaf/issues/678) #rm /overleaf/services/web/app/views/project/editor/review-panel.pug \u0026\u0026 \\ #touch /overleaf/services/web/app/views/project/editor/review-panel.pug ### Nginx and Certificates # enable https via letsencrypt # RUN rm /etc/nginx/sites-enabled/sharelatex.conf # COPY nginx/sharelatex.conf /etc/nginx/sites-enabled/sharelatex.conf # get maintained best practice ssl from certbot # RUN wget https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf -O /etc/nginx/options-ssl-nginx.conf \u0026\u0026 \\ # wget https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem -O /etc/nginx/ssl-dhparams.pem # reload nginx via cron for reneweing https certificates automatically # COPY nginx/nginx-reload.sh /etc/cron.weekly/ # RUN chmod 0744 /etc/cron.weekly/nginx-reload.sh ## extract certificates from acme.json? # COPY nginx/nginx-cert.sh /etc/cron.weekly/ # RUN chmod 0744 /etc/cron.weekly/nginx-cert.sh \u0026\u0026 \\ # echo \"/usr/cron.weekly/nginx-cert.sh 2\u003e\u00261 \u003e /dev/null\" \u003e /etc/rc.local \u0026\u0026 \\ # chmod 0744 /etc/rc.local 修改后，按照ldap-overleaf-sl的指引在一级目录里运行make，得到docker镜像，并替换overleaf toolkit中的docker镜像即可。\n如果需要了解如何给Overleaf加上邮件自注册的话，请参考 https://sparktour.me/2021/04/02/self-host-overleaf/ 这篇文章。 本文使用的LDAP服务软件是OpenLDAP，Oauth2服务软件是Keycloak。两者通过keycloak的User Federation功能互联。如果您使用的是这两者之外的LDAP或者OAuth/OpenID Connect服务软件的话，请根据自己的情况自行微调配置。 认证系统结构 如下图所示，在本文中只需要注意OpenLDAP，Keycloak和Sharelatex部分即可。\nauth-flow 基本思路 （如果不想看这段可以直接跳到后文的「安装」部分）\n由于Overleaf的认证和用户注册函数都在 https://github.com/overleaf/overleaf/tree/main/services/web/app/src/Features/Authentication 这个文件夹下面，因此实现LDAP和Oauth的方法基本都是魔改这个文件夹里的AuthenticationController.js和AuthenticationManager.js。\nLDAP 参考 https://github.com/smhaller/ldap-overleaf-sl。\n主要就是引入了ldapts这个依赖，处理了LDAP第一次登录sharelatex时的注册问题，以及LDAP登录的时候如何验证LDAP用户邮箱和密码的流程。\nOAuth2 参考TUNA的思路，同样是添加一个函数处理OAuth用户第一次登录sharelatex时的注册问题，同时在AuthenticationController.js里加上用户处理OAuth重定向和OAuth回调的函数，同时还要注意把这两个函数对应的router加到router.js里。由于Overleaf在近期的版本里把axios删掉了，因此还要自己添加一个Axios依赖。\nkeycloak有一些奇妙的特性（bug），如果出了莫名其妙的问题的话，可以参考这篇文章用常用的api测试工具走一遍流程验证一下问题出现在哪里（此条也适用于其他的OAuth服务器）。\n处理回调的函数大致如下，熟悉OAuth2的流程的话，可以根据自己的认证软件逻辑修改：\noauth2Redirect(req, res, next) { res.redirect(`${process.env.OAUTH_AUTH_URL}?` + querystring.stringify({ client_id: process.env.OAUTH_CLIENT_ID, response_type: \"code\", redirect_uri: (process.env.SHARELATEX_SITE_URL + \"/oauth/callback\"), })); }, oauth2Callback(req, res, next) { const code = req.query.code; //construct axios body const params = new URLSearchParams() params.append('grant_type', \"authorization_code\") params.append('client_id', process.env.OAUTH_CLIENT_ID) params.append('client_secret', process.env.OAUTH_CLIENT_SECRET) params.append(\"code\", code) params.append('redirect_uri', (process.env.SHARELATEX_SITE_URL + \"/oauth/callback\")) json_body = { \"grant_type\": \"authorization_code\", client_id: process.env.OAUTH_CLIENT_ID, client_secret: process.env.OAUTH_CLIENT_SECRET, \"code\": code, redirect_uri: (process.env.SHARELATEX_SITE_URL + \"/oauth/callback\"), } axios.post(process.env.OAUTH_ACCESS_URL, params, { headers: { \"Content-Type\": \"application/x-www-form-urlencoded\", //这个是Keycloak特有的问题，需要用这个content-type才能正常发送code } }).then(access_res =\u003e { // console.log(\"respond is \" + JSON.stringify(access_res.data)) // console.log(\"authorization_bearer_is \" + authorization_bearer) authorization_bearer = \"Bearer \" + access_res.data.access_token let axios_get_config = { headers: { \"Content-Type\": \"application/x-www-form-urlencoded\", \"Authorization\": authorization_bearer, //这里同样是Keycloak特有的问题，需要把authorization_code 写到Bearer里才行 }, params: access_res.data } axios.get(process.env.OAUTH_USER_URL, axios_get_config).then(info_res =\u003e { // console.log(\"oauth_user: \", JSON.stringify(info_res.data)); if (info_res.data.err) { res.json({message: info_res.data.err}); } else { AuthenticationManager.createUserIfNotExist(info_res.data, (error, user) =\u003e { if (error) { res.json({message: error}); } else { // console.log(\"real_user: \", user); AuthenticationController.finishLogin(user, req, res, next); } }); } }); }); }, 安装 由于手动替换这些函数太麻烦了，笔者写了一个Dockerfile来自动化这些工作，具体的代码和修改好的js文件都放在了 https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2 里。（为了方便自动化构建，代码就直接放在学校的gitlab里了）\n通过Dockerfile构建 ARG BASE=sharelatex/sharelatex:3.1 #基础镜像 ARG TEXLIVE_IMAGE=registry.gitlab.com/islandoftex/images/texlive:latest #为了方便安装完整版TEXLive，直接拉一个完整版的texlive下来，最后替换掉镜像里现有的 FROM $TEXLIVE_IMAGE as texlive FROM $BASE as app # passed from .env (via make) # ARG collab_text # ARG login_text ARG admin_is_sysadmin #是否需要把LDAP的管理员也当做overleaf的管理员 # set workdir (might solve issue #2 - see https://stackoverflow.com/questions/57534295/) WORKDIR /overleaf #add mirrors RUN sed -i s@/archive.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list RUN sed -i s@/security.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list RUN npm config set registry https://registry.npmmirror.com # add oauth router to router.js #head -n -1 router.js \u003e temp.txt ; mv temp.txt router.js RUN git clone https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2.git /src RUN cat /src/ldap-overleaf-sl/sharelatex/router-append.js RUN head -n -2 /overleaf/services/web/app/src/router.js \u003e temp.txt ; mv temp.txt /overleaf/services/web/app/src/router.js RUN cat /src/ldap-overleaf-sl/sharelatex/router-append.js \u003e\u003e /overleaf/services/web/app/src/router.js # recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完 RUN node genScript compile | bash # 装了依赖之后打包会失败，参考 https://github.com/overleaf/overleaf/issues/1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。 # install package could result to the error of webpack-cli RUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape # install pygments and some fonts dependencies # 安装用于minted等代码高亮包的python3-pygments，以及一些字体 RUN apt-get update \u0026\u0026 apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome # overwrite some files (enable ldap and oauth) # 替换文件 RUN cp /src/ldap-overleaf-sl/sharelatex/AuthenticationManager.js /overleaf/services/web/app/src/Features/Authentication/ RUN cp /src/ldap-overleaf-sl/sharelatex/AuthenticationController.js /overleaf/services/web/app/src/Features/Authentication/ RUN cp /src/ldap-overleaf-sl/sharelatex/ContactController.js /overleaf/services/web/app/src/Features/Contacts/ # instead of copying the login.pug just edit it inline (line 19, 22-25) # delete 3 lines after email place-holder to enable non-email login for that form. #RUN sed -iE '/type=.*email.*/d' /overleaf/services/web/app/views/user/login.pug #RUN sed -iE '/email@example.com/{n;N;N;d}' /overleaf/services/web/app/views/user/login.pug #RUN sed -iE \"s/email@example.com/${login_text:-user}/g\" /overleaf/services/web/app/views/user/login.pug # RUN sed -iE '/type=.*email.*/d' /overleaf/services/web/app/views/user/login.pug # RUN sed -iE '/email@example.com/{n;N;N;d}' /overleaf/services/web/app/views/user/login.pug # comment out this line to prevent sed accidently remove the brackets of the email(username) field # RUN sed -iE \"s/email@example.com/${login_text:-user}/g\" /overleaf/services/web/app/views/user/login.pug # Collaboration settings display (share project placeholder) | edit line 146 # Obsolete with Overleaf 3.0 # RUN sed -iE \"s%placeholder=.*$%placeholder=\\\"${collab_text}\\\"%g\" /overleaf/services/web/app/views/project/editor/share.pug # extend pdflatex with option shell-esacpe ( fix for closed overleaf/overleaf/issues/217 and overleaf/docker-image/issues/45 ) # 允许shell-esacpe（跟minted包有关） RUN sed -iE \"s%-synctex=1\\\",%-synctex=1\\\", \\\"-shell-escape\\\",%g\" /overleaf/services/clsi/app/js/LatexRunner.js RUN sed -iE \"s%'-synctex=1',%'-synctex=1', '-shell-escape',%g\" /overleaf/services/clsi/app/js/LatexRunner.js # Too much changes to do inline (\u003e10 Lines). # 继续替换文件 RUN cp /src/ldap-overleaf-sl/sharelatex/settings.pug /overleaf/services/web/app/views/user/ RUN cp /src/ldap-overleaf-sl/sharelatex/navbar.pug /overleaf/services/web/app/views/layout/ # new login menu # 替换登录界面（可自行修改登录界面里的文字） RUN cp /src/ldap-overleaf-sl/sharelatex/login.pug /overleaf/services/web/app/views/user/ # Non LDAP User Registration for Admins # 继续替换文件 RUN cp /src/ldap-overleaf-sl/sharelatex/admin-index.pug /overleaf/services/web/app/views/admin/index.pug RUN cp /src/ldap-overleaf-sl/sharelatex/admin-sysadmin.pug /tmp/admin-sysadmin.pug RUN if [ \"${admin_is_sysadmin}\" = \"true\" ] ; then cp /tmp/admin-sysadmin.pug /overleaf/services/web/app/views/admin/index.pug ; else rm /tmp/admin-sysadmin.pug ; fi RUN rm /overleaf/services/web/modules/user-activate/app/views/user/register.pug #RUN rm /overleaf/services/web/app/views/admin/register.pug ### To remove comments entirly (bug https://github.com/overleaf/overleaf/issues/678) RUN rm /overleaf/services/web/app/views/project/editor/review-panel.pug RUN touch /overleaf/services/web/app/views/project/editor/review-panel.pug # Update TeXLive # 替换为完整版的TEXLive COPY --from=texlive /usr/local/texlive /usr/local/texlive RUN tlmgr path add # Evil hack for hardcoded texlive 2021 path # RUN rm -r /usr/local/texlive/2021 \u0026\u0026 ln -s /usr/local/texlive/2022 /usr/local/texlive/2021 根据自己的需要改完js文件和dockerfile之后，可以在本地运行：\ndocker build -t docker-overleaf-ldap . 来构建镜像。如果希望自己用CI/CD构建的话，可以参考CI自己的构建镜像指南或者.gitlab-ci.yml修改。\n如果想直接使用构建好的镜像的话，可以去 https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2/container_registry 里找（这个镜像里有一些写死的南科大相关的文字提示，可能需要在拉起镜像之后再修改）。\n安装（拉起镜像） 如果使用的是Overleaf Toolkit安装的sharelatex，可以在lib/docker-compose.base.yml 里加上LDAP和OAuth所需的环境变量（请根据实际情况修改）：\nLDAP_SERVER: ldaps://ldap.example LDAP_BASE: ou=people,dc=ldap,dc=example LDAP_BIND_USER: cn=admin,dc=ldap,dc=example LDAP_BIND_PW: 123456 SHARELATEX_SITE_URL: http://sharelatex.site OAUTH_CLIENT_ID: client-id OAUTH_CLIENT_SECRET: client-secret OAUTH_AUTH_URL: https://keycloak.site/realms/example-realm/protocol/openid-connect/auth OAUTH_ACCESS_URL: https://keycloak.site/realms/example-realm/protocol/openid-connect/token OAUTH_USER_URL: https://keycloak.site/realms/example-realm/protocol/openid-connect/userinfo ALLOW_EMAIL_LOGIN: 'true' LDAP_CONTACTS: 'true' LDAP_CONTACT_FILTER: (objectClass=inetOrgPerson) LDAP_USER_FILTER: (mail=%m) 同时修改一下bin/docker-compose的# Build up the flags to pass to docker-compose下面的部分（同样，根据自己的镜像名字和tag修改）：\n# Build up the flags to pass to docker-compose local project_name=\"${PROJECT_NAME:-overleaf}\" local image_name=\"overleaf-ldap-oauth2\" if [[ \"${SERVER_PRO:-null}\" == \"true\" ]]; then image_name=\"quay.io/sharelatex/sharelatex-pro\" fi local full_image_spec=\"$image_name:latest\" 最后运行bin/up即可拉起修改之后的镜像。如果还有问题可以用docker exec -it container-name bash进到容器里修改，每次修改完之后需要重启一次容器才能生效。\nDebug 如果出现错误（比如502或者那个sorry开头的错误页面）的话，可以检查容器里/var/log/sharelatex/web.log里的日志来定位问题。\n对于现有用户的处理 在配置完LDAP/OAuth2登录之后，现有用户依然可以用邮件+本地密码的方式登录。需要注意的是，如果用户在Sharelatex一侧修改密码，修改的密码只有本地有效，是不能被同步到LDAP的。\n经过上面的魔改，一个比较科学的 Overleaf 服务就又搭起来了。\n参考 https://gitlab.fachschaften.org/tudo-fsinfo/admin/overleaf-ldap/ （自动化构建overleaf镜像的dockerfile） https://github.com/smhaller/ldap-overleaf-sl （适配LDAP参考的项目） https://stu.cs.tsinghua.edu.cn/tex9/ （清华TeX9，适配OAuth参考的项目） https://harrychen.xyz/2020/02/15/self-host-overleaf-scientifically/ ","wordCount":"3724","inLanguage":"zh","image":"https://assets.sparktour.me/img/blog/misc/about-bg.jpg","datePublished":"2022-06-11T09:00:00Z","dateModified":"2024-04-18T18:30:45+08:00","author":{"@type":"Person","name":"sparktour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sparktour.me/posts/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/"},"publisher":{"@type":"Organization","name":"Sparktour's Blog","logo":{"@type":"ImageObject","url":"https://blog.sparktour.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.sparktour.me/ accesskey=h title="Sparktour's Blog (Alt + H)">Sparktour's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.sparktour.me/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.sparktour.me/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.sparktour.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.sparktour.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.sparktour.me/about/ title=About><span>About</span></a></li><li><a href=https://blog.sparktour.me/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.sparktour.me/>主页</a>&nbsp;»&nbsp;<a href=https://blog.sparktour.me/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">为自部署Overleaf/Sharelatex实例添加LDAP和OAuth2/OpenID Connect登录支持</h1><div class=post-meta><span title='2022-06-11 09:00:00 +0000 UTC'>2022-06-11</span>&nbsp;·&nbsp;<span title='2024-04-18 18:30:45 +0800 +0800'>更新于: 2024-04-18</span>&nbsp;·&nbsp;8 分钟&nbsp;·&nbsp;sparktour</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><ul><ul><li><a href=#2024%e5%b9%b43%e6%9c%88%e6%9b%b4%e6%96%b0 aria-label=2024年3月更新>2024年3月更新</a></li></ul></ul><li><a href=#%e8%ae%a4%e8%af%81%e7%b3%bb%e7%bb%9f%e7%bb%93%e6%9e%84 aria-label=认证系统结构>认证系统结构</a></li><li><a href=#%e5%9f%ba%e6%9c%ac%e6%80%9d%e8%b7%af aria-label=基本思路>基本思路</a><ul><li><a href=#ldap aria-label=LDAP>LDAP</a></li><li><a href=#oauth2 aria-label=OAuth2>OAuth2</a></li></ul></li><li><a href=#%e5%ae%89%e8%a3%85 aria-label=安装>安装</a><ul><li><a href=#%e9%80%9a%e8%bf%87dockerfile%e6%9e%84%e5%bb%ba aria-label=通过Dockerfile构建>通过Dockerfile构建</a></li></ul></li><li><a href=#%e5%ae%89%e8%a3%85%e6%8b%89%e8%b5%b7%e9%95%9c%e5%83%8f aria-label=安装（拉起镜像）>安装（拉起镜像）</a></li><li><a href=#debug aria-label=Debug>Debug</a></li><li><a href=#%e5%af%b9%e4%ba%8e%e7%8e%b0%e6%9c%89%e7%94%a8%e6%88%b7%e7%9a%84%e5%a4%84%e7%90%86 aria-label=对于现有用户的处理>对于现有用户的处理</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div><div class=post-content><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/self-host-overleaf-with-ldap-and-oauth2-support/cover.png alt=效果图><figcaption>效果图</figcaption></figure></p><p>既去年给自部署Overleaf实例添加了邮箱注册功能之后，最近在TUNA的同学的帮助下，笔者也为南科大的Overleaf实例添加了LDAP登录和OAuth2/OpenID Connect登录的选项，进一步减少了用户登录Overleaf时需要的步骤。由于加上了外部的单点登录，学校的Overleaf也就不再需要邮件注册的功能了，因此本文将不再提及如何启用邮件注册，如需了解可以看笔者之前写的文章。</p><div class="callout callout-info"><h4 id=2024年3月更新>2024年3月更新<a hidden class=anchor aria-hidden=true href=#2024年3月更新>#</a></h4><p><a href=https://github.com/smhaller/ldap-overleaf-sl>ldap-overleaf-sl</a>已参考本文<a href=https://github.com/smhaller/ldap-overleaf-sl/pull/33>合并</a>oauth2相关的修改，如需在版本4以上的overleaf适配oauth/ldap登陆，请参考他们的repo进行操作。如在内地网络环境下遇到下载缓慢，pygments可执行包找不到等问题，可以替换<code>ldap-overleaf-sl/Dockerfile</code> （https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2/-/blob/ldap-overleaf-sl/ldap-overleaf-sl/Dockerfile）为以下的修改版：</p><details><summary>点此展开Dockerfile</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>sharelatex/sharelatex:4.2.0</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># FROM sharelatex/sharelatex:latest</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># latest might not be tested </span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># e.g. the AuthenticationManager.js script had to be adapted after versions 2.3.1 </span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>LABEL</span> <span class=nv>maintainer</span><span class=o>=</span><span class=s2>&#34;Simon Haller-Seeber&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>LABEL</span> <span class=nv>version</span><span class=o>=</span><span class=s2>&#34;0.1&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># passed from .env (via make)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ARG</span> collab_text<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ARG</span> login_text   <span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ARG</span> admin_is_sysadmin<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># set workdir (might solve issue #2 - see https://stackoverflow.com/questions/57534295/)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>/overleaf/services/web</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># change apt source</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> sed -i s@/archive.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> sed -i s@/security.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> tlmgr option repository https://mirrors.sustech.edu.cn/CTAN/systems/texlive/tlnet<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1># install latest npm</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> npm install -g npm --registry<span class=o>=</span>https://registry.npmmirror.com <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=c1>## clean cache (might solve issue #2)</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1># npm cache clean --force &amp;&amp; \</span>
</span></span><span class=line><span class=cl>    npm install ldap-escape ldapts-search ldapts@3.2.4 --registry<span class=o>=</span>https://registry.npmmirror.com <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=c1># npm install bcrypt@5.0.0 &amp;&amp; \</span>
</span></span><span class=line><span class=cl>    apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    apt-get -y install libxml-libxslt-perl cpanminus libbtparse2 python-pygments <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=c1># now install latest texlive2023 from tlmgr</span><span class=err>
</span></span></span><span class=line><span class=cl>    tlmgr update --self --all  <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    tlmgr install scheme-full --verify-repo<span class=o>=</span>none<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># fonts</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get -y install fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome<span class=err>
</span></span></span><span class=line><span class=cl><span class=c># flush font cache</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> fc-cache -fv<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># pip and pygments fix</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get -y install python3-pip<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> pip3 config <span class=nb>set</span> global.index-url https://mirrors.sustech.edu.cn/pypi/web/simple<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> pip3 install Pygments<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># latex-bin must be on path to be found in compilation process</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># needed for biber epstopdf and others</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;/usr/local/texlive/2023/bin/x86_64-linux:</span><span class=si>${</span><span class=nv>PATH</span><span class=si>}</span><span class=s2>;&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># overwrite some files</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/AuthenticationManager.js    /overleaf/services/web/app/src/Features/Authentication/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/AuthenticationController.js /overleaf/services/web/app/src/Features/Authentication/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/ContactController.js        /overleaf/services/web/app/src/Features/Contacts/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/router.js                   /overleaf/services/web/app/src/router.js<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Too much changes to do inline (&gt;10 Lines).</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/settings.pug    /overleaf/services/web/app/views/user/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/login.pug       /overleaf/services/web/app/views/user/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/navbar.pug      /overleaf/services/web/app/views/layout/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/navbar-marketing.pug      /overleaf/services/web/app/views/layout/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Non LDAP User Registration for Admins</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/admin-index.pug     /overleaf/services/web/app/views/admin/index.pug<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> sharelatex/admin-sysadmin.pug  /tmp/admin-sysadmin.pug<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1>## comment out this line to prevent sed accidently remove the brackets of the email(username) field</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1># sed -iE &#39;/email@example.com/{n;N;N;d}&#39; /overleaf/services/web/app/views/user/login.pug &amp;&amp; \</span>
</span></span><span class=line><span class=cl>RUN sed -iE <span class=s2>&#34;s/email@example.com/</span><span class=si>${</span><span class=nv>login_text</span><span class=k>:-</span><span class=nv>user</span><span class=si>}</span><span class=s2>/g&#34;</span> /overleaf/services/web/app/views/user/login.pug <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=c1>## Collaboration settings display (share project placeholder) | edit line 146</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1>## share.pug file was removed in later versions</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1># sed -iE &#34;s%placeholder=.*$%placeholder=\&#34;${collab_text}\&#34;%g&#34; /overleaf/services/web/app/views/project/editor/share.pug &amp;&amp; \</span>
</span></span><span class=line><span class=cl>    <span class=c1>## extend pdflatex with option shell-esacpe ( fix for closed overleaf/overleaf/issues/217 and overleaf/docker-image/issues/45 )</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1>## do this in different ways for different sharelatex versions</span><span class=err>
</span></span></span><span class=line><span class=cl>    sed -iE <span class=s2>&#34;s%-synctex=1\&#34;,%-synctex=1\&#34;, \&#34;-shell-escape\&#34;,%g&#34;</span> /overleaf/services/clsi/app/js/LatexRunner.js <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    sed -iE <span class=s2>&#34;s%&#39;-synctex=1&#39;,%&#39;-synctex=1&#39;, &#39;-shell-escape&#39;,%g&#34;</span> /overleaf/services/clsi/app/js/LatexRunner.js <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>admin_is_sysadmin</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span> <span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>        <span class=k>then</span> cp /tmp/admin-sysadmin.pug /overleaf/services/web/app/views/admin/index.pug <span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>        <span class=k>else</span> rm /tmp/admin-sysadmin.pug <span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=k>fi</span> <span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1># This seems to be fixed in Sharelatex 4.</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1># &amp;&amp; \</span>
</span></span><span class=line><span class=cl>    <span class=c1># rm /overleaf/services/web/modules/user-activate/app/views/user/register.pug &amp;&amp; \</span>
</span></span><span class=line><span class=cl>    <span class=c1>### To remove comments entirly (bug https://github.com/overleaf/overleaf/issues/678)</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=c1>#rm /overleaf/services/web/app/views/project/editor/review-panel.pug &amp;&amp; \</span>
</span></span><span class=line><span class=cl>    <span class=c1>#touch /overleaf/services/web/app/views/project/editor/review-panel.pug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>### Nginx and Certificates</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># enable https via letsencrypt</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN rm /etc/nginx/sites-enabled/sharelatex.conf</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># COPY nginx/sharelatex.conf /etc/nginx/sites-enabled/sharelatex.conf</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># get maintained best practice ssl from certbot</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN wget https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf -O /etc/nginx/options-ssl-nginx.conf &amp;&amp; \</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#     wget https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem -O /etc/nginx/ssl-dhparams.pem </span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># reload nginx via cron for reneweing https certificates automatically</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># COPY nginx/nginx-reload.sh  /etc/cron.weekly/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN chmod 0744 /etc/cron.weekly/nginx-reload.sh</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>## extract certificates from acme.json?</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># COPY nginx/nginx-cert.sh /etc/cron.weekly/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN chmod 0744 /etc/cron.weekly/nginx-cert.sh &amp;&amp; \</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#     echo &#34;/usr/cron.weekly/nginx-cert.sh 2&gt;&amp;1 &gt; /dev/null&#34; &gt; /etc/rc.local &amp;&amp; \</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#     chmod 0744 /etc/rc.local</span><span class=err>
</span></span></span></code></pre></div></details><p>修改后，按照<a href=https://github.com/smhaller/ldap-overleaf-sl>ldap-overleaf-sl</a>的指引在一级目录里运行<code>make</code>，得到docker镜像，并替换overleaf toolkit中的docker镜像即可。</p></div><div class="callout callout-info">如果需要了解如何给Overleaf加上邮件自注册的话，请参考 <a href=https://sparktour.me/2021/04/02/self-host-overleaf/>https://sparktour.me/2021/04/02/self-host-overleaf/</a> 这篇文章。</div><div class="callout callout-warning">本文使用的LDAP服务软件是<a href=https://www.openldap.org/>OpenLDAP</a>，Oauth2服务软件是<a href=https://www.keycloak.org/>Keycloak</a>。两者通过keycloak的User Federation功能互联。如果您使用的是这两者之外的LDAP或者OAuth/OpenID Connect服务软件的话，请根据自己的情况自行微调配置。</div><h2 id=认证系统结构>认证系统结构<a hidden class=anchor aria-hidden=true href=#认证系统结构>#</a></h2><p>如下图所示，在本文中只需要注意OpenLDAP，Keycloak和Sharelatex部分即可。</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2022/self-host-overleaf-with-ldap-and-oauth2-support/auth-flow.svg alt=auth-flow><figcaption>auth-flow</figcaption></figure></p><h2 id=基本思路>基本思路<a hidden class=anchor aria-hidden=true href=#基本思路>#</a></h2><p>（如果不想看这段可以直接跳到后文的「安装」部分）</p><p>由于Overleaf的认证和用户注册函数都在 <a href=https://github.com/overleaf/overleaf/tree/main/services/web/app/src/Features/Authentication>https://github.com/overleaf/overleaf/tree/main/services/web/app/src/Features/Authentication</a> 这个文件夹下面，因此实现LDAP和Oauth的方法基本都是魔改这个文件夹里的<a href=https://github.com/overleaf/overleaf/blob/main/services/web/app/src/Features/Authentication/AuthenticationController.js>AuthenticationController.js</a>和<a href=https://github.com/overleaf/overleaf/blob/main/services/web/app/src/Features/Authentication/AuthenticationManager.js>AuthenticationManager.js</a>。</p><h3 id=ldap>LDAP<a hidden class=anchor aria-hidden=true href=#ldap>#</a></h3><p>参考 <a href=https://github.com/smhaller/ldap-overleaf-sl>https://github.com/smhaller/ldap-overleaf-sl</a>。</p><p>主要就是引入了ldapts这个依赖，处理了LDAP第一次登录sharelatex时的注册问题，以及LDAP登录的时候如何验证LDAP用户邮箱和密码的流程。</p><h3 id=oauth2>OAuth2<a hidden class=anchor aria-hidden=true href=#oauth2>#</a></h3><p>参考TUNA的思路，同样是添加一个函数处理OAuth用户第一次登录sharelatex时的注册问题，同时在<a href=https://github.com/overleaf/overleaf/blob/main/services/web/app/src/Features/Authentication/AuthenticationController.js>AuthenticationController.js</a>里加上用户处理OAuth重定向和OAuth回调的函数，同时还要注意把这两个函数对应的router加到<code>router.js</code>里。由于Overleaf在近期的版本里把axios删掉了，因此还要自己添加一个Axios依赖。</p><p>keycloak有一些奇妙的特性（bug），如果出了莫名其妙的问题的话，可以参考<a href=https://www.baeldung.com/postman-keycloak-endpoints>这篇文章</a>用常用的api测试工具走一遍流程验证一下问题出现在哪里（此条也适用于其他的OAuth服务器）。</p><p>处理回调的函数大致如下，<a href=https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2>熟悉OAuth2的流程</a>的话，可以根据自己的认证软件逻辑修改：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl>    <span class=nx>oauth2Redirect</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OAUTH_AUTH_URL</span><span class=si>}</span><span class=sb>?`</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=nx>querystring</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=nx>client_id</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OAUTH_CLIENT_ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>response_type</span><span class=o>:</span> <span class=s2>&#34;code&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>redirect_uri</span><span class=o>:</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SHARELATEX_SITE_URL</span> <span class=o>+</span> <span class=s2>&#34;/oauth/callback&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>}));</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>oauth2Callback</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>code</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>query</span><span class=p>.</span><span class=nx>code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//construct axios body
</span></span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>params</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URLSearchParams</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>params</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;grant_type&#39;</span><span class=p>,</span> <span class=s2>&#34;authorization_code&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>params</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;client_id&#39;</span><span class=p>,</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OAUTH_CLIENT_ID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>params</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;client_secret&#39;</span><span class=p>,</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OAUTH_CLIENT_SECRET</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>params</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>,</span> <span class=nx>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>params</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;redirect_uri&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SHARELATEX_SITE_URL</span> <span class=o>+</span> <span class=s2>&#34;/oauth/callback&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>json_body</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;grant_type&#34;</span><span class=o>:</span> <span class=s2>&#34;authorization_code&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>client_id</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OAUTH_CLIENT_ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>client_secret</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OAUTH_CLIENT_SECRET</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;code&#34;</span><span class=o>:</span> <span class=nx>code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>redirect_uri</span><span class=o>:</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SHARELATEX_SITE_URL</span> <span class=o>+</span> <span class=s2>&#34;/oauth/callback&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>axios</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OAUTH_ACCESS_URL</span><span class=p>,</span> <span class=nx>params</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>,</span> <span class=c1>//这个是Keycloak特有的问题，需要用这个content-type才能正常发送code
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>then</span><span class=p>(</span><span class=nx>access_res</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// console.log(&#34;respond is  &#34; + JSON.stringify(access_res.data))
</span></span></span><span class=line><span class=cl>            <span class=c1>// console.log(&#34;authorization_bearer_is &#34; + authorization_bearer)
</span></span></span><span class=line><span class=cl>            <span class=nx>authorization_bearer</span> <span class=o>=</span> <span class=s2>&#34;Bearer &#34;</span> <span class=o>+</span> <span class=nx>access_res</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>access_token</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nx>axios_get_config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Authorization&#34;</span><span class=o>:</span> <span class=nx>authorization_bearer</span><span class=p>,</span> <span class=c1>//这里同样是Keycloak特有的问题，需要把authorization_code 写到Bearer里才行
</span></span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=nx>params</span><span class=o>:</span> <span class=nx>access_res</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>axios</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OAUTH_USER_URL</span><span class=p>,</span> <span class=nx>axios_get_config</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>info_res</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// console.log(&#34;oauth_user: &#34;, JSON.stringify(info_res.data));
</span></span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>info_res</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span><span class=nx>message</span><span class=o>:</span> <span class=nx>info_res</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>err</span><span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>AuthenticationManager</span><span class=p>.</span><span class=nx>createUserIfNotExist</span><span class=p>(</span><span class=nx>info_res</span><span class=p>.</span><span class=nx>data</span><span class=p>,</span> <span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span><span class=nx>message</span><span class=o>:</span> <span class=nx>error</span><span class=p>});</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// console.log(&#34;real_user: &#34;, user);
</span></span></span><span class=line><span class=cl>                            <span class=nx>AuthenticationController</span><span class=p>.</span><span class=nx>finishLogin</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span></code></pre></div><h2 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h2><p>由于手动替换这些函数太麻烦了，笔者写了一个Dockerfile来自动化这些工作，具体的代码和修改好的js文件都放在了 <a href=https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2>https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2</a> 里。（为了方便自动化构建，代码就直接放在学校的gitlab里了）</p><h3 id=通过dockerfile构建>通过Dockerfile构建<a hidden class=anchor aria-hidden=true href=#通过dockerfile构建>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>BASE</span><span class=o>=</span>sharelatex/sharelatex:3.1 <span class=c1>#基础镜像</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>TEXLIVE_IMAGE</span><span class=o>=</span>registry.gitlab.com/islandoftex/images/texlive:latest <span class=c1>#为了方便安装完整版TEXLive，直接拉一个完整版的texlive下来，最后替换掉镜像里现有的</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>$TEXLIVE_IMAGE</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s>texlive</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>$BASE</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s>app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># passed from .env (via make)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># ARG collab_text</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># ARG login_text</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ARG</span> admin_is_sysadmin <span class=c1>#是否需要把LDAP的管理员也当做overleaf的管理员</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># set workdir (might solve issue #2 - see https://stackoverflow.com/questions/57534295/)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>/overleaf</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#add mirrors</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> sed -i s@/archive.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> sed -i s@/security.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> npm config <span class=nb>set</span> registry https://registry.npmmirror.com<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># add oauth router to router.js</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#head -n -1 router.js &gt; temp.txt ; mv temp.txt router.js</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> git clone https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2.git /src<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cat /src/ldap-overleaf-sl/sharelatex/router-append.js<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> head -n -2 /overleaf/services/web/app/src/router.js &gt; temp.txt <span class=p>;</span> mv temp.txt /overleaf/services/web/app/src/router.js<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cat /src/ldap-overleaf-sl/sharelatex/router-append.js &gt;&gt; /overleaf/services/web/app/src/router.js<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> node genScript compile <span class=p>|</span> bash<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 装了依赖之后打包会失败，参考 https://github.com/overleaf/overleaf/issues/1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># install package could result to the error of webpack-cli</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> npm install axios ldapts-search ldapts@3.2.4 ldap-escape<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># install pygments and some fonts dependencies</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 安装用于minted等代码高亮包的python3-pygments，以及一些字体</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># overwrite some files (enable ldap and oauth)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 替换文件</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp /src/ldap-overleaf-sl/sharelatex/AuthenticationManager.js /overleaf/services/web/app/src/Features/Authentication/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp /src/ldap-overleaf-sl/sharelatex/AuthenticationController.js /overleaf/services/web/app/src/Features/Authentication/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp /src/ldap-overleaf-sl/sharelatex/ContactController.js /overleaf/services/web/app/src/Features/Contacts/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># instead of copying the login.pug just edit it inline (line 19, 22-25)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># delete 3 lines after email place-holder to enable non-email login for that form.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#RUN sed -iE &#39;/type=.*email.*/d&#39; /overleaf/services/web/app/views/user/login.pug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#RUN sed -iE &#39;/email@example.com/{n;N;N;d}&#39; /overleaf/services/web/app/views/user/login.pug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#RUN sed -iE &#34;s/email@example.com/${login_text:-user}/g&#34; /overleaf/services/web/app/views/user/login.pug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN sed -iE &#39;/type=.*email.*/d&#39; /overleaf/services/web/app/views/user/login.pug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN sed -iE &#39;/email@example.com/{n;N;N;d}&#39; /overleaf/services/web/app/views/user/login.pug # comment out this line to prevent sed accidently remove the brackets of the email(username) field</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN sed -iE &#34;s/email@example.com/${login_text:-user}/g&#34; /overleaf/services/web/app/views/user/login.pug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Collaboration settings display (share project placeholder) | edit line 146</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Obsolete with Overleaf 3.0</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN sed -iE &#34;s%placeholder=.*$%placeholder=\&#34;${collab_text}\&#34;%g&#34; /overleaf/services/web/app/views/project/editor/share.pug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># extend pdflatex with option shell-esacpe ( fix for closed overleaf/overleaf/issues/217 and overleaf/docker-image/issues/45 )</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 允许shell-esacpe（跟minted包有关）</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> sed -iE <span class=s2>&#34;s%-synctex=1\&#34;,%-synctex=1\&#34;, \&#34;-shell-escape\&#34;,%g&#34;</span> /overleaf/services/clsi/app/js/LatexRunner.js<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> sed -iE <span class=s2>&#34;s%&#39;-synctex=1&#39;,%&#39;-synctex=1&#39;, &#39;-shell-escape&#39;,%g&#34;</span> /overleaf/services/clsi/app/js/LatexRunner.js<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Too much changes to do inline (&gt;10 Lines).</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 继续替换文件</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp /src/ldap-overleaf-sl/sharelatex/settings.pug /overleaf/services/web/app/views/user/<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp /src/ldap-overleaf-sl/sharelatex/navbar.pug /overleaf/services/web/app/views/layout/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># new login menu</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 替换登录界面（可自行修改登录界面里的文字）</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp /src/ldap-overleaf-sl/sharelatex/login.pug /overleaf/services/web/app/views/user/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Non LDAP User Registration for Admins</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 继续替换文件</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp /src/ldap-overleaf-sl/sharelatex/admin-index.pug 	/overleaf/services/web/app/views/admin/index.pug<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> cp /src/ldap-overleaf-sl/sharelatex/admin-sysadmin.pug 	/tmp/admin-sysadmin.pug<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>admin_is_sysadmin</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span> cp /tmp/admin-sysadmin.pug   /overleaf/services/web/app/views/admin/index.pug <span class=p>;</span> <span class=k>else</span> rm /tmp/admin-sysadmin.pug <span class=p>;</span> <span class=k>fi</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> rm /overleaf/services/web/modules/user-activate/app/views/user/register.pug<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>#RUN rm /overleaf/services/web/app/views/admin/register.pug</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c>### To remove comments entirly (bug https://github.com/overleaf/overleaf/issues/678)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> rm /overleaf/services/web/app/views/project/editor/review-panel.pug<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> touch /overleaf/services/web/app/views/project/editor/review-panel.pug<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Update TeXLive</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 替换为完整版的TEXLive</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> --from<span class=o>=</span>texlive /usr/local/texlive /usr/local/texlive<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> tlmgr path add<span class=err>
</span></span></span><span class=line><span class=cl><span class=c># Evil hack for hardcoded texlive 2021 path</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># RUN rm -r /usr/local/texlive/2021 &amp;&amp; ln -s /usr/local/texlive/2022 /usr/local/texlive/2021</span><span class=err>
</span></span></span></code></pre></div><p>根据自己的需要改完js文件和dockerfile之后，可以在本地运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker build -t docker-overleaf-ldap .
</span></span></code></pre></div><p>来构建镜像。如果希望自己用CI/CD构建的话，可以参考CI自己的构建镜像指南或者<code>.gitlab-ci.yml</code>修改。</p><p>如果想直接使用构建好的镜像的话，可以去 <a href=https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2/container_registry>https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2/container_registry</a> 里找（这个镜像里有一些写死的南科大相关的文字提示，可能需要在拉起镜像之后再修改）。</p><h2 id=安装拉起镜像>安装（拉起镜像）<a hidden class=anchor aria-hidden=true href=#安装拉起镜像>#</a></h2><p>如果使用的是<a href=https://github.com/overleaf/toolkit>Overleaf Toolkit</a>安装的sharelatex，可以在<code>lib/docker-compose.base.yml </code>里加上LDAP和OAuth所需的环境变量（请根据实际情况修改）：</p><pre tabindex=0><code>LDAP_SERVER: ldaps://ldap.example
LDAP_BASE: ou=people,dc=ldap,dc=example
LDAP_BIND_USER: cn=admin,dc=ldap,dc=example
LDAP_BIND_PW: 123456
SHARELATEX_SITE_URL: http://sharelatex.site
OAUTH_CLIENT_ID: client-id
OAUTH_CLIENT_SECRET: client-secret
OAUTH_AUTH_URL: https://keycloak.site/realms/example-realm/protocol/openid-connect/auth
OAUTH_ACCESS_URL: https://keycloak.site/realms/example-realm/protocol/openid-connect/token
OAUTH_USER_URL: https://keycloak.site/realms/example-realm/protocol/openid-connect/userinfo 
ALLOW_EMAIL_LOGIN: &#39;true&#39;
LDAP_CONTACTS: &#39;true&#39;
LDAP_CONTACT_FILTER: (objectClass=inetOrgPerson)
LDAP_USER_FILTER: (mail=%m)
</code></pre><p>同时修改一下<code>bin/docker-compose</code>的<code># Build up the flags to pass to docker-compose</code>下面的部分（同样，根据自己的镜像名字和tag修改）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  <span class=c1># Build up the flags to pass to docker-compose</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>project_name</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>PROJECT_NAME</span><span class=k>:-</span><span class=nv>overleaf</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>image_name</span><span class=o>=</span><span class=s2>&#34;overleaf-ldap-oauth2&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SERVER_PRO</span><span class=k>:-</span><span class=nv>null</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>image_name</span><span class=o>=</span><span class=s2>&#34;quay.io/sharelatex/sharelatex-pro&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>full_image_spec</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$image_name</span><span class=s2>:latest&#34;</span>
</span></span></code></pre></div><p>最后运行<code>bin/up</code>即可拉起修改之后的镜像。如果还有问题可以用<code>docker exec -it container-name bash</code>进到容器里修改，每次修改完之后需要重启一次容器才能生效。</p><h2 id=debug>Debug<a hidden class=anchor aria-hidden=true href=#debug>#</a></h2><p>如果出现错误（比如502或者那个sorry开头的错误页面）的话，可以检查容器里<code>/var/log/sharelatex/web.log</code>里的日志来定位问题。</p><h2 id=对于现有用户的处理>对于现有用户的处理<a hidden class=anchor aria-hidden=true href=#对于现有用户的处理>#</a></h2><p>在配置完LDAP/OAuth2登录之后，现有用户依然可以用邮件+本地密码的方式登录。<strong>需要注意的是，如果用户在Sharelatex一侧修改密码，修改的密码只有本地有效，是不能被同步到LDAP的。</strong></p><hr><blockquote><p>经过上面的魔改，一个比较科学的 Overleaf 服务就<strong>又</strong>搭起来了。</p></blockquote><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://gitlab.fachschaften.org/tudo-fsinfo/admin/overleaf-ldap/>https://gitlab.fachschaften.org/tudo-fsinfo/admin/overleaf-ldap/</a> （自动化构建overleaf镜像的dockerfile）</li><li><a href=https://github.com/smhaller/ldap-overleaf-sl>https://github.com/smhaller/ldap-overleaf-sl</a> （适配LDAP参考的项目）</li><li><a href=https://stu.cs.tsinghua.edu.cn/tex9/>https://stu.cs.tsinghua.edu.cn/tex9/</a> （清华TeX9，适配OAuth参考的项目）</li><li><a href=https://harrychen.xyz/2020/02/15/self-host-overleaf-scientifically/>https://harrychen.xyz/2020/02/15/self-host-overleaf-scientifically/</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.sparktour.me/tags/overleaf/>Overleaf</a></li><li><a href=https://blog.sparktour.me/tags/sharelatex/>Sharelatex</a></li><li><a href=https://blog.sparktour.me/tags/ldap/>LDAP</a></li><li><a href=https://blog.sparktour.me/tags/oauth2/>OAuth2</a></li><li><a href=https://blog.sparktour.me/tags/openid/>OpenID</a></li><li><a href=https://blog.sparktour.me/tags/keycloak/>Keycloak</a></li></ul><nav class=paginav><a class=prev href=https://blog.sparktour.me/posts/2022/07/18/qinghai-gansu-trip-2022/><span class=title>« 上一页</span><br><span>「动态清零」下的毕业旅行——青甘大环线</span>
</a><a class=next href=https://blog.sparktour.me/posts/2022/03/18/enable-redmi-ssh-without-openwrt/><span class=title>下一页 »</span><br><span>无需其他Openwrt路由器，使用任意带无线网的Linux机器解锁红米AX6路由器的SSH</span></a></nav></footer><div class="callout callout-default"><img src=https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg alt="CC BY-NC-SA 4.0" style=width:88px;height:31px><p style=font-size:12px>Licensed Under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></p><p style=font-size:12px>Post Link: <a href=https://blog.sparktour.me/posts/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/ target=_blank rel=noopener>https://blog.sparktour.me/posts/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/</a></p></div><script src=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js crossorigin=anonymous></script><div id=disqusjs></div><script>const disqusjs=new DisqusJS({shortname:"sparktour",siteName:"",identifier:"",url:"",title:"",api:"https://disqus.com/api/",apikey:"QhJnXpS5igyHkjYQ91XYC4dSAuEJYAEsHX8hjLrRc1HU9AApOHLrqkwwIp2sKOLk",admin:"",adminLabel:""});disqusjs.render(document.getElementById("disqusjs"))</script></article></main><footer class=footer><span>&copy; 2026 <a href=https://blog.sparktour.me/>Sparktour's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>