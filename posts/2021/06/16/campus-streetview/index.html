<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>为校园生成街景 | Sparktour's Blog</title><meta name=keywords content="panorama"><meta name=description content="为校园生成街景
给学校做一个街景是大一入学以来一直以来的一个愿望了。在大二的时候，我们已经为学校拍摄了数张航拍全景，本想打算以此为基础为学校做一个完整的全景覆盖的，可惜疫情之后学校就不再让学生在未经老师允许的情况下飞行无人机了。街景的实现方式也从无人机变成了土制街景单车（误）。"><meta name=author content="sparktour"><link rel=canonical href=https://blog.sparktour.me/posts/2021/06/16/campus-streetview/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.sparktour.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.sparktour.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.sparktour.me/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.sparktour.me/apple-touch-icon.png><link rel=mask-icon href=https://blog.sparktour.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.sparktour.me/posts/2021/06/16/campus-streetview/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://blog.sparktour.me/scss/callout.css><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-6EJ4YX1XZ8"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6EJ4YX1XZ8")}</script><meta property="og:url" content="https://blog.sparktour.me/posts/2021/06/16/campus-streetview/"><meta property="og:site_name" content="Sparktour's Blog"><meta property="og:title" content="为校园生成街景"><meta property="og:description" content="为校园生成街景 给学校做一个街景是大一入学以来一直以来的一个愿望了。在大二的时候，我们已经为学校拍摄了数张航拍全景，本想打算以此为基础为学校做一个完整的全景覆盖的，可惜疫情之后学校就不再让学生在未经老师允许的情况下飞行无人机了。街景的实现方式也从无人机变成了土制街景单车（误）。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-16T13:00:00+00:00"><meta property="article:modified_time" content="2024-04-18T21:09:32+08:00"><meta property="article:tag" content="Panorama"><meta property="og:image" content="https://assets.sparktour.me/img/blog/2021/campus-streetview/cover.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://assets.sparktour.me/img/blog/2021/campus-streetview/cover.jpg"><meta name=twitter:title content="为校园生成街景"><meta name=twitter:description content="为校园生成街景
给学校做一个街景是大一入学以来一直以来的一个愿望了。在大二的时候，我们已经为学校拍摄了数张航拍全景，本想打算以此为基础为学校做一个完整的全景覆盖的，可惜疫情之后学校就不再让学生在未经老师允许的情况下飞行无人机了。街景的实现方式也从无人机变成了土制街景单车（误）。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.sparktour.me/posts/"},{"@type":"ListItem","position":2,"name":"为校园生成街景","item":"https://blog.sparktour.me/posts/2021/06/16/campus-streetview/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"为校园生成街景","name":"为校园生成街景","description":"为校园生成街景 给学校做一个街景是大一入学以来一直以来的一个愿望了。在大二的时候，我们已经为学校拍摄了数张航拍全景，本想打算以此为基础为学校做一个完整的全景覆盖的，可惜疫情之后学校就不再让学生在未经老师允许的情况下飞行无人机了。街景的实现方式也从无人机变成了土制街景单车（误）。\n","keywords":["panorama"],"articleBody":"为校园生成街景 给学校做一个街景是大一入学以来一直以来的一个愿望了。在大二的时候，我们已经为学校拍摄了数张航拍全景，本想打算以此为基础为学校做一个完整的全景覆盖的，可惜疫情之后学校就不再让学生在未经老师允许的情况下飞行无人机了。街景的实现方式也从无人机变成了土制街景单车（误）。\n拍摄前准备 从这张拍摄中截取的街景图片中能够看到土制街景单车的基本配置。全景车的基础是一台自行车，并且在车辆的车把左半部分通过GoPro通用接口挂接了相机的自拍杆，右边用于放置记录地理信息和罗盘方位的手机或者其他GPS设备。\n土制街景单车 全景相机 这次拍摄使用的全景相机是Insta360 One X，两侧各有一个1200万像素的全景镜头，拼合起来的图片为6080*3040，大概1800万像素。成像质量一般，拉近来看估计还没有大部分手机的广角镜头好。\n本次拍摄时，我们使用了一个自拍杆接在相机上，并把相机接进了车头上的转接件里。但这种方案一旦车动起来，自拍杆是没有办法保持垂直的（也许可以使用下图的这种方法，但看起来不是很好保持相机的水平和方向）。因此我们还需要用一只手稳住自拍杆，另一只手操控车把和刹车。（在此情况下，请做足个人保护措施，勿使用抓住自拍杆的手单手骑车，并时刻注意周边环境！）\n挂载全景相机的一个例子 手机/GPS Insta360 One X是没有内置GPS的（App里面的记录GPS选项只能记录第一张照片的GPS，约等于没用）。因此我们需要在车把右侧挂载手机用于记录GPS和图片的拍摄方位。这里推荐使用OSMTracker for Android来进行记录。在导出数据的时候，需要在Settings-Export compass heading里面勾选in extension 来把方向（指南针）数据导出到GPX文件里面。\n拍摄 在约8km/h的骑车速度下，将相机设置成间隔拍摄，5秒拍摄一张即可，这样两张图之间大概会间隔10米左右。\n后期处理 在手机记录完GPX数据之后，我们可以在应用里面选择以GPX格式导出即可。\n修正GPX数据偏移 这应该属于One X的一个硬件Bug，相机的EXIF时间戳总是会比相机时钟慢上10秒左右。同时，长期不连接手机还会造成其他的时钟偏移问题。因此，我们需要首先寻找EXIF时间戳和GPS的时间差。由于没有其他的参考，这次拍摄中我们就只能使用卫星图和拍摄出来的周围景色对照来计算时间偏差了。\n万幸的是，南科大的校园里有大量的黄色减速带。减速带大概长这样：\n找不到本校的减速带照片了，图中是CUHK的减速带 使用Geosetter将经过减速带时图片的EXIF时间戳和通过减速带时GPX的时间戳进行对比，我们就可以计算出相机时钟的漂移了。（这个软件还能显示图片EXIF中的方位和叠加GPX路径，在验证GPX路径的时候相当方便）\nGeosetter的界面 通过GPSBabel，我们就能快速偏移GPX轨迹的时间戳，对齐EXIF时间戳和GPX时间戳了：\ngpsbabel -t -r -w -i gpx -f intput.gpx -x track,move=+12s -o gpx -F out.gpx （在拍摄中，第一天的偏移是11s，第二天是51s）\n修正指南针数据标签 由于在将geotag数据标记到图像EXIF数据的过程中，exiftool读取不到原始GPX数据的坐标。我们需要将GPX文件中方向的tag进行修正。在GPX文件中，将所有的标签改为即可。\n通过delta GPS坐标修正图片方向 万一你的手机没能记录下正确的方向数据，我们也可以用求GPS轨迹切线斜率的方法得出大致的方向。使用下方的python代码即可：\nimport numpy as np import pandas as pd from geographiclib.geodesic import Geodesic import xml.etree.ElementTree as ET gpx_tree = ET.parse('input.gpx') gpx_root = gpx_tree.getroot() # 2520是gpx的路径点数量 for i in (range(0,2520)): gpx_root[1][1][i][2][1].text = str((float(gpx_root[1][1][i][2][1].text) + 180)%360) # 如果相机的显示器这一面与行车方向相反，则需要把路径调转180度 gpx_tree.write('modified.gpx') Geotag 使用exiftool完成即可，需要注意GPX文件/图片的EXIF有可能是不带时区的，因此同步位置信息的时候还需要添加一个时区偏移（8小时即28800秒）。(其他的同步选项可以参考这个网页)\nexiftool -geotag output.gpx -geosync=+28800 DIR 模糊车牌和人脸 根据mapillary论坛上网友的建议，本次我们选择使用understand-ai/anonymizer来模糊街景中的车牌和人脸。将repo clone下来之后，新建一个python3.6的anaconda环境，按照requirements.txt里面的包安装即可。程序第一次运行的时候需要从Google Drive下载模型，此处可能需要添加代理。\nPYTHONPATH=$PYTHONPATH:. python anonymizer/bin/anonymize.py --input input-folder --image-output output-folder --weights weights --face-threshold=0.1 --plate-threshold=0.1 --obfuscation-kernel 47,1,9 使用GTX1660Ti显卡时，模型的处理速度大约是2秒一张图。\n处理进度图 同步EXIF 模糊完车牌和人脸之后的文件也被抹去了exif信息，这时还需要用输入图片同步EXIF数据到输出图片。\n# copy EXIF as a block between same-named JPG files in different directories exiftool -tagsfromfile SRCDIR/%f.%e -exif -ext jpg DSTDIR 生成全景网页 使用pano2VR生成即可。这个软件提供了制作街景中比较关键的设置图像联系，添加控制按钮等功能。\n在软件自动生成完全景之后，可能需要自己处理一下节点之间不正确的连接关系和GPS位置错误的图像。\npano2vr的界面 最后导出即可。\nDemo Link ","wordCount":"2033","inLanguage":"zh","image":"https://assets.sparktour.me/img/blog/2021/campus-streetview/cover.jpg","datePublished":"2021-06-16T13:00:00Z","dateModified":"2024-04-18T21:09:32+08:00","author":{"@type":"Person","name":"sparktour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sparktour.me/posts/2021/06/16/campus-streetview/"},"publisher":{"@type":"Organization","name":"Sparktour's Blog","logo":{"@type":"ImageObject","url":"https://blog.sparktour.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.sparktour.me/ accesskey=h title="Sparktour's Blog (Alt + H)">Sparktour's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.sparktour.me/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.sparktour.me/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.sparktour.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.sparktour.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.sparktour.me/about/ title=About><span>About</span></a></li><li><a href=https://blog.sparktour.me/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.sparktour.me/>主页</a>&nbsp;»&nbsp;<a href=https://blog.sparktour.me/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">为校园生成街景</h1><div class=post-meta><span title='2021-06-16 13:00:00 +0000 UTC'>2021-06-16</span>&nbsp;·&nbsp;<span title='2024-04-18 21:09:32 +0800 +0800'>更新于: 2024-04-18</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;sparktour</div></header><figure class=entry-cover><img loading=eager src=https://assets.sparktour.me/img/blog/2021/campus-streetview/cover.jpg alt=街景界面（图中是南科大的大门）><figcaption>街景界面（图中是南科大的大门）</figcaption></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%b8%ba%e6%a0%a1%e5%9b%ad%e7%94%9f%e6%88%90%e8%a1%97%e6%99%af aria-label=为校园生成街景>为校园生成街景</a><ul><li><a href=#%e6%8b%8d%e6%91%84%e5%89%8d%e5%87%86%e5%a4%87 aria-label=拍摄前准备>拍摄前准备</a><ul><li><a href=#%e5%85%a8%e6%99%af%e7%9b%b8%e6%9c%ba aria-label=全景相机>全景相机</a></li><li><a href=#%e6%89%8b%e6%9c%bagps aria-label=手机/GPS>手机/GPS</a></li></ul></li><li><a href=#%e6%8b%8d%e6%91%84 aria-label=拍摄>拍摄</a></li><li><a href=#%e5%90%8e%e6%9c%9f%e5%a4%84%e7%90%86 aria-label=后期处理>后期处理</a><ul><li><a href=#%e4%bf%ae%e6%ad%a3gpx%e6%95%b0%e6%8d%ae%e5%81%8f%e7%a7%bb aria-label=修正GPX数据偏移>修正GPX数据偏移</a></li><li><a href=#%e4%bf%ae%e6%ad%a3%e6%8c%87%e5%8d%97%e9%92%88%e6%95%b0%e6%8d%ae%e6%a0%87%e7%ad%be aria-label=修正指南针数据标签>修正指南针数据标签</a></li><li><a href=#%e9%80%9a%e8%bf%87delta-gps%e5%9d%90%e6%a0%87%e4%bf%ae%e6%ad%a3%e5%9b%be%e7%89%87%e6%96%b9%e5%90%91 aria-label="通过delta GPS坐标修正图片方向">通过delta GPS坐标修正图片方向</a></li><li><a href=#geotag aria-label=Geotag>Geotag</a></li></ul></li><li><a href=#%e6%a8%a1%e7%b3%8a%e8%bd%a6%e7%89%8c%e5%92%8c%e4%ba%ba%e8%84%b8 aria-label=模糊车牌和人脸>模糊车牌和人脸</a><ul><li><a href=#%e5%90%8c%e6%ad%a5exif aria-label=同步EXIF>同步EXIF</a></li></ul></li><li><a href=#%e7%94%9f%e6%88%90%e5%85%a8%e6%99%af%e7%bd%91%e9%a1%b5 aria-label=生成全景网页>生成全景网页</a></li><li><a href=#demo aria-label=Demo>Demo</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=为校园生成街景>为校园生成街景<a hidden class=anchor aria-hidden=true href=#为校园生成街景>#</a></h1><p>给学校做一个街景是大一入学以来一直以来的一个愿望了。在大二的时候，我们已经为学校拍摄了数张航拍全景，本想打算以此为基础为学校做一个完整的全景覆盖的，可惜疫情之后学校就不再让学生在未经老师允许的情况下飞行无人机了。街景的实现方式也从无人机变成了土制街景单车（误）。</p><h2 id=拍摄前准备>拍摄前准备<a hidden class=anchor aria-hidden=true href=#拍摄前准备>#</a></h2><p>从这张拍摄中截取的街景图片中能够看到<del>土制街景单车</del>的基本配置。全景车的基础是一台自行车，并且在车辆的车把左半部分通过GoPro通用接口挂接了相机的自拍杆，右边用于放置记录地理信息和罗盘方位的手机或者其他GPS设备。</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2021/campus-streetview/pano-bike.jpg alt=土制街景单车><figcaption>土制街景单车</figcaption></figure></p><h3 id=全景相机>全景相机<a hidden class=anchor aria-hidden=true href=#全景相机>#</a></h3><p>这次拍摄使用的全景相机是<code>Insta360 One X</code>，两侧各有一个1200万像素的全景镜头，拼合起来的图片为<code>6080*3040</code>，大概1800万像素。成像质量一般，拉近来看估计还没有大部分手机的广角镜头好。</p><p>本次拍摄时，我们使用了一个<a href=https://store.insta360.com/product/bike_bundle>自拍杆</a>接在相机上，并把相机接进了车头上的转接件里。但这种方案一旦车动起来，自拍杆是没有办法保持垂直的（也许可以使用下图的这种方法，但看起来不是很好保持相机的水平和方向）。因此我们还需要用一只手稳住自拍杆，另一只手操控车把和刹车。（在此情况下，<strong>请做足个人保护措施，勿使用抓住自拍杆的手单手骑车，并时刻注意周边环境！</strong>）</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2021/campus-streetview/insta360-example.jpg alt=挂载全景相机的一个例子><figcaption>挂载全景相机的一个例子</figcaption></figure></p><h3 id=手机gps>手机/GPS<a hidden class=anchor aria-hidden=true href=#手机gps>#</a></h3><p>Insta360 One X是<strong>没有内置GPS的</strong>（App里面的记录GPS选项只能记录第一张照片的GPS，约等于没用）。因此我们需要在车把右侧挂载手机用于记录GPS和图片的拍摄方位。这里推荐使用<a href=https://github.com/labexp/osmtracker-android>OSMTracker for Android</a>来进行记录。在导出数据的时候，需要在<code>Settings-Export compass heading</code>里面勾选<code>in extension</code> 来把方向（指南针）数据导出到GPX文件里面。</p><h2 id=拍摄>拍摄<a hidden class=anchor aria-hidden=true href=#拍摄>#</a></h2><p>在约8km/h的骑车速度下，将相机设置成间隔拍摄，5秒拍摄一张即可，这样两张图之间大概会间隔10米左右。</p><h2 id=后期处理>后期处理<a hidden class=anchor aria-hidden=true href=#后期处理>#</a></h2><p>在手机记录完GPX数据之后，我们可以在应用里面选择<code>以GPX格式导出</code>即可。</p><h3 id=修正gpx数据偏移>修正GPX数据偏移<a hidden class=anchor aria-hidden=true href=#修正gpx数据偏移>#</a></h3><p>这应该属于One X的一个硬件Bug，相机的EXIF时间戳总是会比相机时钟慢上10秒左右。同时，长期不连接手机还会造成其他的时钟偏移问题。因此，我们需要首先寻找EXIF时间戳和GPS的时间差。由于没有其他的参考，这次拍摄中我们就只能使用卫星图和拍摄出来的周围景色对照来计算时间偏差了。</p><p>万幸的是，南科大的校园里有大量的<strong>黄色减速带</strong>。减速带大概长这样：</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2021/campus-streetview/cuhk-speed-bump.jpg alt=找不到本校的减速带照片了，图中是CUHK的减速带><figcaption>找不到本校的减速带照片了，图中是CUHK的减速带</figcaption></figure></p><p>使用<a href=https://www.geosetter.de/>Geosetter</a>将经过减速带时图片的EXIF时间戳和通过减速带时GPX的时间戳进行对比，我们就可以计算出相机时钟的漂移了。（这个软件还能显示图片EXIF中的方位和叠加GPX路径，在验证GPX路径的时候相当方便）</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2021/campus-streetview/geosetter.jpg alt=Geosetter的界面><figcaption>Geosetter的界面</figcaption></figure></p><p>通过<a href=https://www.gpsbabel.org/>GPSBabel</a>，我们就能快速偏移GPX轨迹的时间戳，对齐EXIF时间戳和GPX时间戳了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gpsbabel -t -r -w -i gpx -f intput.gpx -x track,move<span class=o>=</span>+12s -o gpx -F out.gpx
</span></span></code></pre></div><p>（在拍摄中，第一天的偏移是11s，第二天是51s）</p><h3 id=修正指南针数据标签>修正指南针数据标签<a hidden class=anchor aria-hidden=true href=#修正指南针数据标签>#</a></h3><p>由于在将geotag数据标记到图像EXIF数据的过程中，<a href=https://exiftool.org/>exiftool</a>读取不到原始GPX数据的坐标。我们需要将GPX文件中方向的tag进行修正。在GPX文件中，将所有的<code>&lt;compass></code>标签改为<code>&lt;course></code>即可。</p><h3 id=通过delta-gps坐标修正图片方向>通过delta GPS坐标修正图片方向<a hidden class=anchor aria-hidden=true href=#通过delta-gps坐标修正图片方向>#</a></h3><p>万一你的手机没能记录下正确的方向数据，我们也可以用求GPS轨迹切线斜率的方法得出大致的方向。使用下方的python代码即可：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>geographiclib.geodesic</span> <span class=kn>import</span> <span class=n>Geodesic</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>xml.etree.ElementTree</span> <span class=k>as</span> <span class=nn>ET</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gpx_tree</span> <span class=o>=</span> <span class=n>ET</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s1>&#39;input.gpx&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>gpx_root</span> <span class=o>=</span> <span class=n>gpx_tree</span><span class=o>.</span><span class=n>getroot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2520是gpx的路径点数量</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>2520</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>gpx_root</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>][</span><span class=n>i</span><span class=p>][</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>text</span> <span class=o>=</span> <span class=nb>str</span><span class=p>((</span><span class=nb>float</span><span class=p>(</span><span class=n>gpx_root</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>][</span><span class=n>i</span><span class=p>][</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>text</span><span class=p>)</span> <span class=o>+</span> <span class=mi>180</span><span class=p>)</span><span class=o>%</span><span class=mi>360</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 如果相机的显示器这一面与行车方向相反，则需要把路径调转180度</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gpx_tree</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;modified.gpx&#39;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=geotag>Geotag<a hidden class=anchor aria-hidden=true href=#geotag>#</a></h3><p>使用<code>exiftool</code>完成即可，需要注意GPX文件/图片的EXIF有可能是不带时区的，因此同步位置信息的时候还需要添加一个时区偏移（8小时即28800秒）。(其他的同步选项可以参考<a href=https://exiftool.org/geotag.html>这个网页</a>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>exiftool -geotag output.gpx -geosync<span class=o>=</span>+28800 DIR
</span></span></code></pre></div><h2 id=模糊车牌和人脸>模糊车牌和人脸<a hidden class=anchor aria-hidden=true href=#模糊车牌和人脸>#</a></h2><p>根据mapillary论坛上<a href=https://forum.mapillary.com/t/anonymize-blurring-faces-and-license-plates-before-upload/>网友的建议</a>，本次我们选择使用<a href=https://github.com/understand-ai/anonymizer>understand-ai/anonymizer</a>来模糊街景中的车牌和人脸。将repo clone下来之后，新建一个python3.6的anaconda环境，按照<code>requirements.txt</code>里面的包安装即可。程序第一次运行的时候需要从Google Drive下载模型，此处可能需要添加代理。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>PYTHONPATH</span><span class=o>=</span><span class=nv>$PYTHONPATH</span>:.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python anonymizer/bin/anonymize.py --input input-folder --image-output output-folder --weights weights --face-threshold<span class=o>=</span>0.1 --plate-threshold<span class=o>=</span>0.1  --obfuscation-kernel 47,1,9
</span></span></code></pre></div><p>使用GTX1660Ti显卡时，模型的处理速度大约是2秒一张图。</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2021/campus-streetview/anonymizer.png alt=处理进度图><figcaption>处理进度图</figcaption></figure></p><h3 id=同步exif>同步EXIF<a hidden class=anchor aria-hidden=true href=#同步exif>#</a></h3><p>模糊完车牌和人脸之后的文件也被抹去了exif信息，这时还需要用输入图片同步EXIF数据到输出图片。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># copy EXIF as a block between same-named JPG files in different directories</span>
</span></span><span class=line><span class=cl>exiftool -tagsfromfile SRCDIR/%f.%e -exif -ext jpg DSTDIR
</span></span></code></pre></div><h2 id=生成全景网页>生成全景网页<a hidden class=anchor aria-hidden=true href=#生成全景网页>#</a></h2><p>使用<a href=https://ggnome.com/pano2vr/>pano2VR</a>生成即可。这个软件提供了制作街景中比较关键的设置图像联系，添加控制按钮等功能。</p><p>在软件自动生成完全景之后，可能需要自己处理一下节点之间不正确的连接关系和GPS位置错误的图像。</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2021/campus-streetview/pano2vr.jpg alt=pano2vr的界面><figcaption>pano2vr的界面</figcaption></figure></p><p>最后导出即可。</p><h2 id=demo>Demo<a hidden class=anchor aria-hidden=true href=#demo>#</a></h2><ul><li><a href=https://mirrors.sustech.edu.cn/site/sustech-pano/202106/#node38,210,0,120,10>Link</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.sparktour.me/tags/panorama/>Panorama</a></li></ul><nav class=paginav><a class=prev href=https://blog.sparktour.me/posts/2021/07/04/tencent-intern-first-impression/><span class=title>« 上一页</span><br><span>腾讯实习初体验</span>
</a><a class=next href=https://blog.sparktour.me/posts/2021/05/18/trip-to-nanjing/><span class=title>下一页 »</span><br><span>南京出差杂记</span></a></nav></footer><div class="callout callout-default"><img src=https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg alt="CC BY-NC-SA 4.0" style=width:88px;height:31px><p style=font-size:12px>Licensed Under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></p><p style=font-size:12px>Post Link: <a href=https://blog.sparktour.me/posts/2021/06/16/campus-streetview/ target=_blank rel=noopener>https://blog.sparktour.me/posts/2021/06/16/campus-streetview/</a></p></div><script src=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js crossorigin=anonymous></script><div id=disqusjs></div><script>const disqusjs=new DisqusJS({shortname:"sparktour",siteName:"",identifier:"",url:"",title:"",api:"https://disqus.com/api/",apikey:"QhJnXpS5igyHkjYQ91XYC4dSAuEJYAEsHX8hjLrRc1HU9AApOHLrqkwwIp2sKOLk",admin:"",adminLabel:""});disqusjs.render(document.getElementById("disqusjs"))</script></article></main><footer class=footer><span>&copy; 2026 <a href=https://blog.sparktour.me/>Sparktour's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>