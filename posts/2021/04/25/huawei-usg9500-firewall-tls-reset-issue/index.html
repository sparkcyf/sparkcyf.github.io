<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>处理华为核心防火墙导致的TLS连接重置问题 | Sparktour's Blog</title><meta name=keywords content="tech"><meta name=description content="本文是2021年4月时，南科大镜像站遇到的TLS连接重置问题的调试存档。一句话概括情况：在校外向镜像站公网v4地址(116.7.234.220)的TCP 443端口发起的首个HTTPS连接会被中间设备(middlebox)抢答并阻断，镜像站主机根本没有收到这条TCP连接相关的数据包。"><meta name=author content="sparktour"><link rel=canonical href=https://blog.sparktour.me/posts/2021/04/25/huawei-usg9500-firewall-tls-reset-issue/><link crossorigin=anonymous href=/assets/css/stylesheet.93f625d739f1d6a5c6f20c146bc6a8d26b233492b34b2220c54b12fd46a04ded.css integrity="sha256-k/Yl1znx1qXG8gwUa8ao0msjNJKzSyIgxUsS/UagTe0=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.sparktour.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.sparktour.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.sparktour.me/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.sparktour.me/apple-touch-icon.png><link rel=mask-icon href=https://blog.sparktour.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.sparktour.me/posts/2021/04/25/huawei-usg9500-firewall-tls-reset-issue/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://blog.sparktour.me/scss/callout.css><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-6EJ4YX1XZ8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6EJ4YX1XZ8")}</script><meta property="og:url" content="https://blog.sparktour.me/posts/2021/04/25/huawei-usg9500-firewall-tls-reset-issue/"><meta property="og:site_name" content="Sparktour's Blog"><meta property="og:title" content="处理华为核心防火墙导致的TLS连接重置问题"><meta property="og:description" content="本文是2021年4月时，南科大镜像站遇到的TLS连接重置问题的调试存档。一句话概括情况：在校外向镜像站公网v4地址(116.7.234.220)的TCP 443端口发起的首个HTTPS连接会被中间设备(middlebox)抢答并阻断，镜像站主机根本没有收到这条TCP连接相关的数据包。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-25T12:00:00+00:00"><meta property="article:modified_time" content="2024-04-14T21:54:57+08:00"><meta property="article:tag" content="Tech"><meta property="og:image" content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:title content="处理华为核心防火墙导致的TLS连接重置问题"><meta name=twitter:description content="本文是2021年4月时，南科大镜像站遇到的TLS连接重置问题的调试存档。一句话概括情况：在校外向镜像站公网v4地址(116.7.234.220)的TCP 443端口发起的首个HTTPS连接会被中间设备(middlebox)抢答并阻断，镜像站主机根本没有收到这条TCP连接相关的数据包。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.sparktour.me/posts/"},{"@type":"ListItem","position":2,"name":"处理华为核心防火墙导致的TLS连接重置问题","item":"https://blog.sparktour.me/posts/2021/04/25/huawei-usg9500-firewall-tls-reset-issue/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"处理华为核心防火墙导致的TLS连接重置问题","name":"处理华为核心防火墙导致的TLS连接重置问题","description":"本文是2021年4月时，南科大镜像站遇到的TLS连接重置问题的调试存档。一句话概括情况：在校外向镜像站公网v4地址(116.7.234.220)的TCP 443端口发起的首个HTTPS连接会被中间设备(middlebox)抢答并阻断，镜像站主机根本没有收到这条TCP连接相关的数据包。\n","keywords":["tech"],"articleBody":"本文是2021年4月时，南科大镜像站遇到的TLS连接重置问题的调试存档。一句话概括情况：在校外向镜像站公网v4地址(116.7.234.220)的TCP 443端口发起的首个HTTPS连接会被中间设备(middlebox)抢答并阻断，镜像站主机根本没有收到这条TCP连接相关的数据包。\n简介 在校外向镜像站公网v4地址(116.7.234.220)的TCP 443端口发起的首个HTTPS连接会被中间设备(middlebox)抢答并阻断，镜像站主机根本没有收到这条TCP连接相关的数据包。\n在北京时间09:00-24:00这个问题可被重现的概率极高，在凌晨则似乎不易发生。推测与中间设备负载或出口带宽使用率有关。\n中间设备似乎在截获一个TLS Client Hello后便会放行该IP随后向443端口发起的TCP连接。此放行规则的超时时间似乎不定，大致为30分钟至一个半小时。\n问题影响的范围 最早是在镜像站公网IPv4地址的TCP 443端口上观察到的。公网IPv4地址于TCP 80端口提供的HTTP服务及IPv6地址则不受影响。\n随后的测试发现学校电信出口116.7.234.0/24网段下一些IP的443端口同样会受此问题影响，但频率似乎不如镜像站的116.7.234.220高。教育网出口110.65.147.0/24下找到了一个似乎受此问题影响的IP，但在随后申请到的教育网IP上则无法复现。\n如何复现 在客户端启动抓包软件。参考命令：tcpdump -i eth0 -n -w /tmp/test.pcap host 116.7.234.220\n然后反复执行下方命令，观察抓包记录。\ncurl http://116.7.234.220:443/ --max-time 5 -v -o /dev/null 可见TCP握手能正常进行，但客户端发出的HTTP请求却一直不被响应：尽管客户端的TCP栈不断尝试重传承载它的PSH,ACK包，但对方始终不发回ACK。\n可同时在镜像机器同时抓包确认，此TCP连接相关的数据包没有到达内网中的镜像机。由此推测，此连接被中间设备截获并抢答了。\n其后可执行 curl https://116.7.234.220/ -v -o /dev/null\n本地抓包记录可见，客户端发出TLS Client Hello后，对方会直接返回RST包终止此条TCP连接。镜像机上未见相关的数据包。\n根据观察，RST包被成功触发后，在一段时间内此中间设备便不会再干涉外界与镜像站443端口的通信，能正常建立TLS连接。尝试在443端口进行HTTP请求能正常收到nginx发出的400 Bad Request响应。\n调试结论简述 学校使用的边界防火墙由华为提供（USG9500）。在与厂商的技术人员调试的过程中，我们发现根据ACL规则的匹配记录，在问题发生时，外部发往公网443端口的包似乎不能完成NAT并转发至对应的内网IP。\n针对80端口的ACL计数规则。可见来机客户端、目的地址为镜像站公网IP的报文数量与目的地址为其内网IP的相等（分别对应rule 5和rule 15）\nAdvanced ACL 3001, 4 rules ( Reference counter 1 ) Acl's step is 5 rule 5 permit tcp source 0 destination 116.7.234.220 0 destination-port eq www (16 times matched) rule 10 permit tcp source 116.7.234.220 0 source-port eq www destination 0 (16 times matched) rule 15 permit tcp source 0 destination 0 destination-port eq www (16 times matched) rule 20 permit tcp source 0 source-port eq www destination 0 (16 times matched) 然而针对443端口进行的统计则出现了异常情况，看起来防火墙收到了公网一侧的包，但没有将它发往预想中的镜像站内网IP（见rule 5与rule 15的命中次数差异）\nAdvanced ACL 3001, 4 rules ( Reference counter 1 ) Acl's step is 5 rule 5 permit tcp source 0 destination 116.7.234.220 0 destination-port eq https (3 times matched) rule 10 permit tcp source 116.7.234.220 0 source-port eq https destination 0 (0 times matched) rule 15 permit tcp source 0 destination 0 destination-port eq https (0 times matched) rule 20 permit tcp source 0 source-port eq https destination 0 (0 times matched 当443端口的重置行为被客户发来的TLS Client Hello包触发后，防火墙上针对443端口的统计信息也恢复正常。此现象与443端口的重置问题发生的时机似乎有很强的相关性。\n到此（3月25日下午），华为的驻场工程师已经认识到了问题，并将它反馈给他们内部了。\n3月31日上午，华为的驻场工程师表示他在查防火墙日志时发现一个机制的行为有些可疑，将其关闭后经测试443端口的问题消失。他与学校信息中心老师协商后决定将此功能的阈值调大，经过一些测试，镜像站目前的流量规模似乎不会触发中间人问题了。\n问题似乎已经解决，然而我们暂未得知此功能的具体名称以及预期行为（比如它为什么会对TLS连接进行截获TLS Client Hello的攻击）。尚不清楚未来若镜像站的对外带宽提升，是否会再次受类似的问题影响，\n调试杂项记录 在外界对116.7.234.220发起traceroute，发现对于ICMP包和UDP包最后一个返回ICMP Time Exceeded消息的路由器IP为183.56.64.2或183.56.64.10。推测此跳为深圳电信接入侧的路由器，记它的跳数为N。\n若对TCP 80端口及正常状态下的TCP 443端口使用TCP SYN包进行traceroute测试，可测得响应的SYN ACK包来自第N+3跳，且N+1与N+2跳均不会返回ICMP Time Exceeded消息。\n在问题发生时，TTL为N+1的SYN包即可触发中间设备返回SYN ACK包。此外还可以通过指定socket的TTL值确认\n可使用nmap提供的nping工具构造TCP包并traceroute，如：nping --tcp --traceroute --dest-ip 116.7.234.220 -p 443 --flags syn\nnping在TCP Probe（而非TCP connect）模式下会直接通过raw socket发送已构造的TCP包，内核的TCP栈不会参与。为了避免内核的TCP栈发送RST包干扰中间设备的状态机，在开始测试前可使用iptables规则丢弃发往被测IP的RST包。\niptables -I OUTPUT -p tcp -d 116.7.234.220 --tcp-flags RST RST -j DROP 另外可通过调整socket选项构造出具有特定TTL的TLS Client Hello包，以精确触发问题中间设备的重置行为。使用Python的一个例子：\nimport socket import ssl hostname = '116.7.234.220' context = ssl.create_default_context() N=17 with socket.create_connection((hostname, 443)) as sock: sock.setsockopt(socket.IPPROTO_IP, socket.IP_TTL, N+1) with context.wrap_socket(sock, server_hostname=hostname) as ssock: print(ssock.version()) 值得一提的是，由于运营商可能会在中间路由使用ECMP等负载均衡策略，拥有不同五元组的包在跳数上可能有差异，因此尝试使用TTL定位问题时应当确认中间路由拓扑层级的稳定。\n我们于3月21日按照前述方法进行了测试（使用http协议请求南科大所有对公网开放的服务的443端口，预期情况应为返回400 bad request，如果出现了之前所反馈的问题，请求将一直超时，不过由于我们设置了5秒的timeout时间，因此在请求结果中，请求时间大于5秒的数据，均可以被认为是被学校的防火墙设备干扰了）：\n结果如下如图/表所示（测试每10分钟进行一次，分别从深圳阿里云，深圳电信和香港宽频发起，3月21日大约进行了约700次测试）：\nIP 重置次数 服务性质（猜测） 116.7.234.143 461 网站群服务 116.7.234.50 380 VPN 116.7.234.220 291 镜像站 116.7.234.158 211 健康申报 116.7.234.3 116 官网 116.7.234.184 38 Blackboard 110.65.147.164 13 Blackboard 116.7.234.97 10 110.65.147.163 6 116.7.234.24 5 116.7.234.209 3 116.7.234.94 2 总计 1536 根据华为驻场工程师的说法：\n由于你们的公网只有一个IP，都指向了443端口，流量大了后，会触发防火墙的攻击防范机制，超过了攻击防范机制的默认数值，所以导致了丢弃的情况\n工程师现已调大了攻击防范机制的阈值，链接被重置的情况应该会有较为显著的改善。\n我们将持续跟踪此问题。\n","wordCount":"2753","inLanguage":"zh","image":"https://assets.sparktour.me/img/blog/misc/about-bg.jpg","datePublished":"2021-04-25T12:00:00Z","dateModified":"2024-04-14T21:54:57+08:00","author":{"@type":"Person","name":"sparktour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sparktour.me/posts/2021/04/25/huawei-usg9500-firewall-tls-reset-issue/"},"publisher":{"@type":"Organization","name":"Sparktour's Blog","logo":{"@type":"ImageObject","url":"https://blog.sparktour.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.sparktour.me/ accesskey=h title="Sparktour's Blog (Alt + H)">Sparktour's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.sparktour.me/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.sparktour.me/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.sparktour.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.sparktour.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.sparktour.me/about/ title=About><span>About</span></a></li><li><a href=https://blog.sparktour.me/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.sparktour.me/>主页</a>&nbsp;»&nbsp;<a href=https://blog.sparktour.me/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">处理华为核心防火墙导致的TLS连接重置问题</h1><div class=post-meta><span title='2021-04-25 12:00:00 +0000 UTC'>2021-04-25</span>&nbsp;·&nbsp;<span title='2024-04-14 21:54:57 +0800 +0800'>更新于: 2024-04-14</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;sparktour</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e7%ae%80%e4%bb%8b aria-label=简介>简介</a></li><li><a href=#%e9%97%ae%e9%a2%98%e5%bd%b1%e5%93%8d%e7%9a%84%e8%8c%83%e5%9b%b4 aria-label=问题影响的范围>问题影响的范围</a></li><li><a href=#%e5%a6%82%e4%bd%95%e5%a4%8d%e7%8e%b0 aria-label=如何复现>如何复现</a></li><li><a href=#%e8%b0%83%e8%af%95%e7%bb%93%e8%ae%ba%e7%ae%80%e8%bf%b0 aria-label=调试结论简述>调试结论简述</a></li><li><a href=#%e8%b0%83%e8%af%95%e6%9d%82%e9%a1%b9%e8%ae%b0%e5%bd%95 aria-label=调试杂项记录>调试杂项记录</a></li></ul></div></details></div><div class=post-content><p>本文是2021年4月时，南科大镜像站遇到的TLS连接重置问题的调试存档。一句话概括情况：在校外向镜像站公网v4地址(116.7.234.220)的TCP 443端口发起的首个HTTPS连接会被中间设备(middlebox)抢答并阻断，镜像站主机根本没有收到这条TCP连接相关的数据包。</p><h2 id=简介>简介<a hidden class=anchor aria-hidden=true href=#简介>#</a></h2><p>在校外向镜像站公网v4地址(116.7.234.220)的TCP 443端口发起的首个HTTPS连接会被中间设备(middlebox)抢答并阻断，镜像站主机根本没有收到这条TCP连接相关的数据包。</p><p>在北京时间09:00-24:00这个问题可被重现的概率极高，在凌晨则似乎不易发生。推测与中间设备负载或出口带宽使用率有关。</p><p>中间设备似乎在截获一个TLS Client Hello后便会放行该IP随后向443端口发起的TCP连接。此放行规则的超时时间似乎不定，大致为30分钟至一个半小时。</p><h2 id=问题影响的范围>问题影响的范围<a hidden class=anchor aria-hidden=true href=#问题影响的范围>#</a></h2><p>最早是在镜像站公网IPv4地址的TCP 443端口上观察到的。公网IPv4地址于TCP 80端口提供的HTTP服务及IPv6地址则不受影响。</p><p>随后的测试发现学校电信出口116.7.234.0/24网段下一些IP的443端口同样会受此问题影响，但频率似乎不如镜像站的116.7.234.220高。教育网出口110.65.147.0/24下找到了一个似乎受此问题影响的IP，但在随后申请到的教育网IP上则无法复现。</p><h2 id=如何复现>如何复现<a hidden class=anchor aria-hidden=true href=#如何复现>#</a></h2><p>在客户端启动抓包软件。参考命令：<code>tcpdump -i eth0 -n -w /tmp/test.pcap host 116.7.234.220</code></p><p>然后反复执行下方命令，观察抓包记录。</p><pre tabindex=0><code>curl http://116.7.234.220:443/ --max-time 5 -v -o /dev/null
</code></pre><p>可见TCP握手能正常进行，但客户端发出的HTTP请求却一直不被响应：尽管客户端的TCP栈不断尝试重传承载它的PSH,ACK包，但对方始终不发回ACK。</p><p>可同时在镜像机器同时抓包确认，此TCP连接相关的数据包没有到达内网中的镜像机。由此推测，此连接被中间设备截获并抢答了。</p><p>其后可执行
<code>curl https://116.7.234.220/ -v -o /dev/null</code></p><p>本地抓包记录可见，客户端发出TLS Client Hello后，对方会直接返回RST包终止此条TCP连接。镜像机上未见相关的数据包。</p><p>根据观察，RST包被成功触发后，在一段时间内此中间设备便不会再干涉外界与镜像站443端口的通信，能正常建立TLS连接。尝试在443端口进行HTTP请求能正常收到nginx发出的400 Bad Request响应。</p><h2 id=调试结论简述>调试结论简述<a hidden class=anchor aria-hidden=true href=#调试结论简述>#</a></h2><p>学校使用的边界防火墙由华为提供（<a href=https://e.huawei.com/en/products/security/usg9500>USG9500</a>）。在与厂商的技术人员调试的过程中，我们发现根据ACL规则的匹配记录，在问题发生时，外部发往公网443端口的包似乎不能完成NAT并转发至对应的内网IP。</p><p>针对80端口的ACL计数规则。可见来机客户端、目的地址为镜像站公网IP的报文数量与目的地址为其内网IP的相等（分别对应rule 5和rule 15）</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>Advanced ACL 3001, 4 rules ( Reference counter 1 )
Acl&#39;s step is 5
 rule 5 permit tcp source &lt;client-public-ip&gt; 0 destination 116.7.234.220 0 destination-port eq www (16 times matched)
 rule 10 permit tcp source 116.7.234.220 0 source-port eq www destination &lt;client-public-ip&gt; 0 (16 times matched)
 rule 15 permit tcp source &lt;client-public-ip&gt; 0 destination &lt;mirror-intra-ip&gt; 0 destination-port eq www (16 times matched)
 rule 20 permit tcp source &lt;mirror-intra-ip&gt; 0 source-port eq www destination &lt;client-public-ip&gt; 0 (16 times matched)
</code></pre><p>然而针对443端口进行的统计则出现了异常情况，看起来防火墙收到了公网一侧的包，但没有将它发往预想中的镜像站内网IP（见rule 5与rule 15的命中次数差异）</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>Advanced ACL 3001, 4 rules ( Reference counter 1 )
Acl&#39;s step is 5
 rule 5 permit tcp source &lt;client-public-ip&gt; 0 destination 116.7.234.220 0 destination-port eq https (3 times matched)
 rule 10 permit tcp source 116.7.234.220 0 source-port eq https destination &lt;client-public-ip&gt; 0 (0 times matched)
 rule 15 permit tcp source &lt;client-public-ip&gt; 0 destination &lt;mirror-intra-ip&gt; 0 destination-port eq https (0 times matched)
 rule 20 permit tcp source &lt;mirror-intra-ip&gt; 0 source-port eq https destination &lt;client-public-ip&gt; 0 (0 times matched
</code></pre><p>当443端口的重置行为被客户发来的TLS Client Hello包触发后，防火墙上针对443端口的统计信息也恢复正常。此现象与443端口的重置问题发生的时机似乎有很强的相关性。</p><p>到此（3月25日下午），华为的驻场工程师已经认识到了问题，并将它反馈给他们内部了。</p><p>3月31日上午，华为的驻场工程师表示他在查防火墙日志时发现一个机制的行为有些可疑，将其关闭后经测试443端口的问题消失。他与学校信息中心老师协商后决定将此功能的阈值调大，经过一些测试，镜像站目前的流量规模似乎不会触发中间人问题了。</p><p>问题似乎已经解决，然而我们暂未得知此功能的具体名称以及预期行为（比如它为什么会对TLS连接进行截获TLS Client Hello的攻击）。尚不清楚未来若镜像站的对外带宽提升，是否会再次受类似的问题影响，</p><h2 id=调试杂项记录>调试杂项记录<a hidden class=anchor aria-hidden=true href=#调试杂项记录>#</a></h2><p>在外界对116.7.234.220发起traceroute，发现对于ICMP包和UDP包最后一个返回ICMP Time Exceeded消息的路由器IP为183.56.64.2或183.56.64.10。推测此跳为深圳电信接入侧的路由器，记它的跳数为N。</p><p>若对TCP 80端口及正常状态下的TCP 443端口使用TCP SYN包进行traceroute测试，可测得响应的SYN ACK包来自第N+3跳，且N+1与N+2跳均不会返回ICMP Time Exceeded消息。</p><p>在问题发生时，TTL为N+1的SYN包即可触发中间设备返回SYN ACK包。此外还可以通过指定socket的TTL值确认</p><p>可使用nmap提供的nping工具构造TCP包并traceroute，如：<code>nping --tcp --traceroute --dest-ip 116.7.234.220 -p 443 --flags syn</code></p><p>nping在TCP Probe（而非TCP connect）模式下会直接通过raw socket发送已构造的TCP包，内核的TCP栈不会参与。为了避免内核的TCP栈发送RST包干扰中间设备的状态机，在开始测试前可使用iptables规则丢弃发往被测IP的RST包。</p><pre tabindex=0><code>iptables -I OUTPUT -p tcp -d 116.7.234.220 --tcp-flags RST RST -j DROP
</code></pre><p>另外可通过调整socket选项构造出具有特定TTL的TLS Client Hello包，以精确触发问题中间设备的重置行为。使用Python的一个例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ssl</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hostname</span> <span class=o>=</span> <span class=s1>&#39;116.7.234.220&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span> <span class=o>=</span> <span class=n>ssl</span><span class=o>.</span><span class=n>create_default_context</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>N</span><span class=o>=</span><span class=mi>17</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>socket</span><span class=o>.</span><span class=n>create_connection</span><span class=p>((</span><span class=n>hostname</span><span class=p>,</span> <span class=mi>443</span><span class=p>))</span> <span class=k>as</span> <span class=n>sock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IP</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>IP_TTL</span><span class=p>,</span> <span class=n>N</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>context</span><span class=o>.</span><span class=n>wrap_socket</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>server_hostname</span><span class=o>=</span><span class=n>hostname</span><span class=p>)</span> <span class=k>as</span> <span class=n>ssock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>ssock</span><span class=o>.</span><span class=n>version</span><span class=p>())</span>
</span></span></code></pre></div><p>值得一提的是，由于运营商可能会在中间路由使用ECMP等负载均衡策略，拥有不同五元组的包在跳数上可能有差异，因此尝试使用TTL定位问题时应当确认中间路由拓扑层级的稳定。</p><hr><p>我们于3月21日按照前述方法进行了测试（使用http协议请求南科大所有对公网开放的服务的443端口，预期情况应为返回<code>400 bad request</code>，如果出现了之前所反馈的问题，请求将一直超时，不过由于我们设置了5秒的timeout时间，因此在请求结果中，请求时间大于5秒的数据，均可以被认为是被学校的防火墙设备干扰了）：</p><p>结果如下如图/表所示（测试每10分钟进行一次，分别从深圳阿里云，深圳电信和香港宽频发起，3月21日大约进行了约700次测试）：</p><table><thead><tr><th>IP</th><th>重置次数</th><th>服务性质（猜测）</th></tr></thead><tbody><tr><td>116.7.234.143</td><td>461</td><td>网站群服务</td></tr><tr><td>116.7.234.50</td><td>380</td><td>VPN</td></tr><tr><td>116.7.234.220</td><td>291</td><td>镜像站</td></tr><tr><td>116.7.234.158</td><td>211</td><td>健康申报</td></tr><tr><td>116.7.234.3</td><td>116</td><td>官网</td></tr><tr><td>116.7.234.184</td><td>38</td><td>Blackboard</td></tr><tr><td>110.65.147.164</td><td>13</td><td>Blackboard</td></tr><tr><td>116.7.234.97</td><td>10</td><td></td></tr><tr><td>110.65.147.163</td><td>6</td><td></td></tr><tr><td>116.7.234.24</td><td>5</td><td></td></tr><tr><td>116.7.234.209</td><td>3</td><td></td></tr><tr><td>116.7.234.94</td><td>2</td><td></td></tr><tr><td>总计</td><td>1536</td><td></td></tr></tbody></table><hr><p>根据华为驻场工程师的说法：</p><blockquote><p>由于你们的公网只有一个IP，都指向了443端口，流量大了后，会触发防火墙的攻击防范机制，超过了攻击防范机制的默认数值，所以导致了丢弃的情况</p></blockquote><p>工程师现已调大了攻击防范机制的阈值，链接被重置的情况应该会有较为显著的改善。</p><p>我们将持续跟踪此问题。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.sparktour.me/tags/tech/>Tech</a></li></ul><nav class=paginav><a class=prev href=https://blog.sparktour.me/posts/2021/05/18/trip-to-nanjing/><span class=title>« 上一页</span><br><span>南京出差杂记</span>
</a><a class=next href=https://blog.sparktour.me/posts/2021/04/02/self-host-overleaf/><span class=title>下一页 »</span><br><span>实践自部署Overleaf</span></a></nav></footer><div class="callout callout-default"><img src=https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg alt="CC BY-NC-SA 4.0" style=width:88px;height:31px><p style=font-size:12px>Licensed Under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></p><p style=font-size:12px>Post Link: <a href=https://blog.sparktour.me/posts/2021/04/25/huawei-usg9500-firewall-tls-reset-issue/ target=_blank rel=noopener>https://blog.sparktour.me/posts/2021/04/25/huawei-usg9500-firewall-tls-reset-issue/</a></p></div><script src=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js crossorigin=anonymous></script><div id=disqusjs></div><script>const disqusjs=new DisqusJS({shortname:"sparktour",siteName:"",identifier:"",url:"",title:"",api:"https://disqus.com/api/",apikey:"QhJnXpS5igyHkjYQ91XYC4dSAuEJYAEsHX8hjLrRc1HU9AApOHLrqkwwIp2sKOLk",admin:"",adminLabel:""});disqusjs.render(document.getElementById("disqusjs"))</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.sparktour.me/>Sparktour's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>