<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>自建OpenStreetmap地图瓦片服务 | Sparktour's Blog</title><meta name=keywords content="openstreetsmap,tile"><meta name=description content="自建OpenStreetsmap地图瓦片服务

    
    地图显示效果


迫于openstreetsmap官方的瓦片服务器（tile server）速度太慢，而提供矢量瓦片（vector tile）服务的mapbox和maptiler的免费额度太少，更新慢。笔者最近尝试基于tileserver-gl，openmaptiles和tilemaker等工具自建了一个openstreetsmap的地图瓦片服务器。"><meta name=author content="sparktour"><link rel=canonical href=https://blog.sparktour.me/posts/2021/08/03/self-host-openstreetmap-tiles-server/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.sparktour.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.sparktour.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.sparktour.me/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.sparktour.me/apple-touch-icon.png><link rel=mask-icon href=https://blog.sparktour.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.sparktour.me/posts/2021/08/03/self-host-openstreetmap-tiles-server/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://blog.sparktour.me/scss/callout.css><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-6EJ4YX1XZ8"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6EJ4YX1XZ8")}</script><meta property="og:url" content="https://blog.sparktour.me/posts/2021/08/03/self-host-openstreetmap-tiles-server/"><meta property="og:site_name" content="Sparktour's Blog"><meta property="og:title" content="自建OpenStreetmap地图瓦片服务"><meta property="og:description" content="自建OpenStreetsmap地图瓦片服务 地图显示效果 迫于openstreetsmap官方的瓦片服务器（tile server）速度太慢，而提供矢量瓦片（vector tile）服务的mapbox和maptiler的免费额度太少，更新慢。笔者最近尝试基于tileserver-gl，openmaptiles和tilemaker等工具自建了一个openstreetsmap的地图瓦片服务器。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-03T18:00:00+00:00"><meta property="article:modified_time" content="2024-04-18T18:30:45+08:00"><meta property="article:tag" content="Openstreetsmap"><meta property="article:tag" content="Tile"><meta property="og:image" content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://assets.sparktour.me/img/blog/misc/about-bg.jpg"><meta name=twitter:title content="自建OpenStreetmap地图瓦片服务"><meta name=twitter:description content="自建OpenStreetsmap地图瓦片服务

    
    地图显示效果


迫于openstreetsmap官方的瓦片服务器（tile server）速度太慢，而提供矢量瓦片（vector tile）服务的mapbox和maptiler的免费额度太少，更新慢。笔者最近尝试基于tileserver-gl，openmaptiles和tilemaker等工具自建了一个openstreetsmap的地图瓦片服务器。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.sparktour.me/posts/"},{"@type":"ListItem","position":2,"name":"自建OpenStreetmap地图瓦片服务","item":"https://blog.sparktour.me/posts/2021/08/03/self-host-openstreetmap-tiles-server/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"自建OpenStreetmap地图瓦片服务","name":"自建OpenStreetmap地图瓦片服务","description":"自建OpenStreetsmap地图瓦片服务 地图显示效果 迫于openstreetsmap官方的瓦片服务器（tile server）速度太慢，而提供矢量瓦片（vector tile）服务的mapbox和maptiler的免费额度太少，更新慢。笔者最近尝试基于tileserver-gl，openmaptiles和tilemaker等工具自建了一个openstreetsmap的地图瓦片服务器。\n","keywords":["openstreetsmap","tile"],"articleBody":"自建OpenStreetsmap地图瓦片服务 地图显示效果 迫于openstreetsmap官方的瓦片服务器（tile server）速度太慢，而提供矢量瓦片（vector tile）服务的mapbox和maptiler的免费额度太少，更新慢。笔者最近尝试基于tileserver-gl，openmaptiles和tilemaker等工具自建了一个openstreetsmap的地图瓦片服务器。\n数据准备 我们所需的地图数据有两种格式，分别为pbf和mbtiles。其中，mbtiles格式是可以直接被tileserver-gl使用的，而pbf格式需要转换为mbtiles之后才能被tileserver-gl读取。\nmbtiles 如果希望快速搭建地图服务器，我们可以直接在https://extract.bbbike.org/这个网站上选择自己想要的区域并下载。下载时格式选择MB Vector Tiles Openmaptiles即可。**但这样下载下来的mbtiles只有地标的name字段，其他的翻译全部丢失了。**如果不介意这一点，可以在下载完后直接跳到「服务搭建」一节。\nPBF 如果希望下载带有完整数据的PBF文件进行修改，我们可以在网站上选择下载PBF格式的地图，或者去 https://download.geofabrik.de/ 上按照国家下载PBF格式的地图。\n转换格式 转换格式可以用两个软件，分别是tilemaker和openmaptiles。tilemaker的转换速度很快，不过转换出的mbtiles地图还是有上一节提到的「丢失属性」的问题，而openmaptiler在属性保留这一方面做的很好，而且还能从wikidata里自动下载对应地点的翻译（可选），不过转换的速度很慢。\n根据笔者自己测试的转换速度比较，转换的是https://download.geofabrik.de/上下载的中国大陆地区地图，文件大小大约900M，用一台96C372G的机器进行转换。tilemaker转换用了大约半小时，而openmaptiler花了12个小时左右。转换完之后的mbtiles大小约3.5G。\n使用tilemaker转换 首先下载tilemaker的二进制文件，之后准备好输入的文件，进行转换即可，机器可能需要安装luajit，sqlite3，shapelib等依赖。：\n/root/build/tilemaker --input /data/asia.osm.pbf --output /data/asia.mbtiles --config /root/resources/config-openmaptiles.json --process /root/resources/process-openmaptiles.lua 其中，json配置文件和lua文件直接使用发行版自带的配置文件即可，ZOOM的值最大使用14即可，更大的值不会带来更多的细节。\n使用openmaptiles转换 参考openmaptiles的README进行转换即可，机器需要预装docker和docker-compose，具体依赖可以参考这里。首先clone repo，之后在目录中执行（以下的几步需要拉取若干个docker镜像，加起来大约有10G，加上处理的数据，需要在磁盘中至少预留30G的空间比较保险）：\n（可选）如果要拉取维基百科的数据，则需要给docker添加代理。在.env中添加：\nhttp_proxy: http://192.168.59.100:8118 https_proxy: http://192.168.59.100:8118 HTTP_PROXY: http://192.168.59.100:8118 HTTPS_PROXY: http://192.168.59.100:8118 （可选）如果PBF数据是从bbbike上切出来的，需要预处理一下数据的边界（mydata即下载下来的数据文件名）：\nmkdir -p data mv mydata.osm.pbf data/ make generate-bbox-file area=mydata ./quickstart.sh mydata 如果需要增大执行数据库操作和地图切割操作的线程，可以更改.env里的MAX_PARALLEL_PSQL和COPY_CONCURRENCY。\n初始化数据文件夹：\nmake 准备数据库：\nmake start-db 导入PBF的数据：\nmake import-data 导入边界数据：\nmake import-osm make import-borders （可选）\n导入维基百科的附加数据：\nmake import-wikidata 清理数据库：\nmake clean make make import-sql 生成地图边界：\nmake generate-bbox-file # compute data bbox -- not needed for the whole planet 生成mbtiles文件：\nmake generate-tiles # generate tiles 执行完成之后，在data文件夹下就能看到一个名为tiles.mbtiles的地图数据文件，复制出来即可。\n服务搭建 笔者自己的配置文件repo：https://github.com/sparkcyf/tileserver-gl-config\n将中文字体的repo（用于瓦片地图渲染中文）：https://github.com/klokantech/klokantech-gl-fonts.git ，将repo中的KlokanTech Noto Sans CJK Regular重命名成Noto Sans Regular，并放入下面提到的fonts文件夹。\n将前面的到的tiles.mbtiles地图数据文件放入相应的data文件夹。\n随后使用repo中的docker-compose文件拉起容器，注意修改配置路径为自己的路径：\nversion: '3.3' services: tileserver-gl: image: maptiler/tileserver-gl:latest build: . command: --public_url https://example.com/osm-tile/ --no-cors --config /config/config.json ports: - \"58085:8080\" volumes: - '/data/mirrors-zfs/cra-service/vector-tile-server/map:/data' - '/data/mirrors-zfs/cra-service/vector-tile-server/config:/config' - '/data/mirrors-zfs/cra-service/vector-tile-server/style/styles:/app/node_modules/tileserver-gl-styles/styles' - '/data/mirrors-zfs/cra-service/vector-tile-server/style/fonts:/app/node_modules/tileserver-gl-styles/fonts' docker compose中提到的styles，config等文件都已经放在了上面的repo中了。另外记得修改--public_url后面的值，以及docker暴露出来的端口。\n**如果修改了样式文件或配置文件，重启容器即可重载配置。**有关tileserver-gl的更多用法，可以参考这里：https://tileserver.readthedocs.io/en/latest/\n（可选）修改sprite 在部分的样式文件中，一些图标（比如麦当劳，肯德基，高速公路标志等）需要从外联的样式文件加载，可能会造成瓦片地图渲染缓慢。如果需要替换成本地文件或网络上的其他文件，可以修改样式json文件中的\"sprite\"一节。sprite文件的具体类型可以参考这个repo。\nsprite数据中的图标 全部配置完成之后，运行docker-compose up，等待镜像被拉起即可查看地图了。\n如果打开地图时发现地图是空的，有可能是因为你并没有下载地图对应位置的数据，这时修改url末尾的经纬度即可（下面的url中# 后面的那一串，分别是缩放级别/纬度/经度）：\nexample.com/osm-tile/styles/osm-street/#11.16/22.5429/114.0402 在其他地图中引用瓦片服务器 可以参考mapbox写的这个例子，更改style变量即可：\n\u003c!DOCTYPE html\u003e \u003chtml\u003e \u003chead\u003e \u003cmeta name=\"viewport\" content=\"initial-scale=1,maximum-scale=1,user-scalable=no\" /\u003e \u003cscript src=\"https://cdn.maptiler.com/mapbox-gl-js/v1.5.1/mapbox-gl.js\"\u003e\u003c/script\u003e \u003clink href=\"https://cdn.maptiler.com/mapbox-gl-js/v1.5.1/mapbox-gl.css\" rel=\"stylesheet\" /\u003e \u003clink href=\"/static/css/cloud_base.css?t=1627890485\" rel=\"stylesheet\" /\u003e \u003cstyle\u003e #map {position: absolute; top: 0; right: 0; bottom: 0; left: 0;} \u003c/style\u003e \u003c/head\u003e \u003cbody\u003e \u003cdiv id=\"map\"\u003e \u003ca href=\"https://www.maptiler.com\" style=\"position:absolute;left:10px;bottom:10px;z-index:999;\"\u003e\u003cimg src=\"https://api.maptiler.com/resources/logo.svg\" alt=\"MapTiler logo\"\u003e\u003c/a\u003e \u003c/div\u003e \u003cp\u003e\u003ca href=\"https://www.maptiler.com/copyright/\" target=\"_blank\"\u003e\u0026copy; MapTiler\u003c/a\u003e \u003ca href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\"\u003e\u0026copy; OpenStreetMap contributors\u003c/a\u003e\u003c/p\u003e \u003cscript\u003e // You can remove the following line if you don't need support for RTL (right-to-left) labels: mapboxgl.setRTLTextPlugin('https://cdn.maptiler.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.1.2/mapbox-gl-rtl-text.js'); var map = new mapboxgl.Map({ container: 'map', style: 'https://example.com/path/styles/your-style/style.json', center: [113.99548, 22.60003], zoom: 15.92 }); map.addControl(new MapboxLanguage({ defaultLanguage: 'en' })); \u003c/script\u003e \u003c/body\u003e \u003c/html\u003e https://github.com/systemed/tilemaker/issues/187\n参考文档 https://blog.csdn.net/fbvukn/article/details/109072579 https://stackoverflow.com/questions/65849406/is-there-a-way-to-generate-a-mbtiles-file-from-osm-pbf-file https://blog.kleunen.nl/blog/tilemaker-generate-map （如何转换PBF到mbtiles） https://yasoob.me/posts/custom-map-with-tileserver-gl/ （如何配置tileserver-gl的config.json） ","wordCount":"2494","inLanguage":"zh","image":"https://assets.sparktour.me/img/blog/misc/about-bg.jpg","datePublished":"2021-08-03T18:00:00Z","dateModified":"2024-04-18T18:30:45+08:00","author":{"@type":"Person","name":"sparktour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sparktour.me/posts/2021/08/03/self-host-openstreetmap-tiles-server/"},"publisher":{"@type":"Organization","name":"Sparktour's Blog","logo":{"@type":"ImageObject","url":"https://blog.sparktour.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.sparktour.me/ accesskey=h title="Sparktour's Blog (Alt + H)">Sparktour's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.sparktour.me/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.sparktour.me/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.sparktour.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.sparktour.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.sparktour.me/about/ title=About><span>About</span></a></li><li><a href=https://blog.sparktour.me/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.sparktour.me/>主页</a>&nbsp;»&nbsp;<a href=https://blog.sparktour.me/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">自建OpenStreetmap地图瓦片服务</h1><div class=post-meta><span title='2021-08-03 18:00:00 +0000 UTC'>2021-08-03</span>&nbsp;·&nbsp;<span title='2024-04-18 18:30:45 +0800 +0800'>更新于: 2024-04-18</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;sparktour</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e8%87%aa%e5%bb%baopenstreetsmap%e5%9c%b0%e5%9b%be%e7%93%a6%e7%89%87%e6%9c%8d%e5%8a%a1 aria-label=自建OpenStreetsmap地图瓦片服务>自建OpenStreetsmap地图瓦片服务</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e5%87%86%e5%a4%87 aria-label=数据准备>数据准备</a><ul><li><a href=#mbtiles aria-label=mbtiles>mbtiles</a></li><li><a href=#pbf aria-label=PBF>PBF</a></li></ul></li><li><a href=#%e8%bd%ac%e6%8d%a2%e6%a0%bc%e5%bc%8f aria-label=转换格式>转换格式</a><ul><li><a href=#%e4%bd%bf%e7%94%a8tilemaker%e8%bd%ac%e6%8d%a2 aria-label=使用tilemaker转换>使用tilemaker转换</a></li><li><a href=#%e4%bd%bf%e7%94%a8openmaptiles%e8%bd%ac%e6%8d%a2 aria-label=使用openmaptiles转换>使用openmaptiles转换</a></li></ul></li><li><a href=#%e6%9c%8d%e5%8a%a1%e6%90%ad%e5%bb%ba aria-label=服务搭建>服务搭建</a><ul><li><a href=#%e5%8f%af%e9%80%89%e4%bf%ae%e6%94%b9sprite aria-label=（可选）修改sprite>（可选）修改sprite</a></li></ul></li><li><a href=#%e5%9c%a8%e5%85%b6%e4%bb%96%e5%9c%b0%e5%9b%be%e4%b8%ad%e5%bc%95%e7%94%a8%e7%93%a6%e7%89%87%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=在其他地图中引用瓦片服务器>在其他地图中引用瓦片服务器</a></li><li><a href=#%e5%8f%82%e8%80%83%e6%96%87%e6%a1%a3 aria-label=参考文档>参考文档</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=自建openstreetsmap地图瓦片服务>自建OpenStreetsmap地图瓦片服务<a hidden class=anchor aria-hidden=true href=#自建openstreetsmap地图瓦片服务>#</a></h1><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2021/self-host-openstreetmap-tiles-server/banner.jpg alt=地图显示效果><figcaption>地图显示效果</figcaption></figure></p><p>迫于openstreetsmap官方的瓦片服务器（tile server）速度太慢，而提供矢量瓦片（vector tile）服务的mapbox和maptiler的免费额度太少，更新慢。笔者最近尝试基于tileserver-gl，openmaptiles和tilemaker等工具自建了一个openstreetsmap的地图瓦片服务器。</p><h2 id=数据准备>数据准备<a hidden class=anchor aria-hidden=true href=#数据准备>#</a></h2><p>我们所需的地图数据有两种格式，分别为pbf和mbtiles。其中，mbtiles格式是可以直接被tileserver-gl使用的，而pbf格式需要转换为mbtiles之后才能被tileserver-gl读取。</p><h3 id=mbtiles>mbtiles<a hidden class=anchor aria-hidden=true href=#mbtiles>#</a></h3><p>如果希望快速搭建地图服务器，我们可以直接在<a href=https://extract.bbbike.org/>https://extract.bbbike.org/</a>这个网站上选择自己想要的区域并下载。下载时格式选择<code>MB Vector Tiles Openmaptiles</code>即可。**但这样下载下来的mbtiles只有地标的<code>name</code>字段，其他的翻译全部丢失了。**如果不介意这一点，可以在下载完后直接跳到「服务搭建」一节。</p><h3 id=pbf>PBF<a hidden class=anchor aria-hidden=true href=#pbf>#</a></h3><p>如果希望下载带有完整数据的PBF文件进行修改，我们可以在网站上选择下载PBF格式的地图，或者去 <a href=https://download.geofabrik.de/>https://download.geofabrik.de/</a> 上按照国家下载PBF格式的地图。</p><h2 id=转换格式>转换格式<a hidden class=anchor aria-hidden=true href=#转换格式>#</a></h2><p>转换格式可以用两个软件，分别是<a href=https://github.com/systemed/tilemaker>tilemaker</a>和<a href=https://github.com/openmaptiles/openmaptiles>openmaptiles</a>。tilemaker的转换速度很快，不过转换出的mbtiles地图还是有上一节提到的「丢失属性」的问题，而openmaptiler在属性保留这一方面做的很好，而且还能从wikidata里自动下载对应地点的翻译（可选），不过转换的速度很慢。</p><p><strong>根据笔者自己测试的转换速度比较，转换的是<a href=https://download.geofabrik.de/>https://download.geofabrik.de/</a>上下载的中国大陆地区地图，文件大小大约900M，用一台96C372G的机器进行转换。tilemaker转换用了大约半小时，而openmaptiler花了12个小时左右。转换完之后的mbtiles大小约3.5G。</strong></p><h3 id=使用tilemaker转换>使用tilemaker转换<a hidden class=anchor aria-hidden=true href=#使用tilemaker转换>#</a></h3><p>首先下载<a href=https://github.com/systemed/tilemaker/releases/tag/v2.0.0>tilemaker的二进制文件</a>，之后准备好输入的文件，进行转换即可，机器可能需要安装<code>luajit</code>，<code>sqlite3</code>，<code>shapelib</code>等依赖。：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/root/build/tilemaker --input /data/asia.osm.pbf --output /data/asia.mbtiles --config /root/resources/config-openmaptiles.json --process /root/resources/process-openmaptiles.lua
</span></span></code></pre></div><p>其中，json配置文件和lua文件直接使用发行版自带的配置文件即可，<strong><code>ZOOM</code>的值最大使用14即可，更大的值不会带来更多的细节</strong>。</p><h3 id=使用openmaptiles转换>使用openmaptiles转换<a hidden class=anchor aria-hidden=true href=#使用openmaptiles转换>#</a></h3><p>参考<a href=https://github.com/openmaptiles/openmaptiles>openmaptiles</a>的README进行转换即可，机器需要预装<code>docker</code>和<code>docker-compose</code>，具体依赖可以参考<a href=https://github.com/openmaptiles/openmaptiles/blob/master/QUICKSTART.md>这里</a>。首先clone repo，之后在目录中执行（<strong>以下的几步需要拉取若干个docker镜像，加起来大约有10G，加上处理的数据，需要在磁盘中至少预留30G的空间比较保险</strong>）：</p><p>（可选）如果要拉取维基百科的数据，则需要给docker添加代理。在<code>.env</code>中添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>http_proxy</span><span class=p>:</span><span class=w> </span><span class=l>http://192.168.59.100:8118</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>https_proxy</span><span class=p>:</span><span class=w> </span><span class=l>http://192.168.59.100:8118</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>HTTP_PROXY</span><span class=p>:</span><span class=w> </span><span class=l>http://192.168.59.100:8118</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>HTTPS_PROXY</span><span class=p>:</span><span class=w> </span><span class=l>http://192.168.59.100:8118</span><span class=w>
</span></span></span></code></pre></div><p>（可选）如果PBF数据是从bbbike上切出来的，需要预处理一下数据的边界（mydata即下载下来的数据文件名）：</p><pre tabindex=0><code>mkdir -p data
mv mydata.osm.pbf data/
make generate-bbox-file area=mydata
./quickstart.sh mydata
</code></pre><p>如果需要增大执行数据库操作和地图切割操作的线程，可以更改<code>.env</code>里的<code>MAX_PARALLEL_PSQL</code>和<code>COPY_CONCURRENCY</code>。</p><p>初始化数据文件夹：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make
</span></span></code></pre></div><p>准备数据库：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make start-db
</span></span></code></pre></div><p>导入PBF的数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make import-data
</span></span></code></pre></div><p>导入边界数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make import-osm
</span></span><span class=line><span class=cl>make import-borders
</span></span></code></pre></div><p>（可选）</p><p>导入维基百科的附加数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make import-wikidata
</span></span></code></pre></div><p>清理数据库：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make clean
</span></span><span class=line><span class=cl>make
</span></span><span class=line><span class=cl>make import-sql
</span></span></code></pre></div><p>生成地图边界：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make generate-bbox-file  <span class=c1># compute data bbox -- not needed for the whole planet</span>
</span></span></code></pre></div><p>生成<code>mbtiles</code>文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make generate-tiles      <span class=c1># generate tiles</span>
</span></span></code></pre></div><p>执行完成之后，在<code>data</code>文件夹下就能看到一个名为<code>tiles.mbtiles</code>的地图数据文件，复制出来即可。</p><h2 id=服务搭建>服务搭建<a hidden class=anchor aria-hidden=true href=#服务搭建>#</a></h2><ul><li><p><strong>笔者自己的配置文件repo：<a href=https://github.com/sparkcyf/tileserver-gl-config>https://github.com/sparkcyf/tileserver-gl-config</a></strong></p></li><li><p>将中文字体的repo（用于瓦片地图渲染中文）：<a href=https://github.com/klokantech/klokantech-gl-fonts.git>https://github.com/klokantech/klokantech-gl-fonts.git</a> ，将repo中的<code>KlokanTech Noto Sans CJK Regular</code>重命名成<code>Noto Sans Regular</code>，并放入下面提到的fonts文件夹。</p></li><li><p>将前面的到的<code>tiles.mbtiles</code>地图数据文件放入相应的<code>data</code>文件夹。</p></li></ul><p>随后使用repo中的docker-compose文件拉起容器，注意修改配置路径为自己的路径：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tileserver-gl</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>maptiler/tileserver-gl:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span>--<span class=l>public_url https://example.com/osm-tile/ --no-cors --config /config/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;58085:8080&#34;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;/data/mirrors-zfs/cra-service/vector-tile-server/map:/data&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;/data/mirrors-zfs/cra-service/vector-tile-server/config:/config&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;/data/mirrors-zfs/cra-service/vector-tile-server/style/styles:/app/node_modules/tileserver-gl-styles/styles&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;/data/mirrors-zfs/cra-service/vector-tile-server/style/fonts:/app/node_modules/tileserver-gl-styles/fonts&#39;</span><span class=w>
</span></span></span></code></pre></div><p>docker compose中提到的styles，config等文件都已经放在了上面的repo中了。另外记得修改<code>--public_url</code>后面的值，以及docker暴露出来的端口。</p><p>**如果修改了样式文件或配置文件，重启容器即可重载配置。**有关tileserver-gl的更多用法，可以参考这里：<a href=https://tileserver.readthedocs.io/en/latest/>https://tileserver.readthedocs.io/en/latest/</a></p><h3 id=可选修改sprite>（可选）修改sprite<a hidden class=anchor aria-hidden=true href=#可选修改sprite>#</a></h3><p>在部分的样式文件中，一些图标（比如麦当劳，肯德基，高速公路标志等）需要从外联的样式文件加载，可能会造成瓦片地图渲染缓慢。如果需要替换成本地文件或网络上的其他文件，可以修改样式json文件中的<code>"sprite"</code>一节。sprite文件的具体类型可以参考<a href=https://github.com/openmaptiles/osm-bright-gl-style/tree/gh-pages>这个repo</a>。</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2021/self-host-openstreetmap-tiles-server/sprite.png alt=sprite数据中的图标><figcaption>sprite数据中的图标</figcaption></figure></p><p>全部配置完成之后，运行<code>docker-compose up</code>，等待镜像被拉起即可查看地图了。</p><p>如果打开地图时发现地图是空的，有可能是因为你并没有下载地图对应位置的数据，这时修改url末尾的经纬度即可（下面的url中<code># </code>后面的那一串，分别是缩放级别/纬度/经度）：</p><pre tabindex=0><code>example.com/osm-tile/styles/osm-street/#11.16/22.5429/114.0402
</code></pre><h2 id=在其他地图中引用瓦片服务器>在其他地图中引用瓦片服务器<a hidden class=anchor aria-hidden=true href=#在其他地图中引用瓦片服务器>#</a></h2><p>可以参考mapbox写的这个例子，更改<code>style</code>变量即可：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;initial-scale=1,maximum-scale=1,user-scalable=no&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.maptiler.com/mapbox-gl-js/v1.5.1/mapbox-gl.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>link</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://cdn.maptiler.com/mapbox-gl-js/v1.5.1/mapbox-gl.css&#34;</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;stylesheet&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>link</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/static/css/cloud_base.css?t=1627890485&#34;</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;stylesheet&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>#</span><span class=nn>map</span> <span class=p>{</span><span class=k>position</span><span class=p>:</span> <span class=kc>absolute</span><span class=p>;</span> <span class=k>top</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span> <span class=k>right</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span> <span class=k>bottom</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span> <span class=k>left</span><span class=p>:</span> <span class=mi>0</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;map&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://www.maptiler.com&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;position:absolute;left:10px;bottom:10px;z-index:999;&#34;</span><span class=p>&gt;&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://api.maptiler.com/resources/logo.svg&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;MapTiler logo&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://www.maptiler.com/copyright/&#34;</span> <span class=na>target</span><span class=o>=</span><span class=s>&#34;_blank&#34;</span><span class=p>&gt;</span><span class=ni>&amp;copy;</span> MapTiler<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://www.openstreetmap.org/copyright&#34;</span> <span class=na>target</span><span class=o>=</span><span class=s>&#34;_blank&#34;</span><span class=p>&gt;</span><span class=ni>&amp;copy;</span> OpenStreetMap contributors<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// You can remove the following line if you don&#39;t need support for RTL (right-to-left) labels:
</span></span></span><span class=line><span class=cl>    <span class=nx>mapboxgl</span><span class=p>.</span><span class=nx>setRTLTextPlugin</span><span class=p>(</span><span class=s1>&#39;https://cdn.maptiler.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.1.2/mapbox-gl-rtl-text.js&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>map</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>mapboxgl</span><span class=p>.</span><span class=nx>Map</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>container</span><span class=o>:</span> <span class=s1>&#39;map&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>style</span><span class=o>:</span> <span class=s1>&#39;https://example.com/path/styles/your-style/style.json&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>center</span><span class=o>:</span> <span class=p>[</span><span class=mf>113.99548</span><span class=p>,</span> <span class=mf>22.60003</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>zoom</span><span class=o>:</span> <span class=mf>15.92</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>map</span><span class=p>.</span><span class=nx>addControl</span><span class=p>(</span><span class=k>new</span> <span class=nx>MapboxLanguage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>defaultLanguage</span><span class=o>:</span> <span class=s1>&#39;en&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}));</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p><a href=https://github.com/systemed/tilemaker/issues/187>https://github.com/systemed/tilemaker/issues/187</a></p><h2 id=参考文档>参考文档<a hidden class=anchor aria-hidden=true href=#参考文档>#</a></h2><ul><li><a href=https://blog.csdn.net/fbvukn/article/details/109072579>https://blog.csdn.net/fbvukn/article/details/109072579</a></li><li><a href=https://stackoverflow.com/questions/65849406/is-there-a-way-to-generate-a-mbtiles-file-from-osm-pbf-file>https://stackoverflow.com/questions/65849406/is-there-a-way-to-generate-a-mbtiles-file-from-osm-pbf-file</a></li><li><a href=https://blog.kleunen.nl/blog/tilemaker-generate-map>https://blog.kleunen.nl/blog/tilemaker-generate-map</a> （如何转换PBF到mbtiles）</li><li><a href=https://yasoob.me/posts/custom-map-with-tileserver-gl/>https://yasoob.me/posts/custom-map-with-tileserver-gl/</a> （如何配置tileserver-gl的config.json）</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.sparktour.me/tags/openstreetsmap/>Openstreetsmap</a></li><li><a href=https://blog.sparktour.me/tags/tile/>Tile</a></li></ul><nav class=paginav><a class=prev href=https://blog.sparktour.me/posts/2021/08/10/tencent-intern-conclusion/><span class=title>« 上一页</span><br><span>腾讯实习小结：你走过的路都将会在未来发挥意想不到的作用</span>
</a><a class=next href=https://blog.sparktour.me/posts/2021/07/31/mainland2hk-prepare-quarantine/><span class=title>下一页 »</span><br><span>中国大陆赴港隔离备忘录</span></a></nav></footer><div class="callout callout-default"><img src=https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg alt="CC BY-NC-SA 4.0" style=width:88px;height:31px><p style=font-size:12px>Licensed Under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></p><p style=font-size:12px>Post Link: <a href=https://blog.sparktour.me/posts/2021/08/03/self-host-openstreetmap-tiles-server/ target=_blank rel=noopener>https://blog.sparktour.me/posts/2021/08/03/self-host-openstreetmap-tiles-server/</a></p></div><script src=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js crossorigin=anonymous></script><div id=disqusjs></div><script>const disqusjs=new DisqusJS({shortname:"sparktour",siteName:"",identifier:"",url:"",title:"",api:"https://disqus.com/api/",apikey:"QhJnXpS5igyHkjYQ91XYC4dSAuEJYAEsHX8hjLrRc1HU9AApOHLrqkwwIp2sKOLk",admin:"",adminLabel:""});disqusjs.render(document.getElementById("disqusjs"))</script></article></main><footer class=footer><span>&copy; 2026 <a href=https://blog.sparktour.me/>Sparktour's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>