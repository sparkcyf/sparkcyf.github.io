<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>自建OpenStreetmap地图瓦片服务：迁移mbtiles到pmtiles | Sparktour's Blog</title><meta name=keywords content="openstreetsmap,protomaps,tile"><meta name=description content="笔者注意到了一些GIS开源项目在使用的Protomaps项目，以及他们提出的pmtiles格式。如Protomaps的发起人给博客起的标题《Dynamic Maps, Static Storage》那样，pmtiles的一大优势是如果不需要raster tiles，服务端不再需要安装任何软件，只需要一个“Static Storage”即可，无需任何后端软件对地图数据进行处理。"><meta name=author content="sparktour"><link rel=canonical href=https://blog.sparktour.me/posts/2025/01/15/self-host-protomaps-tiles-server/><link crossorigin=anonymous href=/assets/css/stylesheet.93f625d739f1d6a5c6f20c146bc6a8d26b233492b34b2220c54b12fd46a04ded.css integrity="sha256-k/Yl1znx1qXG8gwUa8ao0msjNJKzSyIgxUsS/UagTe0=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.sparktour.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.sparktour.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.sparktour.me/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.sparktour.me/apple-touch-icon.png><link rel=mask-icon href=https://blog.sparktour.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://blog.sparktour.me/posts/2025/01/15/self-host-protomaps-tiles-server/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://blog.sparktour.me/scss/callout.css><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-6EJ4YX1XZ8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6EJ4YX1XZ8")}</script><meta property="og:url" content="https://blog.sparktour.me/posts/2025/01/15/self-host-protomaps-tiles-server/"><meta property="og:site_name" content="Sparktour's Blog"><meta property="og:title" content="自建OpenStreetmap地图瓦片服务：迁移mbtiles到pmtiles"><meta property="og:description" content="笔者注意到了一些GIS开源项目在使用的Protomaps项目，以及他们提出的pmtiles格式。如Protomaps的发起人给博客起的标题《Dynamic Maps, Static Storage》那样，pmtiles的一大优势是如果不需要raster tiles，服务端不再需要安装任何软件，只需要一个“Static Storage”即可，无需任何后端软件对地图数据进行处理。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-15T18:00:00+00:00"><meta property="article:modified_time" content="2025-01-16T12:34:42+08:00"><meta property="article:tag" content="Openstreetsmap"><meta property="article:tag" content="Protomaps"><meta property="article:tag" content="Tile"><meta property="og:image" content="https://assets.sparktour.me/img/blog/2025/self-host-protomaps-tiles-server/protomaps-1.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://assets.sparktour.me/img/blog/2025/self-host-protomaps-tiles-server/protomaps-1.jpg"><meta name=twitter:title content="自建OpenStreetmap地图瓦片服务：迁移mbtiles到pmtiles"><meta name=twitter:description content="笔者注意到了一些GIS开源项目在使用的Protomaps项目，以及他们提出的pmtiles格式。如Protomaps的发起人给博客起的标题《Dynamic Maps, Static Storage》那样，pmtiles的一大优势是如果不需要raster tiles，服务端不再需要安装任何软件，只需要一个“Static Storage”即可，无需任何后端软件对地图数据进行处理。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.sparktour.me/posts/"},{"@type":"ListItem","position":2,"name":"自建OpenStreetmap地图瓦片服务：迁移mbtiles到pmtiles","item":"https://blog.sparktour.me/posts/2025/01/15/self-host-protomaps-tiles-server/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"自建OpenStreetmap地图瓦片服务：迁移mbtiles到pmtiles","name":"自建OpenStreetmap地图瓦片服务：迁移mbtiles到pmtiles","description":"笔者注意到了一些GIS开源项目在使用的Protomaps项目，以及他们提出的pmtiles格式。如Protomaps的发起人给博客起的标题《Dynamic Maps, Static Storage》那样，pmtiles的一大优势是如果不需要raster tiles，服务端不再需要安装任何软件，只需要一个“Static Storage”即可，无需任何后端软件对地图数据进行处理。","keywords":["openstreetsmap","protomaps","tile"],"articleBody":"前言 笔者曾在三年前写过一篇如何self host基于OpenStreetmap数据的博客。在当时的文章里，笔者使用的后端是maptiler开发的的tileserver-gl。它需要一个转换好的mbtiles文件，才能正常serve地图。但遗憾的是，maptiler把下载转换好的地图作为一项商业服务提供，我们只能自己使用maptiler提供的openmaptiles对地图进行转换。由于mbtiles的本质是基于sqlite的地图数据库，使用openmaptiles制作地图的速度相当缓慢（在一台48C256G的机器上转换全世界的地图大概需要一整天的时间，并且对磁盘的IO有较高的要求），host地图也需要使用tileserver-gl处理请求，将mbtiles里的数据转换成pbf格式发送给客户端。\n直到最近，笔者注意到了一些GIS开源项目在使用的Protomaps项目，以及他们提出的pmtiles格式。如Protomaps的发起人给博客起的标题《Dynamic Maps, Static Storage》那样，pmtiles的一大优势是如果不需要raster tiles，服务端不再需要安装任何软件，只需要一个“Static Storage”即可（无需任何后端软件对地图数据进行处理）。确切的说，一个支持HTTP Range的服务器。包括nginx，caddy等常见的web服务器和S3服务理论上都是支持这项特性的。\npmtiles格式的设计理念 Pmtiles的格式设计巧妙的利用了HTTP Range的特性。如下图所示，它将图块数据的索引放在了文件的头部，因此客户端只要先对文件的头部进行查询，得到图块索引后，根据Z、X、Y找到对应的数据range，最后再使用HTTP Range请求对应的数据块即可。\npmtiles格式的设计理念，来自Protomaps博客 获取一个图块的过程如下（假设我们要获取z:8 x:65 y:95）：\n获取前 512 千字节并将目录解析为索引 在这种情况下，通过您想要的图块的键查找8_65_95 匹配成功！您将获得一个Rangeoffset: 785366 length: 21400 使用HTTP Range获取这些字节Range:bytes=785366-806765并将数据解析为图像 但值得注意的是，当整个文件足够大的时候，图块索引本身也可能占用大量的体积（如博客文章所说，如果我们要存储1-15这15个缩放登记的索引，索引本身的体积可能就高达6G。这对在线地图服务依然是难以接受的。pmtiles对此的解决方案是再添加一个中间层（类似索引的索引），第一个索引只负责缩放级别0-7，如果我们要查找的图块缩放级别大于7，则找到位置对应的缩放级别7的图块后，再检查文件是否有提供叶目录（leaf directory）存储更详细的缩放级别，如果有，重复上述查找过程即可。\nLeaf Directory，来自Protomaps博客 如何使用叶目录查找z:14 x:4204 y:6090：\n获取前512千字节，解析根索引。 检查根索引中的14_4204_6090。由于根目录只包含 0-7 级，相关的位置不存在于根索引里。 检查根索引中是否存在父图块的叶目录条目。z:14 x:4204 y:6090的父图块是z:7 x:32 y:47。 获取叶索引的字节并将其解析到索引中。 使用字节偏移量和图块数据长度来索引14_4204_6090。 只要客户端缓存最近使用的索引表，并且缩放/平移保持在z:7 x:32 y:47这个大图块内，则客户端无需多次提取索引。\n迁移mbtiles到pmtiles 数据源 相比mbtiles下载需要收费（免费层级只能下载2020年的数据），Protomaps在 https://maps.protomaps.com/builds/ 提供了每日更新的地图数据，直接点击下载即可。如果不需要整个星球的数据，也可以在用pmtiles CLI，根据geojson来提取部分数据下载。\n后端 将下载下来的pmtiles放在任何支持HTTP Range的web server或者对象存储上即可，除了CORS之外无需做任何特别配置。对于比较小的地图，放在github.io等静态网页存储服务上都是可行的。\n前端 js protomaps也提供了针对maplibre-gl-js的集成，只需要再引入一个pmtiles.js，并在js里注册这个protocal即可：\nlet protocol = new pmtiles.Protocol({metadata: true}); maplibregl.addProtocol(\"pmtiles\", protocol.tile); style json 可以在 https://maps.protomaps.com/ 上点击Get Style Json生成，生成后记得修改source里的url（改为类似pmtiles://https://url.com/example.pmtiles的格式）：\n\"sources\": { \"protomaps\": { \"type\": \"vector\", \"attribution\": \"Protomaps © OpenStreetMap\", \"url\": \"pmtiles://https://url.com/example.pmtiles\" } }, 示例网页：\n\u003chtml\u003e \u003chead\u003e \u003ctitle\u003ePMTiles MapLibre Example\u003c/title\u003e \u003cmeta charset=\"utf-8\"/\u003e \u003clink rel=\"stylesheet\" href=\"https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.css\" crossorigin=\"anonymous\"\u003e \u003cscript src=\"https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.js\" crossorigin=\"anonymous\"\u003e\u003c/script\u003e \u003cscript src=\"https://unpkg.com/pmtiles@4.2.1/dist/pmtiles.js\"\u003e\u003c/script\u003e \u003cstyle\u003e body { margin: 0; } #map { height:100%; width:100%; } \u003c/style\u003e \u003c/head\u003e \u003cbody\u003e \u003cdiv id=\"map\"\u003e\u003c/div\u003e \u003cscript type=\"text/javascript\"\u003e // add the PMTiles plugin to the maplibregl global. // setting metadata = true fills out the \"attribution\" field of the source, and is required for some inspector applications, // but requires an additional blocking HTTP request before loading the map. let protocol = new pmtiles.Protocol({metadata: true}); maplibregl.addProtocol(\"pmtiles\", protocol.tile); const map = new maplibregl.Map({ container: \"map\", zoom: 13, center: [11.2543435, 43.7672134], style: \"pmtiles-light.json\", }); map.showTileBoundaries = true; \u003c/script\u003e \u003c/body\u003e \u003c/html\u003e 如果需要在本地host style里的sprite，字体等文件，可以在 https://github.com/protomaps/basemaps-assets/ 里下载。 经过笔者测试，在修改完数据源和style json之后，Protomaps的配置可以和maplibre-gl-js无缝兼容，无需进去其他的代码修改。\n显示效果 在地图上叠加了geojson和数个marker（车辆） 底图多语言显示（可以在style json里配置） 参考文档 https://protomaps.com/blog/dynamic-maps-static-storage/ https://data.maptiler.com/downloads/tileset/osm/ https://docs.protomaps.com/basemaps/maplibre https://www.maplibre.org/maplibre-gl-js/docs/examples/pmtiles/ ","wordCount":"2114","inLanguage":"zh","image":"https://assets.sparktour.me/img/blog/2025/self-host-protomaps-tiles-server/protomaps-1.jpg","datePublished":"2025-01-15T18:00:00Z","dateModified":"2025-01-16T12:34:42+08:00","author":{"@type":"Person","name":"sparktour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sparktour.me/posts/2025/01/15/self-host-protomaps-tiles-server/"},"publisher":{"@type":"Organization","name":"Sparktour's Blog","logo":{"@type":"ImageObject","url":"https://blog.sparktour.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.sparktour.me/ accesskey=h title="Sparktour's Blog (Alt + H)">Sparktour's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.sparktour.me/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.sparktour.me/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.sparktour.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.sparktour.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.sparktour.me/about/ title=About><span>About</span></a></li><li><a href=https://blog.sparktour.me/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.sparktour.me/>主页</a>&nbsp;»&nbsp;<a href=https://blog.sparktour.me/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">自建OpenStreetmap地图瓦片服务：迁移mbtiles到pmtiles</h1><div class=post-description>笔者注意到了一些GIS开源项目在使用的Protomaps项目，以及他们提出的pmtiles格式。如Protomaps的发起人给博客起的标题《Dynamic Maps, Static Storage》那样，pmtiles的一大优势是如果不需要raster tiles，服务端不再需要安装任何软件，只需要一个“Static Storage”即可，无需任何后端软件对地图数据进行处理。</div><div class=post-meta><span title='2025-01-15 18:00:00 +0000 UTC'>2025-01-15</span>&nbsp;·&nbsp;<span title='2025-01-16 12:34:42 +0800 +0800'>更新于: 2025-01-16</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;sparktour</div></header><figure class=entry-cover><img loading=eager src=https://assets.sparktour.me/img/blog/2025/self-host-protomaps-tiles-server/protomaps-1.jpg alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#pmtiles%e6%a0%bc%e5%bc%8f%e7%9a%84%e8%ae%be%e8%ae%a1%e7%90%86%e5%bf%b5 aria-label=pmtiles格式的设计理念>pmtiles格式的设计理念</a></li><li><a href=#%e8%bf%81%e7%a7%bbmbtiles%e5%88%b0pmtiles aria-label=迁移mbtiles到pmtiles>迁移mbtiles到pmtiles</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=数据源>数据源</a></li><li><a href=#%e5%90%8e%e7%ab%af aria-label=后端>后端</a></li><li><a href=#%e5%89%8d%e7%ab%af aria-label=前端>前端</a><ul><li><a href=#js aria-label=js>js</a></li><li><a href=#style-json aria-label="style json">style json</a></li></ul></li></ul></li><li><a href=#%e6%98%be%e7%a4%ba%e6%95%88%e6%9e%9c aria-label=显示效果>显示效果</a></li><li><a href=#%e5%8f%82%e8%80%83%e6%96%87%e6%a1%a3 aria-label=参考文档>参考文档</a></li></ul></div></details></div><div class=post-content><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>笔者曾在三年前写过一篇如何self host基于OpenStreetmap数据的<a href=https://blog.sparktour.me/posts/2021/08/03/self-host-openstreetmap-tiles-server/>博客</a>。在当时的文章里，笔者使用的后端是maptiler开发的的<a href=https://github.com/maptiler/tileserver-gl>tileserver-gl</a>。它需要一个转换好的mbtiles文件，才能正常serve地图。但遗憾的是，maptiler把下载转换好的地图作为一项商业服务提供，我们只能自己使用maptiler提供的<a href=https://github.com/openmaptiles/openmaptiles>openmaptiles</a>对地图进行转换。由于mbtiles的本质是基于sqlite的地图数据库，使用openmaptiles制作地图的速度相当缓慢（在一台48C256G的机器上转换全世界的地图大概需要一整天的时间，并且对磁盘的IO有较高的要求），host地图也需要使用tileserver-gl处理请求，将mbtiles里的数据转换成pbf格式发送给客户端。</p><p>直到最近，笔者注意到了一些GIS开源项目在使用的<a href=https://docs.protomaps.com/>Protomaps</a>项目，以及他们提出的pmtiles格式。如Protomaps的发起人给博客起的标题《<a href=https://protomaps.com/blog/dynamic-maps-static-storage/>Dynamic Maps, Static Storage</a>》那样，pmtiles的一大优势是如果不需要raster tiles，服务端不再需要安装任何软件，只需要一个“Static Storage”即可（无需任何后端软件对地图数据进行处理）。确切的说，一个支持<a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests>HTTP Range</a>的服务器。包括nginx，caddy等常见的web服务器和S3服务理论上都是支持这项特性的。</p><h2 id=pmtiles格式的设计理念>pmtiles格式的设计理念<a hidden class=anchor aria-hidden=true href=#pmtiles格式的设计理念>#</a></h2><p>Pmtiles的格式设计巧妙的利用了HTTP Range的特性。如下图所示，它将图块数据的索引放在了文件的头部，因此客户端只要先对文件的头部进行查询，得到图块索引后，根据Z、X、Y找到对应的数据range，最后再使用HTTP Range请求对应的数据块即可。</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2025/self-host-protomaps-tiles-server/pmtiles_explainer_1.png alt=pmtiles格式的设计理念，来自Protomaps博客><figcaption>pmtiles格式的设计理念，来自Protomaps博客</figcaption></figure></p><blockquote><p>获取一个图块的过程如下（假设我们要获取<code>z:8 x:65 y:95</code>）：</p><ol><li>获取前 512 千字节并将目录解析为索引</li><li>在这种情况下，通过您想要的图块的键查找<code>8_65_95</code></li><li>匹配成功！您将获得一个Range<code>offset: 785366 length: 21400</code></li><li>使用HTTP Range获取这些字节<code>Range:bytes=785366-806765</code>并将数据解析为图像</li></ol></blockquote><p>但值得注意的是，当整个文件足够大的时候，图块索引本身也可能占用大量的体积（如博客文章所说，如果我们要存储1-15这15个缩放登记的索引，索引本身的体积可能就高达6G。这对在线地图服务依然是难以接受的。pmtiles对此的解决方案是再添加一个中间层（类似索引的索引），第一个索引只负责缩放级别0-7，如果我们要查找的图块缩放级别大于7，则找到位置对应的缩放级别7的图块后，再检查文件是否有提供叶目录（leaf directory）存储更详细的缩放级别，如果有，重复上述查找过程即可。</p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2025/self-host-protomaps-tiles-server/pmtiles_explainer_3.png alt="Leaf Directory，来自Protomaps博客"><figcaption>Leaf Directory，来自Protomaps博客</figcaption></figure></p><blockquote><p>如何使用叶目录查找<code>z:14 x:4204 y:6090</code>：</p><ol><li>获取前512千字节，解析根索引。</li><li>检查根索引中的<code>14_4204_6090</code>。由于根目录只包含 0-7 级，相关的位置不存在于根索引里。</li><li>检查根索引中是否存在父图块的<em>叶目录条目</em>。<code>z:14 x:4204 y:6090</code>的父图块是<code>z:7 x:32 y:47</code>。</li><li>获取叶索引的字节并将其解析到索引中。</li><li>使用字节偏移量和图块数据长度来索引<code>14_4204_6090</code>。</li></ol><p>只要客户端缓存最近使用的索引表，并且缩放/平移保持在<code>z:7 x:32 y:47</code>这个大图块内，则客户端无需多次提取索引。</p></blockquote><h2 id=迁移mbtiles到pmtiles>迁移mbtiles到pmtiles<a hidden class=anchor aria-hidden=true href=#迁移mbtiles到pmtiles>#</a></h2><h3 id=数据源>数据源<a hidden class=anchor aria-hidden=true href=#数据源>#</a></h3><p>相比<a href=https://data.maptiler.com/downloads/tileset/osm/>mbtiles</a>下载需要收费（免费层级只能下载2020年的数据），Protomaps在 <a href=https://maps.protomaps.com/builds/>https://maps.protomaps.com/builds/</a> 提供了每日更新的地图数据，直接点击下载即可。如果不需要整个星球的数据，也可以在用<a href=https://docs.protomaps.com/pmtiles/cli#extract>pmtiles CLI</a>，根据geojson来提取部分数据下载。</p><h3 id=后端>后端<a hidden class=anchor aria-hidden=true href=#后端>#</a></h3><p>将下载下来的pmtiles放在任何支持HTTP Range的web server或者对象存储上即可，除了CORS之外无需做任何特别配置。对于比较小的地图，放在github.io等静态网页存储服务上都是可行的。</p><h3 id=前端>前端<a hidden class=anchor aria-hidden=true href=#前端>#</a></h3><h4 id=js>js<a hidden class=anchor aria-hidden=true href=#js>#</a></h4><p>protomaps也提供了针对maplibre-gl-js的<a href=https://maplibre.org/maplibre-gl-js/docs/examples/pmtiles/>集成</a>，只需要再引入一个<a href=https://www.npmjs.com/package/pmtiles>pmtiles.js</a>，并在js里注册这个protocal即可：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>protocol</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>pmtiles</span><span class=p>.</span><span class=nx>Protocol</span><span class=p>({</span><span class=nx>metadata</span><span class=o>:</span> <span class=kc>true</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>maplibregl</span><span class=p>.</span><span class=nx>addProtocol</span><span class=p>(</span><span class=s2>&#34;pmtiles&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>.</span><span class=nx>tile</span><span class=p>);</span>
</span></span></code></pre></div><h4 id=style-json>style json<a hidden class=anchor aria-hidden=true href=#style-json>#</a></h4><p>可以在 <a href=https://maps.protomaps.com/>https://maps.protomaps.com/</a> 上点击Get Style Json生成，生成后记得修改source里的url（改为类似<code>pmtiles://https://url.com/example.pmtiles</code>的格式）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>    <span class=s2>&#34;sources&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;protomaps&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;vector&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;attribution&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;a href=\&#34;https://github.com/protomaps/basemaps\&#34;&gt;Protomaps&lt;/a&gt; © &lt;a href=\&#34;https://openstreetmap.org\&#34;&gt;OpenStreetMap&lt;/a&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;pmtiles://https://url.com/example.pmtiles&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=err>,</span>
</span></span></code></pre></div><p>示例网页：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>PMTiles MapLibre Example<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;stylesheet&#34;</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.css&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://unpkg.com/pmtiles@4.2.1/dist/pmtiles.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>body</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>#</span><span class=nn>map</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>height</span><span class=p>:</span><span class=mi>100</span><span class=kt>%</span><span class=p>;</span> <span class=k>width</span><span class=p>:</span><span class=mi>100</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;map&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/javascript&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// add the PMTiles plugin to the maplibregl global.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// setting metadata = true fills out the &#34;attribution&#34; field of the source, and is required for some inspector applications,
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// but requires an additional blocking HTTP request before loading the map.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>let</span> <span class=nx>protocol</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>pmtiles</span><span class=p>.</span><span class=nx>Protocol</span><span class=p>({</span><span class=nx>metadata</span><span class=o>:</span> <span class=kc>true</span><span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=nx>maplibregl</span><span class=p>.</span><span class=nx>addProtocol</span><span class=p>(</span><span class=s2>&#34;pmtiles&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>.</span><span class=nx>tile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>map</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>maplibregl</span><span class=p>.</span><span class=nx>Map</span><span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=nx>container</span><span class=o>:</span> <span class=s2>&#34;map&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>zoom</span><span class=o>:</span> <span class=mi>13</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>center</span><span class=o>:</span> <span class=p>[</span><span class=mf>11.2543435</span><span class=p>,</span> <span class=mf>43.7672134</span><span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=nx>style</span><span class=o>:</span> <span class=s2>&#34;pmtiles-light.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=nx>map</span><span class=p>.</span><span class=nx>showTileBoundaries</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><div class="callout callout-info">如果需要在本地host style里的sprite，字体等文件，可以在 <a href=https://github.com/protomaps/basemaps-assets/>https://github.com/protomaps/basemaps-assets/</a> 里下载。</div><p>经过笔者测试，在修改完数据源和style json之后，Protomaps的配置可以和maplibre-gl-js无缝兼容，无需进去其他的代码修改。</p><h2 id=显示效果>显示效果<a hidden class=anchor aria-hidden=true href=#显示效果>#</a></h2><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2025/self-host-protomaps-tiles-server/protomaps-1.jpg alt=在地图上叠加了geojson和数个marker（车辆）><figcaption>在地图上叠加了geojson和数个marker（车辆）</figcaption></figure></p><p><figure><img loading=lazy src=https://assets.sparktour.me/img/blog/2025/self-host-protomaps-tiles-server/protomaps-2.jpg alt="底图多语言显示（可以在style json里配置）"><figcaption>底图多语言显示（可以在style json里配置）</figcaption></figure></p><h2 id=参考文档>参考文档<a hidden class=anchor aria-hidden=true href=#参考文档>#</a></h2><ul><li><a href=https://protomaps.com/blog/dynamic-maps-static-storage/>https://protomaps.com/blog/dynamic-maps-static-storage/</a></li><li><a href=https://data.maptiler.com/downloads/tileset/osm/>https://data.maptiler.com/downloads/tileset/osm/</a></li><li><a href=https://docs.protomaps.com/basemaps/maplibre>https://docs.protomaps.com/basemaps/maplibre</a></li><li><a href=https://www.maplibre.org/maplibre-gl-js/docs/examples/pmtiles/>https://www.maplibre.org/maplibre-gl-js/docs/examples/pmtiles/</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.sparktour.me/tags/openstreetsmap/>Openstreetsmap</a></li><li><a href=https://blog.sparktour.me/tags/protomaps/>Protomaps</a></li><li><a href=https://blog.sparktour.me/tags/tile/>Tile</a></li></ul><nav class=paginav><a class=prev href=https://blog.sparktour.me/posts/2025/01/25/port-ont-bonito-koi-to-jetson-arm64/><span class=title>« 上一页</span><br><span>在 Nvidia Jetson 上运行 Bonito Basecaller</span>
</a><a class=next href=https://blog.sparktour.me/posts/2024/12/31/2024-in-photos/><span class=title>下一页 »</span><br><span>照片里的2024</span></a></nav></footer><div class="callout callout-default"><img src=https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg alt="CC BY-NC-SA 4.0" style=width:88px;height:31px><p style=font-size:12px>Licensed Under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></p><p style=font-size:12px>Post Link: <a href=https://blog.sparktour.me/posts/2025/01/15/self-host-protomaps-tiles-server/ target=_blank rel=noopener>https://blog.sparktour.me/posts/2025/01/15/self-host-protomaps-tiles-server/</a></p></div><script src=https://s4.zstatic.net/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js crossorigin=anonymous></script><div id=disqusjs></div><script>const disqusjs=new DisqusJS({shortname:"sparktour",siteName:"",identifier:"",url:"",title:"",api:"https://disqus.com/api/",apikey:"QhJnXpS5igyHkjYQ91XYC4dSAuEJYAEsHX8hjLrRc1HU9AApOHLrqkwwIp2sKOLk",admin:"",adminLabel:""});disqusjs.render(document.getElementById("disqusjs"))</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.sparktour.me/>Sparktour's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>